cscope 15 /home/flyhigh2sky/cqf -q 0000000785 0000136558
	@include/gqf.h

10 #iâdeà
_GQF_H_


11 
	#_GQF_H_


	)

13 
	~<š‰y³s.h
>

14 
	~<¡dboŞ.h
>

16 #ifdeà
__ılu¥lus


20 
quÙ›Á_f‹r
 
	tquÙ›Á_f‹r
;

21 
quÙ›Á_f‹r
 
	tQF
;

43 
	eqf_hashmode
 {

44 
QF_HASH_DEFAULT
,

45 
QF_HASH_INVERTIBLE
,

46 
QF_HASH_NONE


64 
	#QF_NO_LOCK
 (0x01)

	)

65 
	#QF_TRY_ONCE_LOCK
 (0x02)

	)

66 
	#QF_WAIT_FOR_LOCK
 (0x04)

	)

70 
	#QF_KEY_IS_HASH
 (0x08)

	)

83 
ušt64_t
 
qf_š™
(
QF
 *
qf
, ušt64_ˆ
n¦Ùs
, ušt64_ˆ
key_b™s
, uint64_t

84 
v®ue_b™s
, 
qf_hashmode
 
hash
, 
ušt32_t
 
£ed
, *

85 
bufãr
, 
ušt64_t
 
bufãr_Ën
);

91 
ušt64_t
 
qf_u£
(
QF
* 
qf
, * 
bufãr
, ušt64_ˆ
bufãr_Ën
);

96 *
qf_de¡roy
(
QF
 *
qf
);

103 
ušt64_t
 
qf_»size
(
QF
* 
qf
, ušt64_ˆ
n¦Ùs
, * 
bufãr
, uint64_t

104 
bufãr_Ën
);

112 
boŞ
 
qf_m®loc
(
QF
 *
qf
, 
ušt64_t
 
n¦Ùs
, ušt64_ˆ
key_b™s
, uint64_t

113 
v®ue_b™s
, 
qf_hashmode
 
hash
, 
ušt32_t
 
£ed
);

115 
boŞ
 
qf_ä“
(
QF
 *
qf
);

122 
št64_t
 
qf_»size_m®loc
(
QF
 *
qf
, 
ušt64_t
 
n¦Ùs
);

127 
qf_£t_auto_»size
(
QF
* 
qf
, 
boŞ
 
’abËd
);

133 
	#QF_NO_SPACE
 (-1)

	)

134 
	#QF_COULDNT_LOCK
 (-2)

	)

135 
	#QF_DOESNT_EXIST
 (-3)

	)

144 
qf_š£¹
(
QF
 *
qf
, 
ušt64_t
 
key
, ušt64_ˆ
v®ue
, ušt64_ˆ
couÁ
, 
ušt8_t


145 
æags
);

151 
qf_£t_couÁ
(
QF
 *
qf
, 
ušt64_t
 
key
, ušt64_ˆ
v®ue
, ušt64_ˆ
couÁ
,

152 
ušt8_t
 
æags
);

162 
qf_»move
(
QF
 *
qf
, 
ušt64_t
 
key
, ušt64_ˆ
v®ue
, ušt64_ˆ
couÁ
, 
ušt8_t


163 
æags
);

166 
qf_d–‘e_key_v®ue
(
QF
 *
qf
, 
ušt64_t
 
key
, ušt64_ˆ
v®ue
, 
ušt8_t
 
æags
);

189 
ušt64_t
 
qf_qu”y
(cÚ¡ 
QF
 *
qf
, ušt64_ˆ
key
, ušt64_ˆ*
v®ue
, 
ušt8_t


190 
æags
);

200 
ušt64_t
 
qf_couÁ_key_v®ue
(cÚ¡ 
QF
 *
qf
, ušt64_ˆ
key
, ušt64_ˆ
v®ue
,

201 
ušt8_t
 
æags
);

210 
št64_t
 
qf_g‘_unique_šdex
(cÚ¡ 
QF
 *
qf
, 
ušt64_t
 
key
, ušt64_ˆ
v®ue
,

211 
ušt8_t
 
æags
);

219 
qf_hashmode
 
qf_g‘_hashmode
(cÚ¡ 
QF
 *
qf
);

220 
ušt64_t
 
qf_g‘_hash_£ed
(cÚ¡ 
QF
 *
qf
);

221 
__ušt128_t
 
qf_g‘_hash_¿nge
(cÚ¡ 
QF
 *
qf
);

224 
boŞ
 
qf_is_auto_»size_’abËd
(cÚ¡ 
QF
 *
qf
);

225 
ušt64_t
 
qf_g‘_tÙ®_size_š_by‹s
(cÚ¡ 
QF
 *
qf
);

226 
ušt64_t
 
qf_g‘_n¦Ùs
(cÚ¡ 
QF
 *
qf
);

227 
ušt64_t
 
qf_g‘_num_occup›d_¦Ùs
(cÚ¡ 
QF
 *
qf
);

230 
ušt64_t
 
qf_g‘_num_key_b™s
(cÚ¡ 
QF
 *
qf
);

231 
ušt64_t
 
qf_g‘_num_v®ue_b™s
(cÚ¡ 
QF
 *
qf
);

232 
ušt64_t
 
qf_g‘_num_key_»mašd”_b™s
(cÚ¡ 
QF
 *
qf
);

233 
ušt64_t
 
qf_g‘_b™s_³r_¦Ù
(cÚ¡ 
QF
 *
qf
);

236 
ušt64_t
 
qf_g‘_sum_of_couÁs
(cÚ¡ 
QF
 *
qf
);

237 
ušt64_t
 
qf_g‘_num_di¡šù_key_v®ue_·œs
(cÚ¡ 
QF
 *
qf
);

239 
qf_sync_couÁ”s
(cÚ¡ 
QF
 *
qf
);

245 
quÙ›Á_f‹r_™”©Ü
 
	tquÙ›Á_f‹r_™”©Ü
;

246 
quÙ›Á_f‹r_™”©Ü
 
	tQFi
;

248 
	#QF_INVALID
 (-4)

	)

249 
	#QFI_INVALID
 (-5)

	)

256 
št64_t
 
qf_™”©Ü_äom_pos™iÚ
(cÚ¡ 
QF
 *
qf
, 
QFi
 *
qfi
, 
ušt64_t
 
pos™iÚ
);

265 
št64_t
 
qf_™”©Ü_äom_key_v®ue
(cÚ¡ 
QF
 *
qf
, 
QFi
 *
qfi
, 
ušt64_t
 
key
,

266 
ušt64_t
 
v®ue
, 
ušt8_t
 
æags
);

275 
qfi_g‘_key
(cÚ¡ 
QFi
 *
qfi
, 
ušt64_t
 *
key
, ušt64_ˆ*
v®ue
, uint64_t

276 *
couÁ
);

282 
qfi_g‘_hash
(cÚ¡ 
QFi
 *
qfi
, 
ušt64_t
 *
hash
, ušt64_ˆ*
v®ue
, uint64_t

283 *
couÁ
);

290 
qfi_Ãxt
(
QFi
 *
qfi
);

293 
boŞ
 
qfi_’d
(cÚ¡ 
QFi
 *
qfi
);

300 
qf_»£t
(
QF
 *
qf
);

305 
qf_cİy
(
QF
 *
de¡
, cÚ¡ QF *
¤c
);

309 
qf_m”ge
(cÚ¡ 
QF
 *
qç
, cÚ¡ QF *
qfb
, QF *
qfc
);

312 
qf_muÉi_m”ge
(cÚ¡ 
QF
 *
qf_¬r
[], 
nqf
, QF *
qä
);

315 
ušt64_t
 
qf_šÃr_´oduù
(cÚ¡ 
QF
 *
qç
, cÚ¡ QF *
qfb
);

319 
ušt64_t
 
qf_magn™ude
(cÚ¡ 
QF
 *
qf
);

325 
qf_dump
(cÚ¡ 
QF
 *);

326 
qf_dump_m‘ad©a
(cÚ¡ 
QF
 *
qf
);

329 #ifdeà
__ılu¥lus


	@include/gqf_file.h

10 #iâdeà
_GQF_FILE_H_


11 
	#_GQF_FILE_H_


	)

13 
	~<š‰y³s.h
>

14 
	~<±h»ad.h
>

15 
	~<¡dboŞ.h
>

17 
	~"gqf.h
"

19 #ifdeà
__ılu¥lus


24 
boŞ
 
qf_š™fe
(
QF
 *
qf
, 
ušt64_t
 
n¦Ùs
, ušt64_ˆ
key_b™s
, uint64_t

25 
v®ue_b™s
, 
qf_hashmode
 
hash
, 
ušt32_t
 
£ed
, const *

26 
f’ame
);

28 
	#QF_USEFILE_READ_ONLY
 (0x01)

	)

29 
	#QF_USEFILE_READ_WRITE
 (0x02)

	)

32 
ušt64_t
 
qf_u£fe
(
QF
* 
qf
, cÚ¡ * 
f’ame
, 
æag
);

39 
št64_t
 
qf_»size_fe
(
QF
 *
qf
, 
ušt64_t
 
n¦Ùs
);

41 
boŞ
 
qf_şo£fe
(
QF
* 
qf
);

43 
boŞ
 
qf_d–‘efe
(
QF
* 
qf
);

46 
ušt64_t
 
qf_£rŸlize
(cÚ¡ 
QF
 *
qf
, cÚ¡ *
f’ame
);

49 
ušt64_t
 
qf_de£rŸlize
(
QF
 *
qf
, cÚ¡ *
f’ame
);

54 
qfi_Ãxt_madvi£
(
QFi
 *
qfi
);

59 
qfi_š™Ÿl_madvi£
(
QFi
 *
qfi
);

61 #ifdeà
__ılu¥lus


	@include/gqf_int.h

10 #iâdeà
_GQF_INT_H_


11 
	#_GQF_INT_H_


	)

13 
	~<š‰y³s.h
>

14 
	~<¡dboŞ.h
>

16 
	~"gqf.h
"

17 
	~"·¹™iÚed_couÁ”.h
"

19 #ifdeà
__ılu¥lus


23 
	#MAGIC_NUMBER
 1018874902021329732

	)

30 
	#QF_BITS_PER_SLOT
 0

	)

33 
	#QF_BLOCK_OFFSET_BITS
 (6)

	)

35 
	#QF_SLOTS_PER_BLOCK
 (1ULL << 
QF_BLOCK_OFFSET_BITS
)

	)

36 
	#QF_METADATA_WORDS_PER_BLOCK
 ((
QF_SLOTS_PER_BLOCK
 + 63è/ 64)

	)

38 
__©Œibu‹__
 ((
	t__·cked__
)è
	tqfblock
 {

41 
ušt8_t
 
off£t
;

42 
ušt64_t
 
occup›ds
[
QF_METADATA_WORDS_PER_BLOCK
];

43 
ušt64_t
 
ruÃnds
[
QF_METADATA_WORDS_PER_BLOCK
];

45 #ià
QF_BITS_PER_SLOT
 == 8

46 
ušt8_t
 
¦Ùs
[
QF_SLOTS_PER_BLOCK
];

47 #–ià
QF_BITS_PER_SLOT
 == 16

48 
ušt16_t
 
¦Ùs
[
QF_SLOTS_PER_BLOCK
];

49 #–ià
QF_BITS_PER_SLOT
 == 32

50 
ušt32_t
 
¦Ùs
[
QF_SLOTS_PER_BLOCK
];

51 #–ià
QF_BITS_PER_SLOT
 == 64

52 
ušt64_t
 
¦Ùs
[
QF_SLOTS_PER_BLOCK
];

53 #–ià
QF_BITS_PER_SLOT
 != 0

54 
ušt8_t
 
¦Ùs
[
QF_SLOTS_PER_BLOCK
 * 
QF_BITS_PER_SLOT
 / 8];

56 
ušt8_t
 
¦Ùs
[];

58 } 
	tqfblock
;

60 
__©Œibu‹__
 ((
__·cked__
)è
qfblock
;

61 
qfblock
 
	tqfblock
;

63 
	sfe_šfo
 {

64 
fd
;

65 *
f•©h
;

66 } 
	tfe_šfo
;

71 
ušt64_t
 
tÙ®_time_sšgË
;

72 
ušt64_t
 
tÙ®_time_¥šnšg
;

73 
ušt64_t
 
locks_k’
;

74 
ušt64_t
 
locks_acquœed_sšgË_©‹m±
;

75 } 
	twa™_time_d©a
;

77 
	squÙ›Á_f‹r_ruÁime_d©a
 {

78 
fe_šfo
 
f_šfo
;

79 
ušt32_t
 
auto_»size
;

80 
št64_t
 (*
cÚš”_»size
)(
QF
 *
qf
, 
ušt64_t
 
n¦Ùs
);

81 
pc_t
 
pc_ÃÉs
;

82 
pc_t
 
pc_ndi¡šù_–ts
;

83 
pc_t
 
pc_noccup›d_¦Ùs
;

84 
ušt64_t
 
num_locks
;

85 vŞ©
m‘ad©a_lock
;

86 vŞ©*
locks
;

87 
wa™_time_d©a
 *
wa™_times
;

88 } 
	tquÙ›Á_f‹r_ruÁime_d©a
;

90 
quÙ›Á_f‹r_ruÁime_d©a
 
	tqäuÁime
;

92 
	squÙ›Á_f‹r_m‘ad©a
 {

93 
ušt64_t
 
magic_’dŸn_numb”
;

94 
qf_hashmode
 
hash_mode
;

95 
ušt32_t
 
»£rved
;

96 
ušt64_t
 
tÙ®_size_š_by‹s
;

97 
ušt32_t
 
£ed
;

98 
ušt64_t
 
n¦Ùs
;

99 
ušt64_t
 
xn¦Ùs
;

100 
ušt64_t
 
key_b™s
;

101 
ušt64_t
 
v®ue_b™s
;

102 
ušt64_t
 
key_»mašd”_b™s
;

103 
ušt64_t
 
b™s_³r_¦Ù
;

104 
__ušt128_t
 
¿nge
;

105 
ušt64_t
 
nblocks
;

106 
ušt64_t
 
ÃÉs
;

107 
ušt64_t
 
ndi¡šù_–ts
;

108 
ušt64_t
 
noccup›d_¦Ùs
;

109 } 
	tquÙ›Á_f‹r_m‘ad©a
;

111 
quÙ›Á_f‹r_m‘ad©a
 
	tqfm‘ad©a
;

113 
	squÙ›Á_f‹r
 {

114 
qäuÁime
 *
ruÁimed©a
;

115 
qfm‘ad©a
 *
m‘ad©a
;

116 
qfblock
 *
blocks
;

117 } 
	tquÙ›Á_f‹r
;

119 
quÙ›Á_f‹r
 
	tQF
;

121 #ià
QF_BITS_PER_SLOT
 > 0

122 
šlše
 
qfblock
 * 
g‘_block
(cÚ¡ 
QF
 *
qf
, 
ušt64_t
 
block_šdex
)

124  &
qf
->
blocks
[
block_šdex
];

127 
šlše
 
qfblock
 * 
g‘_block
(cÚ¡ 
QF
 *
qf
, 
ušt64_t
 
block_šdex
)

129  (
qfblock
 *)(((*)
qf
->
blocks
)

130 + 
block_šdex
 * ((
qfblock
è+ 
QF_SLOTS_PER_BLOCK
 *

131 
qf
->
m‘ad©a
->
b™s_³r_¦Ù
 / 8));

138 
ušt64_t
 
¡¬t_šdex
;

139 
ušt16_t
 
Ëngth
;

140 } 
	tşu¡”_d©a
;

142 
	squÙ›Á_f‹r_™”©Ü
 {

143 cÚ¡ 
QF
 *
qf
;

144 
ušt64_t
 
run
;

145 
ušt64_t
 
cu¼’t
;

146 
ušt64_t
 
cur_¡¬t_šdex
;

147 
ušt16_t
 
cur_Ëngth
;

148 
ušt32_t
 
num_şu¡”s
;

149 
şu¡”_d©a
 *
c_šfo
;

150 } 
	tquÙ›Á_f‹r_™”©Ü
;

152 #ifdeà
__ılu¥lus


	@include/gqf_wrapper.h

10 #iâdeà
GQF_WRAPPER_H


11 
	#GQF_WRAPPER_H


	)

13 
	~"gqf.h
"

14 
	~"gqf_št.h
"

15 
	~"gqf_fe.h
"

17 
QF
 
	gg_quÙ›Á_f‹r
;

18 
QFi
 
	gg_quÙ›Á_f‹r_™r
;

20 
šlše
 
	$gqf_š™
(
ušt64_t
 
nb™s
, ušt64_ˆ
num_hash_b™s
)

22 
ušt64_t
 
n¦Ùs
 = 1 << 
nb™s
;

23 
	`qf_m®loc
(&
g_quÙ›Á_f‹r
, 
n¦Ùs
, 
num_hash_b™s
, 0, 
QF_HASH_NONE
, 0);

25 
	}
}

27 
šlše
 
	$gqf_š£¹
(
__ušt128_t
 
v®
, 
ušt64_t
 
couÁ
)

29 
	`qf_š£¹
(&
g_quÙ›Á_f‹r
, 
v®
, 0, 
couÁ
, 
QF_NO_LOCK
);

31 
	}
}

33 
šlše
 
	$gqf_lookup
(
__ušt128_t
 
v®
)

35  
	`qf_couÁ_key_v®ue
(&
g_quÙ›Á_f‹r
, 
v®
, 0, 0);

36 
	}
}

38 
šlše
 
__ušt128_t
 
	$gqf_¿nge
()

40  
g_quÙ›Á_f‹r
.
m‘ad©a
->
¿nge
;

41 
	}
}

43 
šlše
 
	$gqf_de¡roy
()

45 
	`qf_ä“
(&
g_quÙ›Á_f‹r
);

47 
	}
}

49 
šlše
 
	$gqf_™”©Ü
(
ušt64_t
 
pos
)

51 
	`qf_™”©Ü_äom_pos™iÚ
(&
g_quÙ›Á_f‹r
, &
g_quÙ›Á_f‹r_™r
, 
pos
);

53 
	}
}

57 
šlše
 
	$gqf_g‘
(
ušt64_t
 *
key
, ušt64_ˆ*
v®ue
, ušt64_ˆ*
couÁ
)

59  
	`qfi_g‘_hash
(&
g_quÙ›Á_f‹r_™r
, 
key
, 
v®ue
, 
couÁ
);

60 
	}
}

64 
šlše
 
	$gqf_Ãxt
()

66  
	`qfi_Ãxt
(&
g_quÙ›Á_f‹r_™r
);

67 
	}
}

70 
šlše
 
	$gqf_’d
()

72  
	`qfi_’d
(&
g_quÙ›Á_f‹r_™r
);

73 
	}
}

	@include/hashutil.h

10 #iâdeà
_HASHUTIL_H_


11 
	#_HASHUTIL_H_


	)

13 
	~<sys/ty³s.h
>

14 
	~<¡dlib.h
>

15 
	~<¡dšt.h
>

17 
ušt64_t
 
MurmurHash64B
 ( cÚ¡ * 
key
, 
Ën
, 
£ed
 );

18 
ušt64_t
 
MurmurHash64A
 ( cÚ¡ * 
key
, 
Ën
, 
£ed
 );

20 
ušt64_t
 
hash_64
(ušt64_ˆ
key
, ušt64_ˆ
mask
);

21 
ušt64_t
 
hash_64i
(ušt64_ˆ
key
, ušt64_ˆ
mask
);

	@include/partitioned_counter.h

10 #iâdeà
_PARTITIONED_COUNTER_H_


11 
	#_PARTITIONED_COUNTER_H_


	)

13 
	~<š‰y³s.h
>

14 
	~<¡dboŞ.h
>

16 #ifdeà
__ılu¥lus


20 
	sloÿl_couÁ”
 {

21 
št64_t
 
couÁ”
;

22 
št64_t
 
·ddšg
[7];

23 } 
	tloÿl_couÁ”
;

25 
loÿl_couÁ”
 
	tlùr_t
;

27 
	s·¹™iÚed_couÁ”
 {

28 
lùr_t
 *
loÿl_couÁ”s
;

29 
št64_t
 *
glob®_couÁ”
;

30 
ušt32_t
 
num_couÁ”s
;

31 
št32_t
 
th»shŞd
;

32 } 
	t·¹™iÚed_couÁ”
;

34 
·¹™iÚed_couÁ”
 
	tpc_t
;

36 
	#PC_ERROR
 -1

	)

41 
pc_š™
(
pc_t
 *
pc
, 
št64_t
 *
glob®_couÁ”
, 
ušt32_t
 
num_couÁ”s
,

42 
št32_t
 
th»shŞd
);

44 
pc_de¡ruùÜ
(
pc_t
 *
pc
);

46 
pc_add
(
pc_t
 *
pc
, 
št64_t
 
couÁ
);

48 
pc_sync
(
pc_t
 *
pc
);

50 #ifdeà
__ılu¥lus


	@include/zipf.h

1 #iâdeà
ZIPF_H


2 
	#ZIPF_H


	)

17 
	~<š‰y³s.h
>

19 #ifdeà
__ılu¥lus


23 
zfŸn
 cÚ¡ *
	tZIPFIAN
;

24 
ZIPFIAN
 
ü—‹_zfŸn
 (
s
, 
N
, (*
¿ndomfun
)());

27 
de¡roy_zfŸn
 (cÚ¡ 
ZIPFIAN
);

30 
zfŸn_g’
 (cÚ¡ 
ZIPFIAN
);

35 
zfŸn_hash
 (cÚ¡ 
ZIPFIAN
);

38 
g’”©e_¿ndom_keys
 (
ušt64_t
 *
–ems
, 
N
, 
g’couÁ
, 
s
);

40 #ifdeà
__ılu¥lus


	@src/bm.c

10 
	~<time.h
>

11 
	~<sys/time.h
>

12 
	~<sys/ty³s.h
>

13 
	~<İ’s¦/¿nd.h
>

14 
	~<uni¡d.h
>

15 
	~<m©h.h
>

16 
	~<¡ršg.h
>

17 
	~<as£¹.h
>

18 
	~<¡dio.h
>

19 
	~<¡dlib.h
>

21 
	~"šşude/zf.h
"

22 
	~"šşude/gqf_w¿µ”.h
"

24 #iâdeà 
USE_MYRANDOM


25 
	#RFUN
 
¿ndom


	)

26 
	#RSEED
 
¤ªdom


	)

28 
	#RFUN
 
my¿ndom


	)

29 
	#RSEED
 
my¤ªdom


	)

31 
	gm_z
 = 1;

32 
	gm_w
 = 1;

33 
	$my¤ªdom
 (
£ed
) {

34 
m_z
 = 
£ed
;

35 
m_w
 = (
£ed
<<16) + (seed >> 16);

36 
	}
}

38 
	$my¿ndom
()

40 
m_z
 = 36969 * (m_z & 65535) + (m_z >> 16);

41 
m_w
 = 18000 * (m_w & 65535) + (m_w >> 16);

42  ((
m_z
 << 16è+ 
m_w
) % 0x7FFFFFFF;

43 
	}
}

46 
	$tdiff
 (
timev®
 *
¡¬t
, timev® *
’d
) {

47  (
’d
->
tv_£c
-
¡¬t
->tv_£cè+1e-6*Ónd->
tv_u£c
 - start->tv_usec);

48 
	}
}

50 
ušt64_t
 
	$«s_hash2
(
ušt64_t
 
x
)

52 cÚ¡ 
ušt64_t
 
round_keys
[32] =

71 
__ušt128_t
 *
rks
 = (__ušt128_ˆ*)
round_keys
;

72 
ušt64_t
 
ouut
;

74 
	`asm
("movq %[input], %%xmm15;"

87 : [
ouut
] "=irm" (output)

88 : [
šput
] "œm" (
x
),

89 [
round_keys0
] "m" (
rks
[0]),

90 [
round_keys1
] "m" (
rks
[1]),

91 [
round_keys2
] "m" (
rks
[2]),

92 [
round_keys3
] "m" (
rks
[3]),

93 [
round_keys4
] "m" (
rks
[4]),

94 [
round_keys5
] "m" (
rks
[5]),

95 [
round_keys6
] "m" (
rks
[6]),

96 [
round_keys7
] "m" (
rks
[7]),

97 [
round_keys8
] "m" (
rks
[8]),

98 [
round_keys9
] "m" (
rks
[9]),

99 [
round_key§
] "m" (
rks
[10])

103  
ouut
;

104 
	}
}

106 
__ušt128_t
* 
	$zf_g’
(
N
, 
g’couÁ
, 
s
) {

107 
i
;

108 
ušt32_t
 *
couÁs
;

109 
__ušt128_t
 *
–ems
;

110 
timev®
 
a
,
b
,
c
;

111 
	`´štf
("Generating %ldƒlements in universe of %ld items with characteristicƒxponent %f\n",

112 
g’couÁ
, 
N
, 
s
);

113 
	`g‘timeofday
(&
a
, 
NULL
);

114 
ZIPFIAN
 
z
 = 
	`ü—‹_zfŸn
(1, 
N
, 
RFUN
);

115 
couÁs
 = (
ušt32_t
 *)
	`ÿÎoc
(
N
, (counts));

116 
–ems
 = (
__ušt128_t
 *)
	`ÿÎoc
(
g’couÁ
, (elems));

118 
	`g‘timeofday
(&
b
, 
NULL
);

119 
	`´štf
("S‘u°tim = %0.6fs\n", 
	`tdiff
(&
a
, &
b
));

120 
i
=0; i<
g’couÁ
; i++) {

121 
g
 = 
	`zfŸn_g’
(
z
);

122 
	`as£¹
(0<=
g
 && g<
N
);

123 
couÁs
[
g
]++;

124 
–ems
[
i
] = 
g
;

126 
	`g‘timeofday
(&
c
, 
NULL
);

127 
¹ime
 = 
	`tdiff
(&
b
, &
c
);

128 
	`´štf
("G’”©timğ%0.6f (%à³¸£cÚd)\n", 
¹ime
, 
g’couÁ
/rtime);

130 
i
=0; i<
N
; i++) {

131 
	`´štf
("%4.1à(%4.1f)\n", 
couÁs
[0]/()couÁs[
i
], i/(counts[0]/()counts[i]));

134 
	`´štf
("\n");

136 
	`de¡roy_zfŸn
(
z
);

137  
–ems
;

138 
	}
}

140 * (*
	t¿nd_š™
)(
	tušt64_t
 
	tmaxouuts
, 
	t__ušt128_t
 
	tmaxv®ue
, *
	t·¿ms
);

141 (*
	tg’_¿nd
)(*
	t¡©e
, 
	tušt64_t
 
	tnouuts
, 
	t__ušt128_t
 *
	touuts
);

142 * (*
	tdu¶iÿ‹_¿nd
)(*
	t¡©e
);

144 (*
	tš™_İ
)(
	tušt64_t
 
	tnv®s
, ušt64_ˆ
	thash
);

145 (*
	tš£¹_İ
)(
	t__ušt128_t
 
	tv®
, 
	tušt64_t
 
	tcouÁ
);

146 (*
	tlookup_İ
)(
	t__ušt128_t
 
	tv®
);

147 
	`__ušt128_t
 (*
	tg‘_¿nge_İ
)();

148 (*
	tde¡roy_İ
)();

149 (*
	t™”©Ü_İ
)(
	tušt64_t
 
	tpos
);

150 (*
	t™”©Ü_g‘_İ
)(
	tušt64_t
 *
	tkey
, ušt64_ˆ*
	tv®ue
, ušt64_ˆ*
	tcouÁ
);

151 (*
	t™”©Ü_Ãxt_İ
)();

152 (*
	t™”©Ü_’d_İ
)();

155 
	s¿nd_g’”©Ü
 {

156 
¿nd_š™
 
š™
;

157 
g’_¿nd
 
g’
;

158 
du¶iÿ‹_¿nd
 
dup
;

159 } 
	t¿nd_g’”©Ü
;

161 
	sf‹r
 {

162 
š™_İ
 
š™
;

163 
š£¹_İ
 
š£¹
;

164 
lookup_İ
 
lookup
;

165 
g‘_¿nge_İ
 
¿nge
;

166 
de¡roy_İ
 
de¡roy
;

167 
™”©Ü_İ
 
™”©Ü
;

168 
™”©Ü_g‘_İ
 
g‘
;

169 
™”©Ü_Ãxt_İ
 
Ãxt
;

170 
™”©Ü_’d_İ
 
’d
;

171 } 
	tf‹r
;

173 
	sunifÜm_´eg’_¡©e
 {

174 
ušt64_t
 
maxouuts
;

175 
ušt64_t
 
Ãxtouut
;

176 
__ušt128_t
 *
ouuts
;

177 } 
	tunifÜm_´eg’_¡©e
;

179 
	sunifÜm_Úlše_¡©e
 {

180 
ušt64_t
 
maxouuts
;

181 
ušt64_t
 
maxv®ue
;

182 
£ed
;

183 *
buf
;

184 
STATELEN
;

185 
¿ndom_d©a
 *
¿nd_¡©e
;

186 } 
	tunifÜm_Úlše_¡©e
;

188 
	szf_·¿ms
 {

189 
exp
;

190 
univ”£
;

191 
§m¶e
;

192 } 
	tzf_·¿ms
;

194 
	szfŸn_´eg’_¡©e
 {

195 
zf_·¿ms
 *
·¿ms
;

196 
ušt64_t
 
maxouuts
;

197 
ušt64_t
 
Ãxtouut
;

198 
__ušt128_t
 *
ouuts
;

199 } 
	tzfŸn_´eg’_¡©e
;

201 
	s­p_·¿ms
 {

202 *
_fe
;

203 
num
;

204 } 
	t­p_·¿ms
;

206 
	s­p_´eg’_¡©e
 {

207 
­p_·¿ms
 *
·¿ms
;

208 
ušt64_t
 
maxouuts
;

209 
ušt64_t
 
Ãxtouut
;

210 
__ušt128_t
 *
ouuts
;

211 } 
	t­p_´eg’_¡©e
;

213 
__ušt128_t
 *
	$­p_fe_»ad
(*
_fe
, 
num
)

215 
i
 = 0, 
ch
;

216 
__ušt128_t
 *
v®s
 = (__ušt128_t*)
	`m®loc
((__ušt128_t)*
num
);

217 
FILE
 * 
šput_v®ues
;

219 
šput_v®ues
 = 
	`fİ’
(
_fe
,"r");

220 ià(
šput_v®ues
 =ğ
NULL
) {

221 
	`årštf
(
¡d”r
, "Error! Could‚ot open file.\n");

224 
ch
 = 
	`fsÿnf
(
šput_v®ues
, "%ld", (
ušt64_t
 *)&
v®s
[
i
++]);

225 
ch
 !ğ
EOF
) {

226 
ch
 = 
	`fsÿnf
(
šput_v®ues
, "%ld", (
ušt64_t
 *)&
v®s
[
i
]);

227 
i
++;

230 
	`fşo£
(
šput_v®ues
);

231  
v®s
;

232 
	}
}

234 *
	$­p_´eg’_š™
(
ušt64_t
 
maxouuts
, 
__ušt128_t
 
maxv®ue
, *
·¿ms
)

236 
ušt32_t
 
i
;

237 
­p_´eg’_¡©e
 *
¡©e
 = (­p_´eg’_¡©*)
	`m®loc
((app_pregen_state));

238 
	`as£¹
(
¡©e
 !ğ
NULL
);

240 
¡©e
->
maxouuts
 = maxoutputs;

241 
¡©e
->
Ãxtouut
 = 0;

242 
¡©e
->
·¿ms
 = (
­p_·¿ms
 *)params;

244 
timev®
 
tv
;

245 
	`g‘timeofday
(&
tv
, 
NULL
);

246 
	`RSEED
(
tv
.
tv_£c
 +v.
tv_u£c
);

248 
¡©e
->
ouuts
 = 
	`­p_fe_»ad
(¡©e->
·¿ms
->
_fe
, s‹->·¿ms->
num
);

249 
	`as£¹
(
¡©e
->
ouuts
 !ğ
NULL
);

250 
i
 = 0; i < 
¡©e
->
·¿ms
->
num
; i++)

251 
¡©e
->
ouuts
[
i
] = (1 * s‹->ouuts[i]è% 
maxv®ue
;

253  (*)
¡©e
;

254 
	}
}

256 
	$­p_´eg’_g’_¿nd
(*
_¡©e
, 
ušt64_t
 
nouuts
, 
__ušt128_t
 *
ouuts
)

258 
­p_´eg’_¡©e
 *
¡©e
 = (­p_´eg’_¡©*)
_¡©e
;

259 
	`as£¹
(
¡©e
->
Ãxtouut
 + 
nouuts
 <ğ¡©e->
maxouuts
);

260 
	`memıy
(
ouuts
, 
¡©e
->ouuts+¡©e->
Ãxtouut
, 
nouuts
 * (*state->outputs));

261 
¡©e
->
Ãxtouut
 +ğ
nouuts
;

262  
nouuts
;

263 
	}
}

265 *
	$­p_´eg’_du¶iÿ‹
(*
¡©e
)

267 
­p_´eg’_¡©e
 *
Ãw¡©e
 = (­p_´eg’_¡©*)
	`m®loc
((*newstate));

268 
	`as£¹
(
Ãw¡©e
);

269 
	`memıy
(
Ãw¡©e
, 
¡©e
, (*newstate));

270  
Ãw¡©e
;

271 
	}
}

273 *
	$zfŸn_´eg’_š™
(
ušt64_t
 
maxouuts
, 
__ušt128_t
 
maxv®ue
, *
·¿ms
)

275 
ušt32_t
 
i
;

276 
zfŸn_´eg’_¡©e
 *
¡©e
 = (zfŸn_´eg’_¡©*)
	`m®loc
((zipfian_pregen_state));

277 
	`as£¹
(
¡©e
 !ğ
NULL
);

279 
¡©e
->
maxouuts
 = maxoutputs;

280 
¡©e
->
Ãxtouut
 = 0;

281 
¡©e
->
·¿ms
 = (
zf_·¿ms
*)params;

283 
timev®
 
tv
;

284 
	`g‘timeofday
(&
tv
, 
NULL
);

285 
	`RSEED
(
tv
.
tv_£c
 +v.
tv_u£c
);

287 
¡©e
->
ouuts
 = 
	`zf_g’
(¡©e->
·¿ms
->
univ”£
, s‹->·¿ms->
§m¶e
, s‹->·¿ms->
exp
);

288 
	`as£¹
(
¡©e
->
ouuts
 !ğ
NULL
);

289 
i
 = 0; i < 
¡©e
->
maxouuts
; i++)

290 
¡©e
->
ouuts
[
i
] = (1 * s‹->ouuts[i]è% 
maxv®ue
;

292  (*)
¡©e
;

293 
	}
}

295 
	$zfŸn_´eg’_g’_¿nd
(*
_¡©e
, 
ušt64_t
 
nouuts
, 
__ušt128_t
 *
ouuts
)

297 
zfŸn_´eg’_¡©e
 *
¡©e
 = (zfŸn_´eg’_¡©*)
_¡©e
;

298 
	`as£¹
(
¡©e
->
Ãxtouut
 + 
nouuts
 <ğ¡©e->
maxouuts
);

299 
	`memıy
(
ouuts
, 
¡©e
->ouuts+¡©e->
Ãxtouut
, 
nouuts
 * (*state->outputs));

300 
¡©e
->
Ãxtouut
 +ğ
nouuts
;

301  
nouuts
;

302 
	}
}

304 *
	$zfŸn_´eg’_du¶iÿ‹
(*
¡©e
)

306 
zfŸn_´eg’_¡©e
 *
Ãw¡©e
 = (zfŸn_´eg’_¡©*)
	`m®loc
((*newstate));

307 
	`as£¹
(
Ãw¡©e
);

308 
	`memıy
(
Ãw¡©e
, 
¡©e
, (*newstate));

309  
Ãw¡©e
;

310 
	}
}

312 *
	$unifÜm_´eg’_š™
(
ušt64_t
 
maxouuts
, 
__ušt128_t
 
maxv®ue
, *
·¿ms
)

314 
ušt32_t
 
i
;

315 
unifÜm_´eg’_¡©e
 *
¡©e
 = (unifÜm_´eg’_¡©*)
	`m®loc
((uniform_pregen_state));

316 
	`as£¹
(
¡©e
 !ğ
NULL
);

318 
¡©e
->
Ãxtouut
 = 0;

320 
¡©e
->
maxouuts
 = maxoutputs;

321 
¡©e
->
ouuts
 = (
__ušt128_t
 *)
	`m®loc
(¡©e->
maxouuts
 * (state->outputs[0]));

322 
	`as£¹
(
¡©e
->
ouuts
 !ğ
NULL
);

323 
	`RAND_by‹s
((*)
¡©e
->
ouuts
, (*¡©e->ouutsè* s‹->
maxouuts
);

324 
i
 = 0; i < 
¡©e
->
maxouuts
; i++)

325 
¡©e
->
ouuts
[
i
] = (1 * s‹->ouuts[i]è% 
maxv®ue
;

327  (*)
¡©e
;

328 
	}
}

330 
	$unifÜm_´eg’_g’_¿nd
(*
_¡©e
, 
ušt64_t
 
nouuts
, 
__ušt128_t
 *
ouuts
)

332 
unifÜm_´eg’_¡©e
 *
¡©e
 = (unifÜm_´eg’_¡©*)
_¡©e
;

333 
	`as£¹
(
¡©e
->
Ãxtouut
 + 
nouuts
 <ğ¡©e->
maxouuts
);

334 
	`memıy
(
ouuts
, 
¡©e
->ouuts+¡©e->
Ãxtouut
, 
nouuts
 * (*state->outputs));

335 
¡©e
->
Ãxtouut
 +ğ
nouuts
;

336  
nouuts
;

337 
	}
}

339 *
	$unifÜm_´eg’_du¶iÿ‹
(*
¡©e
)

341 
unifÜm_´eg’_¡©e
 *
Ãw¡©e
 = (unifÜm_´eg’_¡©*)
	`m®loc
((*newstate));

342 
	`as£¹
(
Ãw¡©e
);

343 
	`memıy
(
Ãw¡©e
, 
¡©e
, (*newstate));

344  
Ãw¡©e
;

345 
	}
}

347 *
	$unifÜm_Úlše_š™
(
ušt64_t
 
maxouuts
, 
__ušt128_t
 
maxv®ue
, *
·¿ms
)

349 
unifÜm_Úlše_¡©e
 *
¡©e
 = (unifÜm_Úlše_¡©*)
	`m®loc
((uniform_online_state));

350 
	`as£¹
(
¡©e
 !ğ
NULL
);

352 
¡©e
->
maxouuts
 = maxoutputs;

353 
¡©e
->
maxv®ue
 = maxvalue;

354 
¡©e
->
£ed
 = 
	`time
(
NULL
);

355 
¡©e
->
STATELEN
 = 256;

356 
¡©e
->
buf
 = (*)
	`ÿÎoc
(256, ());

357 
¡©e
->
¿nd_¡©e
 = (
¿ndom_d©a
 *)
	`ÿÎoc
(1, (random_data));

359 
	`š™¡©e_r
(
¡©e
->
£ed
, s‹->
buf
, s‹->
STATELEN
, s‹->
¿nd_¡©e
);

360  (*)
¡©e
;

361 
	}
}

363 
	$unifÜm_Úlše_g’_¿nd
(*
_¡©e
, 
ušt64_t
 
nouuts
, 
__ušt128_t
 *
ouuts
)

365 
ušt32_t
 
i
, 
j
;

366 
unifÜm_Úlše_¡©e
 *
¡©e
 = (unifÜm_Úlše_¡©*)
_¡©e
;

367 
	`as£¹
(
¡©e
->
¿nd_¡©e
 !ğ
NULL
);

368 
	`mem£t
(
ouuts
, 0, 
nouuts
*(
__ušt128_t
));

369 
i
 = 0; i < 
nouuts
; i++) {

370 
št32_t
 
»suÉ
;

371 
j
 = 0; j < 4; j++) {

372 
	`¿ndom_r
(
¡©e
->
¿nd_¡©e
, &
»suÉ
);

373 
ouuts
[
i
] = (ouuts[i] * 
RAND_MAX
è+ 
»suÉ
;

375 
ouuts
[
i
] = (1 * ouuts[i]è% 
¡©e
->
maxv®ue
;

377  
nouuts
;

378 
	}
}

380 *
	$unifÜm_Úlše_du¶iÿ‹
(*
_¡©e
)

382 
unifÜm_Úlše_¡©e
 *
Ãw¡©e
 = (unifÜm_Úlše_¡©*)
	`m®loc
((uniform_online_state));

383 
	`as£¹
(
Ãw¡©e
 !ğ
NULL
);

384 
unifÜm_Úlše_¡©e
 *
Şd¡©e
 = (unifÜm_Úlše_¡©*)
_¡©e
;

386 
Ãw¡©e
->
maxv®ue
 = 
Şd¡©e
->maxvalue;

387 
Ãw¡©e
->
£ed
 = 
Şd¡©e
->seed;

388 
Ãw¡©e
->
STATELEN
 = 
Şd¡©e
->STATELEN;

390 
Ãw¡©e
->
buf
 = (*)
	`ÿÎoc
(256, ());

391 
	`memıy
(
Ãw¡©e
->
buf
, 
Şd¡©e
->buf,‚ew¡©e->
STATELEN
);

392 
Ãw¡©e
->
¿nd_¡©e
 = (
¿ndom_d©a
 *)
	`ÿÎoc
(1, (random_data));

394 
	`š™¡©e_r
(
Ãw¡©e
->
£ed
,‚ew¡©e->
buf
,‚ew¡©e->
STATELEN
,‚ew¡©e->
¿nd_¡©e
);

395  
Ãw¡©e
;

396 
	}
}

398 
¿nd_g’”©Ü
 
	gunifÜm_´eg’
 = {

399 
unifÜm_´eg’_š™
,

400 
unifÜm_´eg’_g’_¿nd
,

401 
unifÜm_´eg’_du¶iÿ‹


404 
¿nd_g’”©Ü
 
	gunifÜm_Úlše
 = {

405 
unifÜm_Úlše_š™
,

406 
unifÜm_Úlše_g’_¿nd
,

407 
unifÜm_Úlše_du¶iÿ‹


410 
¿nd_g’”©Ü
 
	gzfŸn_´eg’
 = {

411 
zfŸn_´eg’_š™
,

412 
zfŸn_´eg’_g’_¿nd
,

413 
zfŸn_´eg’_du¶iÿ‹


416 
¿nd_g’”©Ü
 
	g­p_´eg’
 = {

417 
­p_´eg’_š™
,

418 
­p_´eg’_g’_¿nd
,

419 
­p_´eg’_du¶iÿ‹


422 
f‹r
 
	ggqf
 = {

423 
gqf_š™
,

424 
gqf_š£¹
,

425 
gqf_lookup
,

426 
gqf_¿nge
,

427 
gqf_de¡roy
,

428 
gqf_™”©Ü
,

429 
gqf_g‘
,

430 
gqf_Ãxt
,

431 
gqf_’d


434 
	$f‹r_muÉi_m”ge
(
f‹r
 
qf_¬r
[], 
nqf
, f‹¸
qä
)

436 
i
;

437 
æag
 = 0;

438 
sm®Ë¡_i
 = 0;

439 
ušt64_t
 
sm®Ë¡_key
 = 
UINT64_MAX
;

440 
i
=0; i<
nqf
; i++) {

441 
qf_¬r
[
i
].
	`™”©Ü
(0);

444 !
æag
) {

445 
ušt64_t
 
keys
[
nqf
];

446 
ušt64_t
 
v®ues
[
nqf
];

447 
ušt64_t
 
couÁs
[
nqf
];

448 
i
=0; i<
nqf
; i++)

449 
qf_¬r
[
i
].
	`g‘
(&
keys
[i], &
v®ues
[i], &
couÁs
[i]);

452 
sm®Ë¡_key
 = 
UINT64_MAX
;

453 
i
=0; i<
nqf
; i++) {

454 ià(
keys
[
i
] < 
sm®Ë¡_key
) {

455 
sm®Ë¡_key
 = 
keys
[
i
]; 
sm®Ë¡_i
 = i;

458 
qä
.
	`š£¹
(
keys
[
sm®Ë¡_i
], 
couÁs
[smallest_i]);

459 
qf_¬r
[
sm®Ë¡_i
].
	`Ãxt
();

460 
qf_¬r
[
sm®Ë¡_i
].
	`g‘
(&
keys
[sm®Ë¡_i], &
v®ues
[sm®Ë¡_i], &
couÁs
[smallest_i]);

461 } !
qf_¬r
[
sm®Ë¡_i
].
	`’d
());

464 ià(
sm®Ë¡_i
 < 
nqf
-1)

465 
	`memmove
(&
qf_¬r
[
sm®Ë¡_i
], &qf_¬r[sm®Ë¡_i+1], (
nqf
-smallest_i-1)*(qf_arr[0]));

466 
nqf
--;

467 ià(
nqf
 == 1)

468 
æag
 = 1;

470 ià(!
qf_¬r
[0].
	`’d
()) {

472 
ušt64_t
 
key
, 
v®ue
, 
couÁ
;

473 
qf_¬r
[0].
	`g‘
(&
key
, &
v®ue
, &
couÁ
);

474 
qä
.
	`š£¹
(
key
, 
couÁ
);

475 } !
qf_¬r
[0].
	`Ãxt
());

479 
	}
}

482 
ušt64_t
 
	$tv2m£c
(
timev®
 
tv
)

484  
tv
.
tv_£c
 * 1000 +v.
tv_u£c
 / 1000;

485 
	}
}

487 
	$cmp_ušt64_t
(cÚ¡ *
a
, cÚ¡ *
b
)

489 cÚ¡ 
ušt64_t
 *
ua
 = (cÚ¡ ušt64_t*)
a
, *
ub
 = (cÚ¡ ušt64_ˆ*)
b
;

490  *
ua
 < *
ub
 ? -1 : *ua == *ub ? 0 : 1;

491 
	}
}

493 
	$u§ge
(*
Çme
)

495 
	`´štf
("%s [OPTIONS]\n"

513 
Çme
);

514 
	}
}

516 
	$maš
(
¬gc
, **
¬gv
)

518 
ušt32_t
 
nb™s
 = 22, 
Äuns
 = 1;

519 
Åošts
 = 20;

520 
ušt64_t
 
n¦Ùs
 = (1ULL << 
nb™s
), 
nv®s
 = 950*nslots/1000;

521 
s
 = 1.5; 
univ”£
 = 
nv®s
;

522 
numv®s
 = 0;

523 
numf‹rs
 = 0;

524 *
¿ndmode
 = "uniform_pregen";

525 *
d©a¡ruù
 = "gqf";

526 *
ouutfe
 = "gqf";

527 *
šputfe
 = "gqf";

528 *
·¿m
 = 
NULL
;

530 
f‹r
 
f‹r_ds
;

531 
¿nd_g’”©Ü
 *
v®s_g’
;

532 *
v®s_g’_¡©e
;

533 *
Şd_v®s_g’_¡©e
;

534 
¿nd_g’”©Ü
 *
Ùh”v®s_g’
;

535 *
Ùh”v®s_g’_¡©e
;

537 
i
, 
j
, 
exp
, 
run
;

538 
timev®
 
tv_š£¹
[100][1];

539 
timev®
 
tv_ex™_lookup
[100][1];

540 
timev®
 
tv_çl£_lookup
[100][1];

541 
ušt64_t
 
ås
 = 0;

543 cÚ¡ *
dœ
 = "./";

544 cÚ¡ *
š£¹_İ
 = "-insert.txt\0";

545 cÚ¡ *
ex™_lookup_İ
 = "-exists-lookup.txt\0";

546 cÚ¡ *
çl£_lookup_İ
 = "-false-lookup.txt\0";

547 
f’ame_š£¹
[256];

548 
f’ame_ex™_lookup
[256];

549 
f’ame_çl£_lookup
[256];

552 
İt
;

553 *
‹rm
;

555 (
İt
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "n:r:p:m:d:a:f:i:v:s")) != -1) {

556 
İt
) {

558 
nb™s
 = 
	`¡¹Ş
(
İrg
, &
‹rm
, 10);

559 ià(*
‹rm
) {

560 
	`årštf
(
¡d”r
, "Argumento -n must be‡n integer\n");

561 
	`u§ge
(
¬gv
[0]);

562 
	`ex™
(1);

564 
n¦Ùs
 = (1ULL << 
nb™s
);

565 
nv®s
 = 950*
n¦Ùs
/1000;

566 
univ”£
 = 
nv®s
;

569 
Äuns
 = 
	`¡¹Ş
(
İrg
, &
‹rm
, 10);

570 ià(*
‹rm
) {

571 
	`årštf
(
¡d”r
, "Argumento -r must be‡n integer\n");

572 
	`u§ge
(
¬gv
[0]);

573 
	`ex™
(1);

577 
Åošts
 = 
	`¡¹Ş
(
İrg
, &
‹rm
, 10);

578 ià(*
‹rm
) {

579 
	`årštf
(
¡d”r
, "Argumento -p must be‡n integer\n");

580 
	`u§ge
(
¬gv
[0]);

581 
	`ex™
(1);

585 
¿ndmode
 = 
İrg
;

588 
d©a¡ruù
 = 
İrg
;

591 
ouutfe
 = 
İrg
;

594 
šputfe
 = 
İrg
;

597 
numv®s
 = ()
	`¡¹Ş
(
İrg
, &
‹rm
, 10);

600 
s
 = 
	`¡¹od
(
İrg
, 
NULL
);

603 
univ”£
 = 
	`¡¹Ş
(
İrg
, &
‹rm
, 10);

606 
numf‹rs
 = 
	`¡¹Ş
(
İrg
, &
‹rm
, 10);

607 ià(*
‹rm
) {

608 
	`årštf
(
¡d”r
, "Argumento -p must be‡n integer\n");

609 
	`u§ge
(
¬gv
[0]);

610 
	`ex™
(1);

614 
	`årštf
(
¡d”r
, "Unknown option\n");

615 
	`u§ge
(
¬gv
[0]);

616 
	`ex™
(1);

621 ià(
	`¡rcmp
(
¿ndmode
, "uniform_pregen") == 0) {

622 
v®s_g’
 = &
unifÜm_´eg’
;

623 
Ùh”v®s_g’
 = &
unifÜm_´eg’
;

624 } ià(
	`¡rcmp
(
¿ndmode
, "uniform_online") == 0) {

625 
v®s_g’
 = &
unifÜm_Úlše
;

626 
Ùh”v®s_g’
 = &
unifÜm_Úlše
;

627 } ià(
	`¡rcmp
(
¿ndmode
, "zipfian_pregen") == 0) {

628 
v®s_g’
 = &
zfŸn_´eg’
;

629 
Ùh”v®s_g’
 = &
unifÜm_´eg’
;

630 
·¿m
 = (
zf_·¿ms
 *)
	`m®loc
((zipf_params));

631 
	`as£¹
(
·¿m
 !ğ
NULL
);

632 ià(
s
 =ğ0 || 
univ”£
 == 0) {

633 
	`årštf
(
¡d”r
, "Unknown„andmode.\n");

634 
	`u§ge
(
¬gv
[0]);

635 
	`ex™
(1);

637 ((
zf_·¿ms
 *)
·¿m
)->
exp
 = 
s
;

638 ((
zf_·¿ms
 *)
·¿m
)->
univ”£
 = universe;

639 ((
zf_·¿ms
 *)
·¿m
)->
§m¶e
 = 
nv®s
;

640 } ià(
	`¡rcmp
(
¿ndmode
, "app_pregen") == 0) {

641 
v®s_g’
 = &
­p_´eg’
;

642 
Ùh”v®s_g’
 = &
­p_´eg’
;

643 
·¿m
 = (
­p_·¿ms
 *)
	`m®loc
((app_params));

644 ((
­p_·¿ms
 *)
·¿m
)->
_fe
 = 
šputfe
;

645 ((
­p_·¿ms
 *)
·¿m
)->
num
 = 
numv®s
;

646 
nv®s
 = 
numv®s
;

648 
	`årštf
(
¡d”r
, "Unknown„andmode.\n");

649 
	`u§ge
(
¬gv
[0]);

650 
	`ex™
(1);

653 ià(
	`¡rcmp
(
d©a¡ruù
, "gqf") == 0) {

654 
f‹r_ds
 = 
gqf
;

662 
	`årštf
(
¡d”r
, "Unknown„andmode.\n");

663 
	`u§ge
(
¬gv
[0]);

664 
	`ex™
(1);

667 
	`¢´štf
(
f’ame_š£¹
, 
	`¡¾’
(
dœ
è+ sŒËn(
ouutfe
è+ sŒËn(
š£¹_İ
) + 1, "%s%s%s", dir, outputfile, insert_op);

668 
	`¢´štf
(
f’ame_ex™_lookup
, 
	`¡¾’
(
dœ
è+ sŒËn(
ouutfe
è+ sŒËn(
ex™_lookup_İ
) + 1, "%s%s%s", dir, outputfile,ƒxit_lookup_op);

670 
	`¢´štf
(
f’ame_çl£_lookup
, 
	`¡¾’
(
dœ
è+ sŒËn(
ouutfe
è+ sŒËn(
çl£_lookup_İ
) + 1, "%s%s%s", dir, outputfile, false_lookup_op);

672 
FILE
 *
å_š£¹
 = 
	`fİ’
(
f’ame_š£¹
, "w");

673 
FILE
 *
å_ex™_lookup
 = 
	`fİ’
(
f’ame_ex™_lookup
, "w");

674 
FILE
 *
å_çl£_lookup
 = 
	`fİ’
(
f’ame_çl£_lookup
, "w");

676 ià(
å_š£¹
 =ğ
NULL
 || 
å_ex™_lookup
 =ğNULL || 
å_çl£_lookup
 == NULL) {

677 
	`´štf
("Can't openhe data file");

678 
	`ex™
(1);

681 ià(
numf‹rs
 > 0) {

682 
ušt64_t
 
num_hash_b™s
 = 
nb™s
+ 
	`û
(
numf‹rs
/2) + 8;

683 
f‹r
 
f‹rs
[
numf‹rs
];

684 
f‹r
 
fš®_f‹r
;

685 
¿nd_g’”©Ü
 *
g’”©Ü
[
numf‹rs
];

686 *
g’”©Ü_¡©e
[
numf‹rs
];

689 
i
 = 0; i < 
numf‹rs
; i++) {

690 
f‹rs
[
i
] = 
gqf
;

691 
f‹rs
[
i
].
	`š™
(
nb™s
, 
num_hash_b™s
);

692 
g’”©Ü
[
i
] = &
unifÜm_Úlše
;

693 
g’”©Ü_¡©e
[
i
] = 
g’”©Ü
[i]->
	`š™
(
nv®s
, 
f‹rs
[i].
	`¿nge
(), 
·¿m
);

695 
fš®_f‹r
 = 
gqf
;

696 
fš®_f‹r
.
	`š™
(
nb™s
+
	`û
(
numf‹rs
/2), 
num_hash_b™s
);

699 
__ušt128_t
 *
v®s
 = (__ušt128_ˆ*)
	`m®loc
((
nv®s
/32)*(__uint128_t));

700 
i
 = 0; i < 
numf‹rs
; i++) {

701 
k
 = 0; k < 32; k++) {

702 
	`mem£t
(
v®s
, 0, (
nv®s
/32)*(
__ušt128_t
));

703 
	`as£¹
(
g’”©Ü
[
i
]->
	`g’
(
g’”©Ü_¡©e
[i], 
nv®s
/32, 
v®s
) ==‚vals/32);

704 
ušt32_t
 
j
 = 0; j < 
nv®s
/32; j++) {

705 
f‹rs
[
i
].
	`š£¹
(
v®s
[
j
], 1);

709 
	`ä“
(
v®s
);

711 
	`g‘timeofday
(&
tv_š£¹
[0][0], 
NULL
);

712 
	`f‹r_muÉi_m”ge
(
f‹rs
, 
numf‹rs
, 
fš®_f‹r
);

713 
	`g‘timeofday
(&
tv_š£¹
[1][0], 
NULL
);

715 
	`´štf
("Insert Performance:\n");

716 
	`´štf
(" %f",

717 0.001 * (
nv®s
*
numf‹rs
)/(
	`tv2m£c
(
tv_š£¹
[1][0]) -v2msec(tv_insert[0][0])));

718 
	`´štf
(" Million inserts…er second\n");

721 
run
 = 0;„uÀ< 
Äuns
;„un++) {

722 
ås
 = 0;

723 
f‹r_ds
.
	`š™
(
nb™s
,‚bits+8);

725 
v®s_g’_¡©e
 = 
v®s_g’
->
	`š™
(
nv®s
, 
f‹r_ds
.
	`¿nge
(), 
·¿m
);

726 
Şd_v®s_g’_¡©e
 = 
v®s_g’
->
	`dup
(
v®s_g’_¡©e
);

727 
	`¦“p
(5);

728 
Ùh”v®s_g’_¡©e
 = 
Ùh”v®s_g’
->
	`š™
(
nv®s
, 
f‹r_ds
.
	`¿nge
(), 
·¿m
);

730 
exp
 = 0;ƒx°< 2*
Åošts
;ƒxp += 2) {

731 
i
 = (
exp
/2)*(
nv®s
/
Åošts
);

732 
j
 = ((
exp
/2è+ 1)*(
nv®s
/
Åošts
);

733 
	`´štf
("Round: %d\n", 
exp
/2);

735 
	`g‘timeofday
(&
tv_š£¹
[
exp
][
run
], 
NULL
);

736 ;
i
 < 
j
; i += 1<<16) {

737 
n™ems
 = 
j
 - 
i
 < 1<<16 ? j - i : 1<<16;

738 
__ušt128_t
 
v®s
[1<<16];

739 
m
;

740 
	`as£¹
(
v®s_g’
->
	`g’
(
v®s_g’_¡©e
, 
n™ems
, 
v®s
) ==‚items);

742 
m
 = 0; m < 
n™ems
; m++) {

743 
f‹r_ds
.
	`š£¹
(
v®s
[
m
], 1);

746 
	`g‘timeofday
(&
tv_š£¹
[
exp
+1][
run
], 
NULL
);

748 
i
 = (
exp
/2)*(
nv®s
/
Åošts
);

749 
	`g‘timeofday
(&
tv_ex™_lookup
[
exp
][
run
], 
NULL
);

750 ;
i
 < 
j
; i += 1<<16) {

751 
n™ems
 = 
j
 - 
i
 < 1<<16 ? j - i : 1<<16;

752 
__ušt128_t
 
v®s
[1<<16];

753 
m
;

754 
	`as£¹
(
v®s_g’
->
	`g’
(
Şd_v®s_g’_¡©e
, 
n™ems
, 
v®s
) ==‚items);

755 
m
 = 0; m < 
n™ems
; m++) {

756 ià(!
f‹r_ds
.
	`lookup
(
v®s
[
m
])) {

757 
	`årštf
(
¡d”r
,

759 (
ušt64_t
)(
v®s
[
m
]>>64),

760 (
ušt64_t
)(
v®s
[
m
] & 0xffffffffffffffff));

761 
	`abÜt
();

765 
	`g‘timeofday
(&
tv_ex™_lookup
[
exp
+1][
run
], 
NULL
);

767 
i
 = (
exp
/2)*(
nv®s
/
Åošts
);

768 
	`g‘timeofday
(&
tv_çl£_lookup
[
exp
][
run
], 
NULL
);

769 ;
i
 < 
j
; i += 1<<16) {

770 
n™ems
 = 
j
 - 
i
 < 1<<16 ? j - i : 1<<16;

771 
__ušt128_t
 
Ùh”v®s
[1<<16];

772 
m
;

773 
	`as£¹
(
Ùh”v®s_g’
->
	`g’
(
Ùh”v®s_g’_¡©e
, 
n™ems
, 
Ùh”v®s
) ==‚items);

774 
m
 = 0; m < 
n™ems
; m++) {

775 
ås
 +ğ
f‹r_ds
.
	`lookup
(
Ùh”v®s
[
m
]);

778 
	`g‘timeofday
(&
tv_çl£_lookup
[
exp
+1][
run
], 
NULL
);

780 
f‹r_ds
.
	`de¡roy
();

783 
	`´štf
("Wœšg„esuÉ tØfe: %s\n", 
f’ame_š£¹
);

784 
	`årštf
(
å_š£¹
, "x_0");

785 
run
 = 0;„uÀ< 
Äuns
;„un++) {

786 
	`årštf
(
å_š£¹
, " y_%d", 
run
);

788 
	`årštf
(
å_š£¹
, "\n");

789 
exp
 = 0;ƒx°< 2*
Åošts
;ƒxp += 2) {

790 
	`årštf
(
å_š£¹
, "%d", ((
exp
/2)*(100/
Åošts
)));

791 
run
 = 0;„uÀ< 
Äuns
;„un++) {

792 
	`årštf
(
å_š£¹
, " %f",

793 0.001 * (
nv®s
/
Åošts
)/(
	`tv2m£c
(
tv_š£¹
[
exp
+1][
run
]) -v2msec(tv_insert[exp][run])));

795 
	`årštf
(
å_š£¹
, "\n");

797 
	`´štf
("Insert Performance written\n");

799 
	`´štf
("Wœšg„esuÉ tØfe: %s\n", 
f’ame_ex™_lookup
);

800 
	`årštf
(
å_ex™_lookup
, "x_0");

801 
run
 = 0;„uÀ< 
Äuns
;„un++) {

802 
	`årštf
(
å_ex™_lookup
, " y_%d", 
run
);

804 
	`årštf
(
å_ex™_lookup
, "\n");

805 
exp
 = 0;ƒx°< 2*
Åošts
;ƒxp += 2) {

806 
	`årštf
(
å_ex™_lookup
, "%d", ((
exp
/2)*(100/
Åošts
)));

807 
run
 = 0;„uÀ< 
Äuns
;„un++) {

808 
	`årštf
(
å_ex™_lookup
, " %f",

809 0.001 * (
nv®s
/
Åošts
)/(
	`tv2m£c
(
tv_ex™_lookup
[
exp
+1][
run
]) -v2msec(tv_exit_lookup[exp][run])));

811 
	`årštf
(
å_ex™_lookup
, "\n");

813 
	`´štf
("Existing Lookup Performance written\n");

815 
	`´štf
("Wœšg„esuÉ tØfe: %s\n", 
f’ame_çl£_lookup
);

816 
	`årštf
(
å_çl£_lookup
, "x_0");

817 
run
 = 0;„uÀ< 
Äuns
;„un++) {

818 
	`årštf
(
å_çl£_lookup
, " y_%d", 
run
);

820 
	`årštf
(
å_çl£_lookup
, "\n");

821 
exp
 = 0;ƒx°< 2*
Åošts
;ƒxp += 2) {

822 
	`årštf
(
å_çl£_lookup
, "%d", ((
exp
/2)*(100/
Åošts
)));

823 
run
 = 0;„uÀ< 
Äuns
;„un++) {

824 
	`årštf
(
å_çl£_lookup
, " %f",

825 0.001 * (
nv®s
/
Åošts
)/(
	`tv2m£c
(
tv_çl£_lookup
[
exp
+1][
run
]) -v2msec(tv_false_lookup[exp][run])));

827 
	`årštf
(
å_çl£_lookup
, "\n");

829 
	`´štf
("False Lookup Performance written\n");

831 
	`´štf
("FP„©e: %à(%lu/%lu)\n", 1.0 * 
ås
 / 
nv®s
, fps,‚vals);

833 
	`fşo£
(
å_š£¹
);

834 
	`fşo£
(
å_ex™_lookup
);

835 
	`fşo£
(
å_çl£_lookup
);

838 
	}
}

	@src/gqf.c

10 
	~<¡dlib.h
>

11 
	~<as£¹.h
>

12 
	~<¡ršg.h
>

13 
	~<š‰y³s.h
>

14 
	~<¡dio.h
>

15 
	~<uni¡d.h
>

16 
	~<m©h.h
>

17 
	~<time.h
>

18 
	~<sys/mmª.h
>

19 
	~<sys/¡©.h
>

20 
	~<fú.h
>

22 
	~"hashut.h
"

23 
	~"gqf.h
"

24 
	~"gqf_št.h
"

31 
	#MAX_VALUE
(
nb™s
è((1ULL << (nb™s)è- 1)

	)

32 
	#BITMASK
(
nb™s
) \

33 ((
nb™s
è=ğ64 ? 0xfffffffffffffffà: 
	`MAX_VALUE
Òb™s))

	)

34 
	#NUM_SLOTS_TO_LOCK
 (1ULL<<16)

	)

35 
	#CLUSTER_SIZE
 (1ULL<<14)

	)

36 
	#METADATA_WORD
(
qf
,
f›ld
,
¦Ù_šdex
) \

37 (
	`g‘_block
((
qf
), (
¦Ù_šdex
) / \

38 
QF_SLOTS_PER_BLOCK
)->
f›ld
[((
¦Ù_šdex
è% QF_SLOTS_PER_BLOCKè/ 64])

	)

40 
	#GET_NO_LOCK
(
æag
è(æag & 
QF_NO_LOCK
)

	)

41 
	#GET_TRY_ONCE_LOCK
(
æag
è(æag & 
QF_TRY_ONCE_LOCK
)

	)

42 
	#GET_WAIT_FOR_LOCK
(
æag
è(æag & 
QF_WAIT_FOR_LOCK
)

	)

43 
	#GET_KEY_HASH
(
æag
è(æag & 
QF_KEY_IS_HASH
)

	)

45 
	#DISTANCE_FROM_HOME_SLOT_CUTOFF
 1000

	)

46 
	#BILLION
 1000000000L

	)

48 #ifdeà
DEBUG


49 
	#PRINT_DEBUG
 1

	)

51 
	#PRINT_DEBUG
 0

	)

54 
	#DEBUG_CQF
(
fmt
, ...) \

55 dØ{ ià(
PRINT_DEBUG
è
	`årštf
(
¡d”r
, 
fmt
, 
__VA_ARGS__
); } 0)

	)

57 
	#DEBUG_DUMP
(
qf
) \

58 dØ{ ià(
PRINT_DEBUG
è
	`qf_dump_m‘ad©a
(
qf
); } 0)

	)

60 
__šlše__
 
	$rdtsc
()

62 
hi
, 
lo
;

63 
__asm__
 
	`__vŞ©e__
 ("rdtsc" : "÷"(
lo
), "=d"(
hi
));

64  ( ()
lo
)|Ğ(()
hi
)<<32 );

65 
	}
}

67 #ifdeà
LOG_WAIT_TIME


68 
šlše
 
boŞ
 
	$qf_¥š_lock
(
QF
 *
qf
, vŞ©*
lock
, 
ušt64_t
 
idx
,

69 
ušt8_t
 
æag
)

71 
time¥ec
 
¡¬t
, 
’d
;

72 
boŞ
 
»t
;

74 
	`şock_g‘time
(
CLOCK_THREAD_CPUTIME_ID
, &
¡¬t
);

75 ià(
	`GET_WAIT_FOR_LOCK
(
æag
è!ğ
QF_WAIT_FOR_LOCK
) {

76 
»t
 = !
	`__sync_lock_‹¡_ªd_£t
(
lock
, 1);

77 
	`şock_g‘time
(
CLOCK_THREAD_CPUTIME_ID
, &
’d
);

78 
qf
->
ruÁimed©a
->
wa™_times
[
idx
].
locks_acquœed_sšgË_©‹m±
++;

79 
qf
->
ruÁimed©a
->
wa™_times
[
idx
].
tÙ®_time_sšgË
 +ğ
BILLION
 * (
’d
.
tv_£c
 -

80 
¡¬t
.
tv_£c
) +

81 
’d
.
tv_n£c
 - 
¡¬t
.tv_nsec;

83 ià(!
	`__sync_lock_‹¡_ªd_£t
(
lock
, 1)) {

84 
	`şock_g‘time
(
CLOCK_THREAD_CPUTIME_ID
, &
’d
);

85 
qf
->
ruÁimed©a
->
wa™_times
[
idx
].
locks_acquœed_sšgË_©‹m±
++;

86 
qf
->
ruÁimed©a
->
wa™_times
[
idx
].
tÙ®_time_sšgË
 +ğ
BILLION
 * (
’d
.
tv_£c
 -

87 
¡¬t
.
tv_£c
) +

88 
’d
.
tv_n£c
 - 
¡¬t
.tv_nsec;

90 
	`__sync_lock_‹¡_ªd_£t
(
lock
, 1))

91 *
lock
);

92 
	`şock_g‘time
(
CLOCK_THREAD_CPUTIME_ID
, &
’d
);

93 
qf
->
ruÁimed©a
->
wa™_times
[
idx
].
tÙ®_time_¥šnšg
 +ğ
BILLION
 * (
’d
.
tv_£c
 -

94 
¡¬t
.
tv_£c
) +

95 
’d
.
tv_n£c
 - 
¡¬t
.tv_nsec;

97 
»t
 = 
Œue
;

99 
qf
->
ruÁimed©a
->
wa™_times
[
idx
].
locks_k’
++;

101  
»t
;

120 
	}
}

126 
šlše
 
boŞ
 
	$qf_¥š_lock
(vŞ©*
lock
, 
ušt8_t
 
æag
)

128 ià(
	`GET_WAIT_FOR_LOCK
(
æag
è!ğ
QF_WAIT_FOR_LOCK
) {

129  !
	`__sync_lock_‹¡_ªd_£t
(
lock
, 1);

131 
	`__sync_lock_‹¡_ªd_£t
(
lock
, 1))

132 *
lock
);

133  
Œue
;

136  
çl£
;

137 
	}
}

140 
šlše
 
	$qf_¥š_uÆock
(vŞ©*
lock
)

142 
	`__sync_lock_»Ëa£
(
lock
);

144 
	}
}

146 
boŞ
 
	$qf_lock
(
QF
 *
qf
, 
ušt64_t
 
hash_buck‘_šdex
, 
boŞ
 
sm®l
, 
ušt8_t


147 
ruÁime_lock
)

149 
ušt64_t
 
hash_buck‘_lock_off£t
 = 
hash_buck‘_šdex
 % 
NUM_SLOTS_TO_LOCK
;

150 ià(
sm®l
) {

151 #ifdeà
LOG_WAIT_TIME


152 ià(!
	`qf_¥š_lock
(
qf
, &qf->
ruÁimed©a
->
locks
[
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
],

153 
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
,

154 
ruÁime_lock
))

155  
çl£
;

156 ià(
NUM_SLOTS_TO_LOCK
 - 
hash_buck‘_lock_off£t
 <ğ
CLUSTER_SIZE
) {

157 ià(!
	`qf_¥š_lock
(
qf
, &qf->
ruÁimed©a
->
locks
[
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
+1],

158 
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
+1,

159 
ruÁime_lock
)) {

160 
	`qf_¥š_uÆock
(&
qf
->
ruÁimed©a
->
locks
[
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
]);

161  
çl£
;

165 ià(!
	`qf_¥š_lock
(&
qf
->
ruÁimed©a
->
locks
[
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
],

166 
ruÁime_lock
))

167  
çl£
;

168 ià(
NUM_SLOTS_TO_LOCK
 - 
hash_buck‘_lock_off£t
 <ğ
CLUSTER_SIZE
) {

169 ià(!
	`qf_¥š_lock
(&
qf
->
ruÁimed©a
->
locks
[
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
+1],

170 
ruÁime_lock
)) {

171 
	`qf_¥š_uÆock
(&
qf
->
ruÁimed©a
->
locks
[
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
]);

172  
çl£
;

177 #ifdeà
LOG_WAIT_TIME


178 ià(
hash_buck‘_šdex
 >ğ
NUM_SLOTS_TO_LOCK
 && 
hash_buck‘_lock_off£t
 <=

179 
CLUSTER_SIZE
) {

180 ià(!
	`qf_¥š_lock
(
qf
,

181 &
qf
->
ruÁimed©a
->
locks
[
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
-1],

182 
ruÁime_lock
))

183  
çl£
;

185 ià(!
	`qf_¥š_lock
(
qf
,

186 &
qf
->
ruÁimed©a
->
locks
[
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
],

187 
ruÁime_lock
)) {

188 ià(
hash_buck‘_šdex
 >ğ
NUM_SLOTS_TO_LOCK
 && 
hash_buck‘_lock_off£t
 <=

189 
CLUSTER_SIZE
)

190 
	`qf_¥š_uÆock
(&
qf
->
ruÁimed©a
->
locks
[
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
-1]);

191  
çl£
;

193 ià(!
	`qf_¥š_lock
(
qf
, &qf->
ruÁimed©a
->
locks
[
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
+1],

194 
ruÁime_lock
)) {

195 
	`qf_¥š_uÆock
(&
qf
->
ruÁimed©a
->
locks
[
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
]);

196 ià(
hash_buck‘_šdex
 >ğ
NUM_SLOTS_TO_LOCK
 && 
hash_buck‘_lock_off£t
 <=

197 
CLUSTER_SIZE
)

198 
	`qf_¥š_uÆock
(&
qf
->
ruÁimed©a
->
locks
[
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
-1]);

199  
çl£
;

202 ià(
hash_buck‘_šdex
 >ğ
NUM_SLOTS_TO_LOCK
 && 
hash_buck‘_lock_off£t
 <=

203 
CLUSTER_SIZE
) {

205 (!
	`qf_¥š_lock
(&
qf
->
ruÁimed©a
->
locks
[
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
-1],

206 
ruÁime_lock
))

207  
çl£
;

209 ià(!
	`qf_¥š_lock
(&
qf
->
ruÁimed©a
->
locks
[
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
],

210 
ruÁime_lock
)) {

211 ià(
hash_buck‘_šdex
 >ğ
NUM_SLOTS_TO_LOCK
 && 
hash_buck‘_lock_off£t
 <=

212 
CLUSTER_SIZE
)

213 
	`qf_¥š_uÆock
(&
qf
->
ruÁimed©a
->
locks
[
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
-1]);

214  
çl£
;

216 ià(!
	`qf_¥š_lock
(&
qf
->
ruÁimed©a
->
locks
[
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
+1],

217 
ruÁime_lock
)) {

218 
	`qf_¥š_uÆock
(&
qf
->
ruÁimed©a
->
locks
[
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
]);

219 ià(
hash_buck‘_šdex
 >ğ
NUM_SLOTS_TO_LOCK
 && 
hash_buck‘_lock_off£t
 <=

220 
CLUSTER_SIZE
)

221 
	`qf_¥š_uÆock
(&
qf
->
ruÁimed©a
->
locks
[
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
-1]);

222  
çl£
;

226  
Œue
;

227 
	}
}

229 
	$qf_uÆock
(
QF
 *
qf
, 
ušt64_t
 
hash_buck‘_šdex
, 
boŞ
 
sm®l
)

231 
ušt64_t
 
hash_buck‘_lock_off£t
 = 
hash_buck‘_šdex
 % 
NUM_SLOTS_TO_LOCK
;

232 ià(
sm®l
) {

233 ià(
NUM_SLOTS_TO_LOCK
 - 
hash_buck‘_lock_off£t
 <ğ
CLUSTER_SIZE
) {

234 
	`qf_¥š_uÆock
(&
qf
->
ruÁimed©a
->
locks
[
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
+1]);

236 
	`qf_¥š_uÆock
(&
qf
->
ruÁimed©a
->
locks
[
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
]);

238 
	`qf_¥š_uÆock
(&
qf
->
ruÁimed©a
->
locks
[
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
+1]);

239 
	`qf_¥š_uÆock
(&
qf
->
ruÁimed©a
->
locks
[
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
]);

240 ià(
hash_buck‘_šdex
 >ğ
NUM_SLOTS_TO_LOCK
 && 
hash_buck‘_lock_off£t
 <=

241 
CLUSTER_SIZE
)

242 
	`qf_¥š_uÆock
(&
qf
->
ruÁimed©a
->
locks
[
hash_buck‘_šdex
/
NUM_SLOTS_TO_LOCK
-1]);

244 
	}
}

259 
	$modify_m‘ad©a
(
pc_t
 *
m‘ad©a
, 
út
)

261 
	`pc_add
(
m‘ad©a
, 
út
);

263 
	}
}

265 
šlše
 
	$pİút
(
ušt64_t
 
v®
)

267 
	`asm
("popcnt %[val], %[val]"

268 : [
v®
] "+r" (val)

271  
v®
;

272 
	}
}

274 
šlše
 
št64_t
 
	$b™sÿÄev”£
(
ušt64_t
 
v®
)

276 ià(
v®
 == 0) {

279 
	`asm
("bsr %[val], %[val]"

280 : [
v®
] "+r" (val)

283  
v®
;

285 
	}
}

287 
šlše
 
	$pİútv
(cÚ¡ 
ušt64_t
 
v®
, 
ignÜe
)

289 ià(
ignÜe
 % 64)

290  
	`pİút
 (
v®
 & ~
	`BITMASK
(
ignÜe
 % 64));

292  
	`pİút
(
v®
);

293 
	}
}

297 
šlše
 
	$b™¿nk
(
ušt64_t
 
v®
, 
pos
) {

298 
v®
 = v® & ((2ULL << 
pos
) - 1);

299 
	`asm
("popcnt %[val], %[val]"

300 : [
v®
] "+r" (val)

303  
v®
;

304 
	}
}

323 cÚ¡ 
ušt8_t
 
	gkS–eùInBy‹
[2048] = {

405 
šlše
 
ušt64_t
 
	$_£Ëù64
(
ušt64_t
 
x
, 
k
)

407 ià(
k
 >ğ
	`pİút
(
x
)) {  64; }

409 cÚ¡ 
ušt64_t
 
kOÃsS‹p4
 = 0x1111111111111111ULL;

410 cÚ¡ 
ušt64_t
 
kOÃsS‹p8
 = 0x0101010101010101ULL;

411 cÚ¡ 
ušt64_t
 
kMSBsS‹p8
 = 0x80ULL * 
kOÃsS‹p8
;

413 
ušt64_t
 
s
 = 
x
;

414 
s
 = s - (( & 0xA * 
kOÃsS‹p4
) >> 1);

415 
s
 = ( & 0x3 * 
kOÃsS‹p4
) + ((s >> 2) & 0x3 * kOnesStep4);

416 
s
 = ( + ( >> 4)è& 0xF * 
kOÃsS‹p8
;

417 
ušt64_t
 
by‹Sums
 = 
s
 * 
kOÃsS‹p8
;

419 
ušt64_t
 
kS‹p8
 = 
k
 * 
kOÃsS‹p8
;

420 
ušt64_t
 
geqKS‹p8
 = (((
kS‹p8
 | 
kMSBsS‹p8
è- 
by‹Sums
) & kMSBsStep8);

421 
ušt64_t
 
¶aû
 = 
	`pİút
(
geqKS‹p8
) * 8;

422 
ušt64_t
 
by‹Rªk
 = 
k
 - (((
by‹Sums
 << 8è>> 
¶aû
) & (uint64_t)(0xFF));

423  
¶aû
 + 
kS–eùInBy‹
[((
x
 >>…Ïûè& 0xFFè| (
by‹Rªk
 << 8)];

424 
	}
}

428 
šlše
 
ušt64_t
 
	$b™£Ëù
(
ušt64_t
 
v®
, 
¿nk
) {

429 #ifdeà
__SSE4_2_


430 
ušt64_t
 
i
 = 1ULL << 
¿nk
;

431 
	`asm
("pdep %[val], %[mask], %[val]"

432 : [
v®
] "+r" (val)

433 : [
mask
] "r" (
i
));

434 
	`asm
("tzcnt %[bit], %[index]"

435 : [
šdex
] "ô" (
i
)

436 : [
b™
] "g" (
v®
)

438  
i
;

440  
	`_£Ëù64
(
v®
, 
¿nk
);

441 
	}
}

443 
šlše
 
ušt64_t
 
	$b™£Ëùv
(cÚ¡ 
ušt64_t
 
v®
, 
ignÜe
, 
¿nk
)

445  
	`b™£Ëù
(
v®
 & ~
	`BITMASK
(
ignÜe
 % 64), 
¿nk
);

446 
	}
}

448 
šlše
 
	$is_ruÃnd
(cÚ¡ 
QF
 *
qf
, 
ušt64_t
 
šdex
)

450  (
	`METADATA_WORD
(
qf
, 
ruÃnds
, 
šdex
è>> ((šdex % 
QF_SLOTS_PER_BLOCK
) %

452 
	}
}

454 
šlše
 
	$is_occup›d
(cÚ¡ 
QF
 *
qf
, 
ušt64_t
 
šdex
)

456  (
	`METADATA_WORD
(
qf
, 
occup›ds
, 
šdex
è>> ((šdex % 
QF_SLOTS_PER_BLOCK
) %

458 
	}
}

460 #ià
QF_BITS_PER_SLOT
 == 8 || QF_BITS_PER_SLOT == 16 || QF_BITS_PER_SLOT == 32 || QF_BITS_PER_SLOT == 64

462 
šlše
 
ušt64_t
 
	$g‘_¦Ù
(cÚ¡ 
QF
 *
qf
, 
ušt64_t
 
šdex
)

464 
	`as£¹
(
šdex
 < 
qf
->
m‘ad©a
->
xn¦Ùs
);

465  
	`g‘_block
(
qf
, 
šdex
 / 
QF_SLOTS_PER_BLOCK
)->
¦Ùs
[index % QF_SLOTS_PER_BLOCK];

466 
	}
}

468 
šlše
 
	$£t_¦Ù
(cÚ¡ 
QF
 *
qf
, 
ušt64_t
 
šdex
, ušt64_ˆ
v®ue
)

470 
	`as£¹
(
šdex
 < 
qf
->
m‘ad©a
->
xn¦Ùs
);

471 
	`g‘_block
(
qf
, 
šdex
 / 
QF_SLOTS_PER_BLOCK
)->
¦Ùs
[index % QF_SLOTS_PER_BLOCK] =

472 
v®ue
 & 
	`BITMASK
(
qf
->
m‘ad©a
->
b™s_³r_¦Ù
);

473 
	}
}

475 #–ià
QF_BITS_PER_SLOT
 > 0

479 
šlše
 
ušt64_t
 
	$g‘_¦Ù
(cÚ¡ 
QF
 *
qf
, 
ušt64_t
 
šdex
)

483 
	`as£¹
(
šdex
 < 
qf
->
m‘ad©a
->
xn¦Ùs
);

484 
ušt64_t
 *
p
 = (ušt64_ˆ*)&
	`g‘_block
(
qf
, 
šdex
 /

485 
QF_SLOTS_PER_BLOCK
)->
¦Ùs
[(
šdex
 %

486 
QF_SLOTS_PER_BLOCK
)

487 * 
QF_BITS_PER_SLOT
 / 8];

488  (
ušt64_t
)(((*
p
è>> (((
šdex
 % 
QF_SLOTS_PER_BLOCK
è* 
QF_BITS_PER_SLOT
) %

489 8)è& 
	`BITMASK
(
QF_BITS_PER_SLOT
));

490 
	}
}

492 
šlše
 
	$£t_¦Ù
(cÚ¡ 
QF
 *
qf
, 
ušt64_t
 
šdex
, ušt64_ˆ
v®ue
)

496 
	`as£¹
(
šdex
 < 
qf
->
m‘ad©a
->
xn¦Ùs
);

497 
ušt64_t
 *
p
 = (ušt64_ˆ*)&
	`g‘_block
(
qf
, 
šdex
 /

498 
QF_SLOTS_PER_BLOCK
)->
¦Ùs
[(
šdex
 %

499 
QF_SLOTS_PER_BLOCK
)

500 * 
QF_BITS_PER_SLOT
 / 8];

501 
ušt64_t
 
t
 = *
p
;

502 
ušt64_t
 
mask
 = 
	`BITMASK
(
QF_BITS_PER_SLOT
);

503 
ušt64_t
 
v
 = 
v®ue
;

504 
shiá
 = ((
šdex
 % 
QF_SLOTS_PER_BLOCK
è* 
QF_BITS_PER_SLOT
) % 8;

505 
mask
 <<ğ
shiá
;

506 
v
 <<ğ
shiá
;

507 
t
 &ğ~
mask
;

508 
t
 |ğ
v
;

509 *
p
 = 
t
;

510 
	}
}

516 
šlše
 
ušt64_t
 
	$g‘_¦Ù
(cÚ¡ 
QF
 *
qf
, 
ušt64_t
 
šdex
)

518 
	`as£¹
(
šdex
 < 
qf
->
m‘ad©a
->
xn¦Ùs
);

521 
ušt64_t
 *
p
 = (ušt64_ˆ*)&
	`g‘_block
(
qf
, 
šdex
 /

522 
QF_SLOTS_PER_BLOCK
)->
¦Ùs
[(
šdex
 %

523 
QF_SLOTS_PER_BLOCK
)

524 * 
qf
->
m‘ad©a
->
b™s_³r_¦Ù
 / 8];

525  (
ušt64_t
)(((*
p
è>> (((
šdex
 % 
QF_SLOTS_PER_BLOCK
) *

526 
qf
->
m‘ad©a
->
b™s_³r_¦Ù
) % 8)) &

527 
	`BITMASK
(
qf
->
m‘ad©a
->
b™s_³r_¦Ù
));

528 
	}
}

530 
šlše
 
	$£t_¦Ù
(cÚ¡ 
QF
 *
qf
, 
ušt64_t
 
šdex
, ušt64_ˆ
v®ue
)

532 
	`as£¹
(
šdex
 < 
qf
->
m‘ad©a
->
xn¦Ùs
);

535 
ušt64_t
 *
p
 = (ušt64_ˆ*)&
	`g‘_block
(
qf
, 
šdex
 /

536 
QF_SLOTS_PER_BLOCK
)->
¦Ùs
[(
šdex
 %

537 
QF_SLOTS_PER_BLOCK
)

538 * 
qf
->
m‘ad©a
->
b™s_³r_¦Ù
 / 8];

539 
ušt64_t
 
t
 = *
p
;

540 
ušt64_t
 
mask
 = 
	`BITMASK
(
qf
->
m‘ad©a
->
b™s_³r_¦Ù
);

541 
ušt64_t
 
v
 = 
v®ue
;

542 
shiá
 = ((
šdex
 % 
QF_SLOTS_PER_BLOCK
è* 
qf
->
m‘ad©a
->
b™s_³r_¦Ù
) % 8;

543 
mask
 <<ğ
shiá
;

544 
v
 <<ğ
shiá
;

545 
t
 &ğ~
mask
;

546 
t
 |ğ
v
;

547 *
p
 = 
t
;

548 
	}
}

552 
šlše
 
ušt64_t
 
run_’d
(cÚ¡ 
QF
 *
qf
, ušt64_ˆ
hash_buck‘_šdex
);

554 
šlše
 
ušt64_t
 
	$block_off£t
(cÚ¡ 
QF
 *
qf
, 
ušt64_t
 
blockidx
)

559 ià((
qf
->
blocks
[0].
off£t
) > 1 ||

560 
	`g‘_block
(
qf
, 
blockidx
)->
off£t
 < 
	`BITMASK
(8*(qf->
blocks
[0].offset)))

561  
	`g‘_block
(
qf
, 
blockidx
)->
off£t
;

563  
	`run_’d
(
qf
, 
QF_SLOTS_PER_BLOCK
 * 
blockidx
 - 1) - QF_SLOTS_PER_BLOCK *

564 
blockidx
 + 1;

565 
	}
}

567 
šlše
 
ušt64_t
 
	$run_’d
(cÚ¡ 
QF
 *
qf
, 
ušt64_t
 
hash_buck‘_šdex
)

569 
ušt64_t
 
buck‘_block_šdex
 = 
hash_buck‘_šdex
 / 
QF_SLOTS_PER_BLOCK
;

570 
ušt64_t
 
buck‘_šŒablock_off£t
 = 
hash_buck‘_šdex
 % 
QF_SLOTS_PER_BLOCK
;

571 
ušt64_t
 
buck‘_blocks_off£t
 = 
	`block_off£t
(
qf
, 
buck‘_block_šdex
);

573 
ušt64_t
 
buck‘_šŒablock_¿nk
 = 
	`b™¿nk
(
	`g‘_block
(
qf
,

574 
buck‘_block_šdex
)->
occup›ds
[0],

575 
buck‘_šŒablock_off£t
);

577 ià(
buck‘_šŒablock_¿nk
 == 0) {

578 ià(
buck‘_blocks_off£t
 <ğ
buck‘_šŒablock_off£t
)

579  
hash_buck‘_šdex
;

581  
QF_SLOTS_PER_BLOCK
 * 
buck‘_block_šdex
 + 
buck‘_blocks_off£t
 - 1;

584 
ušt64_t
 
ruÃnd_block_šdex
 = 
buck‘_block_šdex
 + 
buck‘_blocks_off£t
 /

585 
QF_SLOTS_PER_BLOCK
;

586 
ušt64_t
 
ruÃnd_ignÜe_b™s
 = 
buck‘_blocks_off£t
 % 
QF_SLOTS_PER_BLOCK
;

587 
ušt64_t
 
ruÃnd_¿nk
 = 
buck‘_šŒablock_¿nk
 - 1;

588 
ušt64_t
 
ruÃnd_block_off£t
 = 
	`b™£Ëùv
(
	`g‘_block
(
qf
,

589 
ruÃnd_block_šdex
)->
ruÃnds
[0],

590 
ruÃnd_ignÜe_b™s
, 
ruÃnd_¿nk
);

591 ià(
ruÃnd_block_off£t
 =ğ
QF_SLOTS_PER_BLOCK
) {

592 ià(
buck‘_blocks_off£t
 =ğ0 && 
buck‘_šŒablock_¿nk
 == 0) {

595  
hash_buck‘_šdex
;

598 
ruÃnd_¿nk
 -ğ
	`pİútv
(
	`g‘_block
(
qf
,

599 
ruÃnd_block_šdex
)->
ruÃnds
[0],

600 
ruÃnd_ignÜe_b™s
);

601 
ruÃnd_block_šdex
++;

602 
ruÃnd_ignÜe_b™s
 = 0;

603 
ruÃnd_block_off£t
 = 
	`b™£Ëùv
(
	`g‘_block
(
qf
,

604 
ruÃnd_block_šdex
)->
ruÃnds
[0],

605 
ruÃnd_ignÜe_b™s
, 
ruÃnd_¿nk
);

606 } 
ruÃnd_block_off£t
 =ğ
QF_SLOTS_PER_BLOCK
);

610 
ušt64_t
 
ruÃnd_šdex
 = 
QF_SLOTS_PER_BLOCK
 * 
ruÃnd_block_šdex
 +

611 
ruÃnd_block_off£t
;

612 ià(
ruÃnd_šdex
 < 
hash_buck‘_šdex
)

613  
hash_buck‘_šdex
;

615  
ruÃnd_šdex
;

616 
	}
}

618 
šlše
 
	$off£t_low”_bound
(cÚ¡ 
QF
 *
qf
, 
ušt64_t
 
¦Ù_šdex
)

620 cÚ¡ 
qfblock
 * 
b
 = 
	`g‘_block
(
qf
, 
¦Ù_šdex
 / 
QF_SLOTS_PER_BLOCK
);

621 cÚ¡ 
ušt64_t
 
¦Ù_off£t
 = 
¦Ù_šdex
 % 
QF_SLOTS_PER_BLOCK
;

622 cÚ¡ 
ušt64_t
 
boff£t
 = 
b
->
off£t
;

623 cÚ¡ 
ušt64_t
 
occup›ds
 = 
b
->occup›ds[0] & 
	`BITMASK
(
¦Ù_off£t
+1);

624 
	`as£¹
(
QF_SLOTS_PER_BLOCK
 == 64);

625 ià(
boff£t
 <ğ
¦Ù_off£t
) {

626 cÚ¡ 
ušt64_t
 
ruÃnds
 = (
b
->ruÃnds[0] & 
	`BITMASK
(
¦Ù_off£t
)è>> 
boff£t
;

627  
	`pİút
(
occup›ds
è-…İút(
ruÃnds
);

629  
boff£t
 - 
¦Ù_off£t
 + 
	`pİút
(
occup›ds
);

630 
	}
}

632 
šlše
 
	$is_em±y
(cÚ¡ 
QF
 *
qf
, 
ušt64_t
 
¦Ù_šdex
)

634  
	`off£t_low”_bound
(
qf
, 
¦Ù_šdex
) == 0;

635 
	}
}

637 
šlše
 
	$might_be_em±y
(cÚ¡ 
QF
 *
qf
, 
ušt64_t
 
¦Ù_šdex
)

639  !
	`is_occup›d
(
qf
, 
¦Ù_šdex
)

640 && !
	`is_ruÃnd
(
qf
, 
¦Ù_šdex
);

641 
	}
}

643 
šlše
 
	$´obably_is_em±y
(cÚ¡ 
QF
 *
qf
, 
ušt64_t
 
¦Ù_šdex
)

645  
	`g‘_¦Ù
(
qf
, 
¦Ù_šdex
) == 0

646 && !
	`is_occup›d
(
qf
, 
¦Ù_šdex
)

647 && !
	`is_ruÃnd
(
qf
, 
¦Ù_šdex
);

648 
	}
}

650 
šlše
 
ušt64_t
 
	$fšd_fœ¡_em±y_¦Ù
(
QF
 *
qf
, 
ušt64_t
 
äom
)

653 
t
 = 
	`off£t_low”_bound
(
qf
, 
äom
);

654 
	`as£¹
(
t
>=0);

655 ià(
t
 == 0)

657 
äom
 = from + 
t
;

659  
äom
;

660 
	}
}

662 
šlše
 
ušt64_t
 
	$shiá_što_b
(cÚ¡ 
ušt64_t
 
a
, cÚ¡ ušt64_ˆ
b
,

663 cÚ¡ 
b¡¬t
, cÚ¡ 
b’d
,

664 cÚ¡ 
amouÁ
)

666 cÚ¡ 
ušt64_t
 
a_compÚ’t
 = 
b¡¬t
 =ğ0 ? (
a
 >> (64 - 
amouÁ
)) : 0;

667 cÚ¡ 
ušt64_t
 
b_shiáed_mask
 = 
	`BITMASK
(
b’d
 - 
b¡¬t
) << bstart;

668 cÚ¡ 
ušt64_t
 
b_shiáed
 = ((
b_shiáed_mask
 & 
b
è<< 
amouÁ
) & b_shifted_mask;

669 cÚ¡ 
ušt64_t
 
b_mask
 = ~
b_shiáed_mask
;

670  
a_compÚ’t
 | 
b_shiáed
 | (
b
 & 
b_mask
);

671 
	}
}

673 #ià
QF_BITS_PER_SLOT
 == 8 || QF_BITS_PER_SLOT == 16 || QF_BITS_PER_SLOT == 32 || QF_BITS_PER_SLOT == 64

675 
šlše
 
	$shiá_»mašd”s
(
QF
 *
qf
, 
ušt64_t
 
¡¬t_šdex
, uint64_t

676 
em±y_šdex
)

678 
ušt64_t
 
¡¬t_block
 = 
¡¬t_šdex
 / 
QF_SLOTS_PER_BLOCK
;

679 
ušt64_t
 
¡¬t_off£t
 = 
¡¬t_šdex
 % 
QF_SLOTS_PER_BLOCK
;

680 
ušt64_t
 
em±y_block
 = 
em±y_šdex
 / 
QF_SLOTS_PER_BLOCK
;

681 
ušt64_t
 
em±y_off£t
 = 
em±y_šdex
 % 
QF_SLOTS_PER_BLOCK
;

683 
	`as£¹
 (
¡¬t_šdex
 <ğ
em±y_šdex
 &&ƒm±y_šdex < 
qf
->
m‘ad©a
->
xn¦Ùs
);

685 
¡¬t_block
 < 
em±y_block
) {

686 
	`memmove
(&
	`g‘_block
(
qf
, 
em±y_block
)->
¦Ùs
[1],

687 &
	`g‘_block
(
qf
, 
em±y_block
)->
¦Ùs
[0],

688 
em±y_off£t
 * (
qf
->
blocks
[0].
¦Ùs
[0]));

689 
	`g‘_block
(
qf
, 
em±y_block
)->
¦Ùs
[0] = get_block(qf,

690 
em±y_block
-1)->
¦Ùs
[
QF_SLOTS_PER_BLOCK
-1];

691 
em±y_block
--;

692 
em±y_off£t
 = 
QF_SLOTS_PER_BLOCK
-1;

695 
	`memmove
(&
	`g‘_block
(
qf
, 
em±y_block
)->
¦Ùs
[
¡¬t_off£t
+1],

696 &
	`g‘_block
(
qf
, 
em±y_block
)->
¦Ùs
[
¡¬t_off£t
],

697 (
em±y_off£t
 - 
¡¬t_off£t
è* (
qf
->
blocks
[0].
¦Ùs
[0]));

698 
	}
}

702 
	#REMAINDER_WORD
(
qf
, 
i
è((
ušt64_t
 *)&(
	`g‘_block
(qf, (i)/qf->
m‘ad©a
->
b™s_³r_¦Ù
)->
¦Ùs
[8 * ((iè% qf->m‘ad©a->b™s_³r_¦Ù)]))

	)

704 
šlše
 
	$shiá_»mašd”s
(
QF
 *
qf
, cÚ¡ 
ušt64_t
 
¡¬t_šdex
, const

705 
ušt64_t
 
em±y_šdex
)

707 
ušt64_t
 
Ï¡_wÜd
 = (
em±y_šdex
 + 1è* 
qf
->
m‘ad©a
->
b™s_³r_¦Ù
 / 64;

708 cÚ¡ 
ušt64_t
 
fœ¡_wÜd
 = 
¡¬t_šdex
 * 
qf
->
m‘ad©a
->
b™s_³r_¦Ù
 / 64;

709 
b’d
 = ((
em±y_šdex
 + 1è* 
qf
->
m‘ad©a
->
b™s_³r_¦Ù
) % 64;

710 cÚ¡ 
b¡¬t
 = (
¡¬t_šdex
 * 
qf
->
m‘ad©a
->
b™s_³r_¦Ù
) % 64;

712 
Ï¡_wÜd
 !ğ
fœ¡_wÜd
) {

713 *
	`REMAINDER_WORD
(
qf
, 
Ï¡_wÜd
èğ
	`shiá_što_b
(*REMAINDER_WORD(qf,†ast_word-1),

714 *
	`REMAINDER_WORD
(
qf
, 
Ï¡_wÜd
),

715 0, 
b’d
, 
qf
->
m‘ad©a
->
b™s_³r_¦Ù
);

716 
Ï¡_wÜd
--;

717 
b’d
 = 64;

719 *
	`REMAINDER_WORD
(
qf
, 
Ï¡_wÜd
èğ
	`shiá_što_b
(0, *REMAINDER_WORD(qf,

720 
Ï¡_wÜd
),

721 
b¡¬t
, 
b’d
,

722 
qf
->
m‘ad©a
->
b™s_³r_¦Ù
);

723 
	}
}

727 
šlše
 
	$qf_dump_block
(cÚ¡ 
QF
 *
qf
, 
ušt64_t
 
i
)

729 
ušt64_t
 
j
;

731 
	`´štf
("%-192d", 
	`g‘_block
(
qf
, 
i
)->
off£t
);

732 
	`´štf
("\n");

734 
j
 = 0; j < 
QF_SLOTS_PER_BLOCK
; j++)

735 
	`´štf
("%02lx ", 
j
);

736 
	`´štf
("\n");

738 
j
 = 0; j < 
QF_SLOTS_PER_BLOCK
; j++)

739 
	`´štf
(" %d ", (
	`g‘_block
(
qf
, 
i
)->
occup›ds
[
j
/64] & (1ULL << (j%64))) ? 1 : 0);

740 
	`´štf
("\n");

742 
j
 = 0; j < 
QF_SLOTS_PER_BLOCK
; j++)

743 
	`´štf
(" %d ", (
	`g‘_block
(
qf
, 
i
)->
ruÃnds
[
j
/64] & (1ULL << (j%64))) ? 1 : 0);

744 
	`´štf
("\n");

746 #ià
QF_BITS_PER_SLOT
 == 8 || QF_BITS_PER_SLOT == 16 || QF_BITS_PER_SLOT == 32

747 
j
 = 0; j < 
QF_SLOTS_PER_BLOCK
; j++)

748 
	`´štf
("%02x ", 
	`g‘_block
(
qf
, 
i
)->
¦Ùs
[
j
]);

749 #–ià
QF_BITS_PER_SLOT
 == 64

750 
j
 = 0; j < 
QF_SLOTS_PER_BLOCK
; j++)

751 
	`´štf
("%02lx ", 
	`g‘_block
(
qf
, 
i
)->
¦Ùs
[
j
]);

753 
j
 = 0; j < 
QF_SLOTS_PER_BLOCK
 * 
qf
->
m‘ad©a
->
b™s_³r_¦Ù
 / 8; j++)

754 
	`´štf
("%02x ", 
	`g‘_block
(
qf
, 
i
)->
¦Ùs
[
j
]);

757 
	`´štf
("\n");

759 
	`´štf
("\n");

760 
	}
}

762 
	$qf_dump_m‘ad©a
(cÚ¡ 
QF
 *
qf
) {

763 
	`´štf
("Slots: %lu Occupied: %lu Elements: %lu Distinct: %lu\n",

764 
qf
->
m‘ad©a
->
n¦Ùs
,

765 
qf
->
m‘ad©a
->
noccup›d_¦Ùs
,

766 
qf
->
m‘ad©a
->
ÃÉs
,

767 
qf
->
m‘ad©a
->
ndi¡šù_–ts
);

768 
	`´štf
("Key_bits: %lu Value_bits: %lu Remainder_bits: %lu Bits_per_slot: %lu\n",

769 
qf
->
m‘ad©a
->
key_b™s
,

770 
qf
->
m‘ad©a
->
v®ue_b™s
,

771 
qf
->
m‘ad©a
->
key_»mašd”_b™s
,

772 
qf
->
m‘ad©a
->
b™s_³r_¦Ù
);

773 
	}
}

775 
	$qf_dump
(cÚ¡ 
QF
 *
qf
)

777 
ušt64_t
 
i
;

779 
	`´štf
("%lu %lu %lu\n",

780 
qf
->
m‘ad©a
->
nblocks
,

781 
qf
->
m‘ad©a
->
ndi¡šù_–ts
,

782 
qf
->
m‘ad©a
->
ÃÉs
);

784 
i
 = 0; i < 
qf
->
m‘ad©a
->
nblocks
; i++) {

785 
	`qf_dump_block
(
qf
, 
i
);

788 
	}
}

790 
šlše
 
	$fšd_Ãxt_n_em±y_¦Ùs
(
QF
 *
qf
, 
ušt64_t
 
äom
, ušt64_ˆ
n
,

791 
ušt64_t
 *
šdiûs
)

793 
n
) {

794 
šdiûs
[--
n
] = 
	`fšd_fœ¡_em±y_¦Ù
(
qf
, 
äom
);

795 
äom
 = 
šdiûs
[
n
] + 1;

797 
	}
}

799 
šlše
 
	$shiá_¦Ùs
(
QF
 *
qf
, 
št64_t
 
fœ¡
, 
ušt64_t
 
Ï¡
, uint64_t

800 
di¡ªû
)

802 
št64_t
 
i
;

803 ià(
di¡ªû
 == 1)

804 
	`shiá_»mašd”s
(
qf
, 
fœ¡
, 
Ï¡
+1);

806 
i
 = 
Ï¡
; i >ğ
fœ¡
; i--)

807 
	`£t_¦Ù
(
qf
, 
i
 + 
di¡ªû
, 
	`g‘_¦Ù
(qf, i));

808 
	}
}

810 
šlše
 
	$shiá_ruÃnds
(
QF
 *
qf
, 
št64_t
 
fœ¡
, 
ušt64_t
 
Ï¡
,

811 
ušt64_t
 
di¡ªû
)

813 
	`as£¹
(
Ï¡
 < 
qf
->
m‘ad©a
->
xn¦Ùs
 && 
di¡ªû
 < 64);

814 
ušt64_t
 
fœ¡_wÜd
 = 
fœ¡
 / 64;

815 
ušt64_t
 
b¡¬t
 = 
fœ¡
 % 64;

816 
ušt64_t
 
Ï¡_wÜd
 = (
Ï¡
 + 
di¡ªû
 + 1) / 64;

817 
ušt64_t
 
b’d
 = (
Ï¡
 + 
di¡ªû
 + 1) % 64;

819 ià(
Ï¡_wÜd
 !ğ
fœ¡_wÜd
) {

820 
	`METADATA_WORD
(
qf
, 
ruÃnds
, 64*
Ï¡_wÜd
èğ
	`shiá_što_b
(METADATA_WORD(qf,„unends, 64*(last_word-1)),

821 
	`METADATA_WORD
(
qf
, 
ruÃnds
, 64*
Ï¡_wÜd
),

822 0, 
b’d
, 
di¡ªû
);

823 
b’d
 = 64;

824 
Ï¡_wÜd
--;

825 
Ï¡_wÜd
 !ğ
fœ¡_wÜd
) {

826 
	`METADATA_WORD
(
qf
, 
ruÃnds
, 64*
Ï¡_wÜd
èğ
	`shiá_što_b
(METADATA_WORD(qf,„unends, 64*(last_word-1)),

827 
	`METADATA_WORD
(
qf
, 
ruÃnds
, 64*
Ï¡_wÜd
),

828 0, 
b’d
, 
di¡ªû
);

829 
Ï¡_wÜd
--;

832 
	`METADATA_WORD
(
qf
, 
ruÃnds
, 64*
Ï¡_wÜd
èğ
	`shiá_što_b
(0, METADATA_WORD(qf,

833 
ruÃnds
,

834 64*
Ï¡_wÜd
),

835 
b¡¬t
, 
b’d
, 
di¡ªû
);

837 
	}
}

839 
šlše
 
boŞ
 
	$š£¹_»¶aû_¦Ùs_ªd_shiá_»mašd”s_ªd_ruÃnds_ªd_off£ts
(
QF
 *
qf
,

840 
İ”©iÚ
,

841 
ušt64_t
 
buck‘_šdex
,

842 
ušt64_t
 
ov”wr™e_šdex
,

843 cÚ¡ 
ušt64_t
 *
»mašd”s
,

844 
ušt64_t
 
tÙ®_»mašd”s
,

845 
ušt64_t
 
nov”wr™es
)

847 
ušt64_t
 
em±›s
[67];

848 
ušt64_t
 
i
;

849 
št64_t
 
j
;

850 
št64_t
 
nš£¹s
 = 
tÙ®_»mašd”s
 - 
nov”wr™es
;

851 
ušt64_t
 
š£¹_šdex
 = 
ov”wr™e_šdex
 + 
nov”wr™es
;

853 ià(
nš£¹s
 > 0) {

855 
	`fšd_Ãxt_n_em±y_¦Ùs
(
qf
, 
š£¹_šdex
, 
nš£¹s
, 
em±›s
);

856 ià(
em±›s
[0] >ğ
qf
->
m‘ad©a
->
xn¦Ùs
) {

857  
çl£
;

859 
j
 = 0; j < 
nš£¹s
 - 1; j++)

860 
	`shiá_¦Ùs
(
qf
, 
em±›s
[
j
+1] + 1,ƒmpties[j] - 1, j + 1);

861 
	`shiá_¦Ùs
(
qf
, 
š£¹_šdex
, 
em±›s
[
nš£¹s
 - 1] - 1,‚inserts);

863 
j
 = 0; j < 
nš£¹s
 - 1; j++)

864 
	`shiá_ruÃnds
(
qf
, 
em±›s
[
j
+1] + 1,ƒmpties[j] - 1, j + 1);

865 
	`shiá_ruÃnds
(
qf
, 
š£¹_šdex
, 
em±›s
[
nš£¹s
 - 1] - 1,‚inserts);

867 
i
 = 
nov”wr™es
; i < 
tÙ®_»mašd”s
 - 1; i++)

868 
	`METADATA_WORD
(
qf
, 
ruÃnds
, 
ov”wr™e_šdex
 + 
i
) &= ~(1ULL <<

869 (((
ov”wr™e_šdex


870 + 
i
) %

871 
QF_SLOTS_PER_BLOCK
)

874 
İ”©iÚ
) {

876 
	`as£¹
 (
nov”wr™es
 == 0);

877 
	`METADATA_WORD
(
qf
, 
ruÃnds
, 
ov”wr™e_šdex
 + 
tÙ®_»mašd”s
 - 1) |=

878 1ULL << (((
ov”wr™e_šdex
 + 
tÙ®_»mašd”s
 - 1) %

879 
QF_SLOTS_PER_BLOCK
) % 64);

882 
	`METADATA_WORD
(
qf
, 
ruÃnds
, 
ov”wr™e_šdex
 + 
nov”wr™es
 - 1) &=

883 ~(1ULL << (((
ov”wr™e_šdex
 + 
nov”wr™es
 - 1è% 
QF_SLOTS_PER_BLOCK
) %

885 
	`METADATA_WORD
(
qf
, 
ruÃnds
, 
ov”wr™e_šdex
 + 
tÙ®_»mašd”s
 - 1) |=

886 1ULL << (((
ov”wr™e_šdex
 + 
tÙ®_»mašd”s
 - 1) %

887 
QF_SLOTS_PER_BLOCK
) % 64);

890 
	`METADATA_WORD
(
qf
, 
ruÃnds
, 
ov”wr™e_šdex
 + 
tÙ®_»mašd”s
 - 1) &=

891 ~(1ULL << (((
ov”wr™e_šdex
 + 
tÙ®_»mašd”s
 - 1) %

892 
QF_SLOTS_PER_BLOCK
) % 64));

895 
	`årštf
(
¡d”r
, "Inv®id o³¿tiÚ %d\n", 
İ”©iÚ
);

896 
	`abÜt
();

899 
ušt64_t
 
Å»ûdšg_em±›s
 = 0;

900 
i
 = 
buck‘_šdex
 / 
QF_SLOTS_PER_BLOCK
 + 1; i <ğ
em±›s
[0]/QF_SLOTS_PER_BLOCK; i++) {

901 (
št64_t
)
Å»ûdšg_em±›s
 < 
nš£¹s
 &&

902 
em±›s
[
nš£¹s
 - 1 - 
Å»ûdšg_em±›s
] / 
QF_SLOTS_PER_BLOCK
 < 
i
)

903 
Å»ûdšg_em±›s
++;

905 ià(
	`g‘_block
(
qf
, 
i
)->
off£t
 + 
nš£¹s
 - 
Å»ûdšg_em±›s
 < 
	`BITMASK
(8*(qf->
blocks
[0].offset)))

906 
	`g‘_block
(
qf
, 
i
)->
off£t
 +ğ
nš£¹s
 - 
Å»ûdšg_em±›s
;

908 
	`g‘_block
(
qf
, 
i
)->
off£t
 = (
ušt8_t
è
	`BITMASK
(8*(qf->
blocks
[0].offset));

912 
i
 = 0; i < 
tÙ®_»mašd”s
; i++)

913 
	`£t_¦Ù
(
qf
, 
ov”wr™e_šdex
 + 
i
, 
»mašd”s
[i]);

915 
	`modify_m‘ad©a
(&
qf
->
ruÁimed©a
->
pc_noccup›d_¦Ùs
, 
nš£¹s
);

917  
Œue
;

918 
	}
}

920 
šlše
 
	$»move_»¶aû_¦Ùs_ªd_shiá_»mašd”s_ªd_ruÃnds_ªd_off£ts
(
QF
 *
qf
,

921 
İ”©iÚ
,

922 
ušt64_t
 
buck‘_šdex
,

923 
ušt64_t
 
ov”wr™e_šdex
,

924 cÚ¡ 
ušt64_t
 *
»mašd”s
,

925 
ušt64_t
 
tÙ®_»mašd”s
,

926 
ušt64_t
 
Şd_Ëngth
)

928 
ušt64_t
 
i
;

931 
i
 = 0; i < 
tÙ®_»mašd”s
; i++)

932 
	`£t_¦Ù
(
qf
, 
ov”wr™e_šdex
 + 
i
, 
»mašd”s
[i]);

935 ià(
	`is_ruÃnd
(
qf
, 
ov”wr™e_šdex
 + 
Şd_Ëngth
 - 1)) {

936 ià(
tÙ®_»mašd”s
 > 0) {

938 
	`METADATA_WORD
(
qf
, 
ruÃnds
, 
ov”wr™e_šdex
 + 
tÙ®_»mašd”s
 - 1) |= 1ULL << ((overwrite_index +otal_remainders - 1) % 64);

939 } ià(
ov”wr™e_šdex
 > 
buck‘_šdex
 &&

940 !
	`is_ruÃnd
(
qf
, 
ov”wr™e_šdex
 - 1)) {

943 
	`METADATA_WORD
(
qf
, 
ruÃnds
, 
ov”wr™e_šdex
 - 1) |= 1ULL << ((overwrite_index - 1) % 64);

948 
ušt64_t
 
Üigš®_buck‘
 = 
buck‘_šdex
;

949 
ušt64_t
 
cu¼’t_buck‘
 = 
buck‘_šdex
;

950 
ušt64_t
 
cu¼’t_¦Ù
 = 
ov”wr™e_šdex
 + 
tÙ®_»mašd”s
;

951 
ušt64_t
 
cu¼’t_di¡ªû
 = 
Şd_Ëngth
 - 
tÙ®_»mašd”s
;

952 
»t_cu¼’t_di¡ªû
 = 
cu¼’t_di¡ªû
;

954 
cu¼’t_di¡ªû
 > 0) {

955 ià(
	`is_ruÃnd
(
qf
, 
cu¼’t_¦Ù
 + 
cu¼’t_di¡ªû
 - 1)) {

957 
cu¼’t_buck‘
++;

958 } 
cu¼’t_buck‘
 < 
cu¼’t_¦Ù
 + 
cu¼’t_di¡ªû
 &&

959 !
	`is_occup›d
(
qf
, 
cu¼’t_buck‘
));

962 ià(
cu¼’t_buck‘
 <ğ
cu¼’t_¦Ù
) {

963 
	`£t_¦Ù
(
qf
, 
cu¼’t_¦Ù
, 
	`g‘_¦Ù
(qf, cu¼’t_¦Ù + 
cu¼’t_di¡ªû
));

964 ià(
	`is_ruÃnd
(
qf
, 
cu¼’t_¦Ù
) !=

965 
	`is_ruÃnd
(
qf
, 
cu¼’t_¦Ù
 + 
cu¼’t_di¡ªû
))

966 
	`METADATA_WORD
(
qf
, 
ruÃnds
, 
cu¼’t_¦Ù
) ^= 1ULL << (current_slot % 64);

967 
cu¼’t_¦Ù
++;

969 } ià(
cu¼’t_buck‘
 <ğ
cu¼’t_¦Ù
 + 
cu¼’t_di¡ªû
) {

970 
ušt64_t
 
i
;

971 
i
 = 
cu¼’t_¦Ù
; i < cu¼’t_¦Ù + 
cu¼’t_di¡ªû
; i++) {

972 
	`£t_¦Ù
(
qf
, 
i
, 0);

973 
	`METADATA_WORD
(
qf
, 
ruÃnds
, 
i
) &= ~(1ULL << (i % 64));

976 
cu¼’t_di¡ªû
 = 
cu¼’t_¦Ù
 + cu¼’t_di¡ªû - 
cu¼’t_buck‘
;

977 
cu¼’t_¦Ù
 = 
cu¼’t_buck‘
;

979 
cu¼’t_di¡ªû
 = 0;

985 ià(
İ”©iÚ
 && !
tÙ®_»mašd”s
)

986 
	`METADATA_WORD
(
qf
, 
occup›ds
, 
buck‘_šdex
) &= ~(1ULL << (bucket_index % 64));

993 
ušt64_t
 
Üigš®_block
 = 
Üigš®_buck‘
 / 
QF_SLOTS_PER_BLOCK
;

994 ià(
Şd_Ëngth
 > 
tÙ®_»mašd”s
) {

996 
ušt64_t
 
Ï¡_occup›ds_hash_šdex
 = 
QF_SLOTS_PER_BLOCK
 * 
Üigš®_block
 + (QF_SLOTS_PER_BLOCK - 1);

997 
ušt64_t
 
ruÃnd_šdex
 = 
	`run_’d
(
qf
, 
Ï¡_occup›ds_hash_šdex
);

1000 ià(
ruÃnd_šdex
 / 
QF_SLOTS_PER_BLOCK
 =ğ
Üigš®_block
) {

1001 ià(
	`g‘_block
(
qf
, 
Üigš®_block
 + 1)->
off£t
 == 0)

1003 
	`g‘_block
(
qf
, 
Üigš®_block
 + 1)->
off£t
 = 0;

1005 ià(
	`g‘_block
(
qf
, 
Üigš®_block
 + 1)->
off£t
 =ğ(
ruÃnd_šdex
 - 
Ï¡_occup›ds_hash_šdex
))

1007 
	`g‘_block
(
qf
, 
Üigš®_block
 + 1)->
off£t
 = (
ruÃnd_šdex
 - 
Ï¡_occup›ds_hash_šdex
);

1009 
Üigš®_block
++;

1013 
num_¦Ùs_ä“d
 = 
Şd_Ëngth
 - 
tÙ®_»mašd”s
;

1014 
	`modify_m‘ad©a
(&
qf
->
ruÁimed©a
->
pc_noccup›d_¦Ùs
, -
num_¦Ùs_ä“d
);

1016 ià(!
tÙ®_»mašd”s
) {

1017 
	`modify_m‘ad©a
(&
qf
->
ruÁimed©a
->
pc_ndi¡šù_–ts
, -1);

1021  
»t_cu¼’t_di¡ªû
;

1022 
	}
}

1037 
šlše
 
ušt64_t
 *
	$’code_couÁ”
(
QF
 *
qf
, 
ušt64_t
 
»mašd”
, uint64_t

1038 
couÁ”
, 
ušt64_t
 *
¦Ùs
)

1040 
ušt64_t
 
dig™
 = 
»mašd”
;

1041 
ušt64_t
 
ba£
 = (1ULL << 
qf
->
m‘ad©a
->
b™s_³r_¦Ù
) - 1;

1042 
ušt64_t
 *
p
 = 
¦Ùs
;

1044 ià(
couÁ”
 == 0)

1045  
p
;

1047 *--
p
 = 
»mašd”
;

1049 ià(
couÁ”
 == 1)

1050  
p
;

1052 ià(
couÁ”
 == 2) {

1053 *--
p
 = 
»mašd”
;

1054  
p
;

1057 ià(
couÁ”
 =ğ3 && 
»mašd”
 == 0) {

1058 *--
p
 = 
»mašd”
;

1059 *--
p
 = 
»mašd”
;

1060  
p
;

1063 ià(
couÁ”
 =ğ3 && 
»mašd”
 > 0) {

1064 *--
p
 = 0;

1065 *--
p
 = 
»mašd”
;

1066  
p
;

1069 ià(
»mašd”
 == 0)

1070 *--
p
 = 
»mašd”
;

1072 
ba£
--;

1074 ià(
»mašd”
)

1075 
couÁ”
 -= 3;

1077 
couÁ”
 -= 4;

1079 
dig™
 = 
couÁ”
 % 
ba£
;

1080 
dig™
++;

1081 ià(
»mašd”
 && 
dig™
 >=„emainder)

1082 
dig™
++;

1083 *--
p
 = 
dig™
;

1084 
couÁ”
 /ğ
ba£
;

1085 } 
couÁ”
);

1087 ià(
»mašd”
 && 
dig™
 >=„emainder)

1088 *--
p
 = 0;

1090 *--
p
 = 
»mašd”
;

1092  
p
;

1093 
	}
}

1097 
šlše
 
ušt64_t
 
	$decode_couÁ”
(cÚ¡ 
QF
 *
qf
, 
ušt64_t
 
šdex
, uint64_t

1098 *
»mašd”
, 
ušt64_t
 *
couÁ
)

1100 
ušt64_t
 
ba£
;

1101 
ušt64_t
 
»m
;

1102 
ušt64_t
 
út
;

1103 
ušt64_t
 
dig™
;

1104 
ušt64_t
 
’d
;

1106 *
»mašd”
 = 
»m
 = 
	`g‘_¦Ù
(
qf
, 
šdex
);

1108 ià(
	`is_ruÃnd
(
qf
, 
šdex
)) {

1109 *
couÁ
 = 1;

1110  
šdex
;

1113 
dig™
 = 
	`g‘_¦Ù
(
qf
, 
šdex
 + 1);

1115 ià(
	`is_ruÃnd
(
qf
, 
šdex
 + 1)) {

1116 *
couÁ
 = 
dig™
 =ğ
»m
 ? 2 : 1;

1117  
šdex
 + (
dig™
 =ğ
»m
 ? 1 : 0);

1120 ià(
»m
 > 0 && 
dig™
 >=„em) {

1121 *
couÁ
 = 
dig™
 =ğ
»m
 ? 2 : 1;

1122  
šdex
 + (
dig™
 =ğ
»m
 ? 1 : 0);

1125 ià(
»m
 > 0 && 
dig™
 =ğ0 && 
	`g‘_¦Ù
(
qf
, 
šdex
 + 2) ==„em) {

1126 *
couÁ
 = 3;

1127  
šdex
 + 2;

1130 ià(
»m
 =ğ0 && 
dig™
 == 0) {

1131 ià(
	`g‘_¦Ù
(
qf
, 
šdex
 + 2) == 0) {

1132 *
couÁ
 = 3;

1133  
šdex
 + 2;

1135 *
couÁ
 = 2;

1136  
šdex
 + 1;

1140 
út
 = 0;

1141 
ba£
 = (1ULL << 
qf
->
m‘ad©a
->
b™s_³r_¦Ù
è- (
»m
 ? 2 : 1);

1143 
’d
 = 
šdex
 + 1;

1144 
dig™
 !ğ
»m
 && !
	`is_ruÃnd
(
qf
, 
’d
)) {

1145 ià(
dig™
 > 
»m
)

1146 
dig™
--;

1147 ià(
dig™
 && 
»m
)

1148 
dig™
--;

1149 
út
 = cÁ * 
ba£
 + 
dig™
;

1151 
’d
++;

1152 
dig™
 = 
	`g‘_¦Ù
(
qf
, 
’d
);

1155 ià(
»m
) {

1156 *
couÁ
 = 
út
 + 3;

1157  
’d
;

1160 ià(
	`is_ruÃnd
(
qf
, 
’d
è|| 
	`g‘_¦Ù
(qf,ƒnd + 1) != 0) {

1161 *
couÁ
 = 1;

1162  
šdex
;

1165 *
couÁ
 = 
út
 + 4;

1166  
’d
 + 1;

1167 
	}
}

1172 
šlše
 
ušt64_t
 
	$Ãxt_¦Ù
(
QF
 *
qf
, 
ušt64_t
 
cu¼’t
)

1174 
ušt64_t
 
»m
 = 
	`g‘_¦Ù
(
qf
, 
cu¼’t
);

1175 
cu¼’t
++;

1177 
	`g‘_¦Ù
(
qf
, 
cu¼’t
è=ğ
»m
 && cu¼’ˆ<ğqf->
m‘ad©a
->
n¦Ùs
) {

1178 
cu¼’t
++;

1180  
cu¼’t
;

1181 
	}
}

1183 
šlše
 
	$š£¹1
(
QF
 *
qf
, 
__ušt128_t
 
hash
, 
ušt8_t
 
ruÁime_lock
)

1185 
»t_di¡ªû
 = 0;

1186 
ušt64_t
 
hash_»mašd”
 = 
hash
 & 
	`BITMASK
(
qf
->
m‘ad©a
->
b™s_³r_¦Ù
);

1187 
ušt64_t
 
hash_buck‘_šdex
 = 
hash
 >> 
qf
->
m‘ad©a
->
b™s_³r_¦Ù
;

1188 
ušt64_t
 
hash_buck‘_block_off£t
 = 
hash_buck‘_šdex
 % 
QF_SLOTS_PER_BLOCK
;

1190 ià(
	`GET_NO_LOCK
(
ruÁime_lock
è!ğ
QF_NO_LOCK
) {

1191 ià(!
	`qf_lock
(
qf
, 
hash_buck‘_šdex
, 
Œue
, 
ruÁime_lock
))

1192  
QF_COULDNT_LOCK
;

1194 ià(
	`is_em±y
(
qf
, 
hash_buck‘_šdex
) ) {

1195 
	`METADATA_WORD
(
qf
, 
ruÃnds
, 
hash_buck‘_šdex
) |= 1ULL <<

1196 (
hash_buck‘_block_off£t
 % 64);

1197 
	`£t_¦Ù
(
qf
, 
hash_buck‘_šdex
, 
hash_»mašd”
);

1198 
	`METADATA_WORD
(
qf
, 
occup›ds
, 
hash_buck‘_šdex
) |= 1ULL <<

1199 (
hash_buck‘_block_off£t
 % 64);

1201 
»t_di¡ªû
 = 0;

1202 
	`modify_m‘ad©a
(&
qf
->
ruÁimed©a
->
pc_ndi¡šù_–ts
, 1);

1203 
	`modify_m‘ad©a
(&
qf
->
ruÁimed©a
->
pc_noccup›d_¦Ùs
, 1);

1204 
	`modify_m‘ad©a
(&
qf
->
ruÁimed©a
->
pc_ÃÉs
, 1);

1206 
ušt64_t
 
ruÃnd_šdex
 = 
	`run_’d
(
qf
, 
hash_buck‘_šdex
);

1207 
İ”©iÚ
 = 0;

1208 
ušt64_t
 
š£¹_šdex
 = 
ruÃnd_šdex
 + 1;

1209 
ušt64_t
 
Ãw_v®ue
 = 
hash_»mašd”
;

1213 
ušt64_t
 
run¡¬t_šdex
 = 
hash_buck‘_šdex
 =ğ0 ? 0 : 
	`run_’d
(
qf
,

1214 
hash_buck‘_šdex


1217 ià(
	`is_occup›d
(
qf
, 
hash_buck‘_šdex
)) {

1220 
ušt64_t
 
cu¼’t_»mašd”
 = 
	`g‘_¦Ù
(
qf
, 
run¡¬t_šdex
);

1221 
ušt64_t
 
z”o_‹rmš©Ü
 = 
run¡¬t_šdex
;

1224 ià(
cu¼’t_»mašd”
 == 0) {

1225 
ušt64_t
 
t
 = 
run¡¬t_šdex
 + 1;

1226 
t
 < 
ruÃnd_šdex
 && 
	`g‘_¦Ù
(
qf
,) != 0)

1227 
t
++;

1228 ià(
t
 < 
ruÃnd_šdex
 && 
	`g‘_¦Ù
(
qf
,+1) == 0)

1229 
z”o_‹rmš©Ü
 = 
t
+1;

1230 ià(
run¡¬t_šdex
 < 
ruÃnd_šdex
 && 
	`g‘_¦Ù
(
qf
,„unstart_index

1232 
z”o_‹rmš©Ü
 = 
run¡¬t_šdex
 + 1;

1237 ià(
hash_»mašd”
 != 0) {

1238 
run¡¬t_šdex
 = 
z”o_‹rmš©Ü
 + 1;

1239 
cu¼’t_»mašd”
 = 
	`g‘_¦Ù
(
qf
, 
run¡¬t_šdex
);

1244 
cu¼’t_»mašd”
 < 
hash_»mašd”
 && 
run¡¬t_šdex
 <=

1245 
ruÃnd_šdex
) {

1247 ià(
run¡¬t_šdex
 < 
ruÃnd_šdex
 &&

1248 
	`g‘_¦Ù
(
qf
, 
run¡¬t_šdex
 + 1è< 
cu¼’t_»mašd”
) {

1249 
run¡¬t_šdex
 =„unstart_index + 2;

1250 
run¡¬t_šdex
 < 
ruÃnd_šdex
 &&

1251 
	`g‘_¦Ù
(
qf
, 
run¡¬t_šdex
è!ğ
cu¼’t_»mašd”
)

1252 
run¡¬t_šdex
++;

1253 
run¡¬t_šdex
++;

1257 
run¡¬t_šdex
++;

1263 
cu¼’t_»mašd”
 = 
	`g‘_¦Ù
(
qf
, 
run¡¬t_šdex
);

1268 ià(
run¡¬t_šdex
 > 
ruÃnd_šdex
) {

1269 
İ”©iÚ
 = 1;

1270 
š£¹_šdex
 = 
run¡¬t_šdex
;

1271 
Ãw_v®ue
 = 
hash_»mašd”
;

1272 
	`modify_m‘ad©a
(&
qf
->
ruÁimed©a
->
pc_ndi¡šù_–ts
, 1);

1276 } ià(
cu¼’t_»mašd”
 !ğ
hash_»mašd”
) {

1277 
İ”©iÚ
 = 2;

1278 
š£¹_šdex
 = 
run¡¬t_šdex
;

1279 
Ãw_v®ue
 = 
hash_»mašd”
;

1280 
	`modify_m‘ad©a
(&
qf
->
ruÁimed©a
->
pc_ndi¡šù_–ts
, 1);

1286 } ià(
run¡¬t_šdex
 =ğ
ruÃnd_šdex
 ||

1287 (
hash_»mašd”
 > 0 && 
	`g‘_¦Ù
(
qf
, 
run¡¬t_šdex
 + 1) >

1288 
hash_»mašd”
) ||

1289 (
hash_»mašd”
 =ğ0 && 
z”o_‹rmš©Ü
 =ğ
run¡¬t_šdex
)) {

1290 
İ”©iÚ
 = 2;

1291 
š£¹_šdex
 = 
run¡¬t_šdex
;

1292 
Ãw_v®ue
 = 
hash_»mašd”
;

1295 } ià((
hash_»mašd”
 > 0 && 
	`g‘_¦Ù
(
qf
, 
run¡¬t_šdex
 + 1) ==

1296 
hash_»mašd”
) ||

1297 (
hash_»mašd”
 =ğ0 && 
z”o_‹rmš©Ü
 =ğ
run¡¬t_šdex
 + 1)) {

1298 
İ”©iÚ
 = 2;

1299 
š£¹_šdex
 = 
run¡¬t_šdex
 + 1;

1300 
Ãw_v®ue
 = 0;

1303 } ià(
hash_»mašd”
 =ğ0 && 
z”o_‹rmš©Ü
 =ğ
run¡¬t_šdex
 + 2) {

1304 
İ”©iÚ
 = 2;

1305 
š£¹_šdex
 = 
run¡¬t_šdex
 + 1;

1306 
Ãw_v®ue
 = 1;

1312 
š£¹_šdex
 = 
run¡¬t_šdex
 + 1;

1313 
	`g‘_¦Ù
(
qf
, 
š£¹_šdex
+1è!ğ
hash_»mašd”
)

1314 
š£¹_šdex
++;

1317 
ušt64_t
 
dig™
, 
ÿ¼y
;

1319 
ÿ¼y
 = 0;

1320 
dig™
 = 
	`g‘_¦Ù
(
qf
, 
š£¹_šdex
);

1322 ià(
dig™
 == 0) {

1323 
dig™
++;

1324 ià(
dig™
 =ğ
cu¼’t_»mašd”
)

1325 
dig™
++;

1329 
dig™
 = (dig™ + 1è& 
	`BITMASK
(
qf
->
m‘ad©a
->
b™s_³r_¦Ù
);

1332 ià(
dig™
 == 0) {

1333 
dig™
++;

1334 
ÿ¼y
 = 1;

1336 ià(
dig™
 =ğ
cu¼’t_»mašd”
)

1337 
dig™
 = (dig™ + 1è& 
	`BITMASK
(
qf
->
m‘ad©a
->
b™s_³r_¦Ù
);

1338 ià(
dig™
 == 0) {

1339 
dig™
++;

1340 
ÿ¼y
 = 1;

1343 
	`£t_¦Ù
(
qf
, 
š£¹_šdex
, 
dig™
);

1344 
š£¹_šdex
--;

1345 } 
š£¹_šdex
 > 
run¡¬t_šdex
 && 
ÿ¼y
);

1348 ià(
š£¹_šdex
 =ğ
run¡¬t_šdex
 && (
ÿ¼y
 > 0 || (
cu¼’t_»mašd”


1349 !ğ0 && 
dig™
 >=

1350 
cu¼’t_»mašd”
)))

1352 
İ”©iÚ
 = 2;

1353 
š£¹_šdex
 = 
run¡¬t_šdex
 + 1;

1354 ià(!
ÿ¼y
)

1355 
Ãw_v®ue
 = 0;

1356 ià(
ÿ¼y
) {

1357 
Ãw_v®ue
 = 2;

1359 ià(
cu¼’t_»mašd”
 > 0)

1360 
	`as£¹
(
Ãw_v®ue
 < 
cu¼’t_»mašd”
);

1363 
İ”©iÚ
 = -1;

1367 
	`modify_m‘ad©a
(&
qf
->
ruÁimed©a
->
pc_ndi¡šù_–ts
, 1);

1370 ià(
İ”©iÚ
 >= 0) {

1371 
ušt64_t
 
em±y_¦Ù_šdex
 = 
	`fšd_fœ¡_em±y_¦Ù
(
qf
, 
ruÃnd_šdex
+1);

1372 ià(
em±y_¦Ù_šdex
 >ğ
qf
->
m‘ad©a
->
xn¦Ùs
) {

1373  
QF_NO_SPACE
;

1375 
	`shiá_»mašd”s
(
qf
, 
š£¹_šdex
, 
em±y_¦Ù_šdex
);

1377 
	`£t_¦Ù
(
qf
, 
š£¹_šdex
, 
Ãw_v®ue
);

1378 
»t_di¡ªû
 = 
š£¹_šdex
 - 
hash_buck‘_šdex
;

1380 
	`shiá_ruÃnds
(
qf
, 
š£¹_šdex
, 
em±y_¦Ù_šdex
-1, 1);

1381 
İ”©iÚ
) {

1383 
	`METADATA_WORD
(
qf
, 
ruÃnds
, 
š£¹_šdex
) |= 1ULL << ((insert_index

1385 
QF_SLOTS_PER_BLOCK
)

1389 
	`METADATA_WORD
(
qf
, 
ruÃnds
, 
š£¹_šdex
-1) &= ~(1ULL <<

1390 (((
š£¹_šdex
-1) %

1391 
QF_SLOTS_PER_BLOCK
) %

1393 
	`METADATA_WORD
(
qf
, 
ruÃnds
, 
š£¹_šdex
) |= 1ULL << ((insert_index

1395 
QF_SLOTS_PER_BLOCK
)

1399 
	`METADATA_WORD
(
qf
, 
ruÃnds
, 
š£¹_šdex
) &= ~(1ULL <<

1400 ((
š£¹_šdex
 %

1401 
QF_SLOTS_PER_BLOCK
) %

1405 
	`årštf
(
¡d”r
, "Inv®id o³¿tiÚ %d\n", 
İ”©iÚ
);

1406 
	`abÜt
();

1412 
ušt64_t
 
i
;

1413 
i
 = 
hash_buck‘_šdex
 / 
QF_SLOTS_PER_BLOCK
 + 1; i <=

1414 
em±y_¦Ù_šdex
/
QF_SLOTS_PER_BLOCK
; 
i
++) {

1415 ià(
	`g‘_block
(
qf
, 
i
)->
off£t
 < 
	`BITMASK
(8*(qf->
blocks
[0].offset)))

1416 
	`g‘_block
(
qf
, 
i
)->
off£t
++;

1417 
	`as£¹
(
	`g‘_block
(
qf
, 
i
)->
off£t
 != 0);

1419 
	`modify_m‘ad©a
(&
qf
->
ruÁimed©a
->
pc_noccup›d_¦Ùs
, 1);

1421 
	`modify_m‘ad©a
(&
qf
->
ruÁimed©a
->
pc_ÃÉs
, 1);

1422 
	`METADATA_WORD
(
qf
, 
occup›ds
, 
hash_buck‘_šdex
) |= 1ULL <<

1423 (
hash_buck‘_block_off£t
 % 64);

1426 ià(
	`GET_NO_LOCK
(
ruÁime_lock
è!ğ
QF_NO_LOCK
) {

1427 
	`qf_uÆock
(
qf
, 
hash_buck‘_šdex
, 
Œue
);

1430  
»t_di¡ªû
;

1431 
	}
}

1433 
šlše
 
	$š£¹
(
QF
 *
qf
, 
__ušt128_t
 
hash
, 
ušt64_t
 
couÁ
, 
ušt8_t


1434 
ruÁime_lock
)

1436 
»t_di¡ªû
 = 0;

1437 
ušt64_t
 
hash_»mašd”
 = 
hash
 & 
	`BITMASK
(
qf
->
m‘ad©a
->
b™s_³r_¦Ù
);

1438 
ušt64_t
 
hash_buck‘_šdex
 = 
hash
 >> 
qf
->
m‘ad©a
->
b™s_³r_¦Ù
;

1439 
ušt64_t
 
hash_buck‘_block_off£t
 = 
hash_buck‘_šdex
 % 
QF_SLOTS_PER_BLOCK
;

1442 ià(
	`GET_NO_LOCK
(
ruÁime_lock
è!ğ
QF_NO_LOCK
) {

1443 ià(!
	`qf_lock
(
qf
, 
hash_buck‘_šdex
, 
çl£
, 
ruÁime_lock
))

1444  
QF_COULDNT_LOCK
;

1447 
ušt64_t
 
ruÃnd_šdex
 = 
	`run_’d
(
qf
, 
hash_buck‘_šdex
);

1450 ià(
	`might_be_em±y
(
qf
, 
hash_buck‘_šdex
è&& 
ruÃnd_šdex
 ==

1451 
hash_buck‘_šdex
) {

1452 
	`METADATA_WORD
(
qf
, 
ruÃnds
, 
hash_buck‘_šdex
) |= 1ULL <<

1453 (
hash_buck‘_block_off£t
 % 64);

1454 
	`£t_¦Ù
(
qf
, 
hash_buck‘_šdex
, 
hash_»mašd”
);

1455 
	`METADATA_WORD
(
qf
, 
occup›ds
, 
hash_buck‘_šdex
) |= 1ULL <<

1456 (
hash_buck‘_block_off£t
 % 64);

1458 
	`modify_m‘ad©a
(&
qf
->
ruÁimed©a
->
pc_ndi¡šù_–ts
, 1);

1459 
	`modify_m‘ad©a
(&
qf
->
ruÁimed©a
->
pc_noccup›d_¦Ùs
, 1);

1460 
	`modify_m‘ad©a
(&
qf
->
ruÁimed©a
->
pc_ÃÉs
, 1);

1462 ià(
couÁ
 > 1) {

1463 
	`š£¹
(
qf
, 
hash
, 
couÁ
 - 1, 
QF_NO_LOCK
);

1466 
ušt64_t
 
Ãw_v®ues
[67];

1467 
št64_t
 
run¡¬t_šdex
 = 
hash_buck‘_šdex
 =ğ0 ? 0 : 
	`run_’d
(
qf
,

1468 
hash_buck‘_šdex


1471 
boŞ
 
»t
;

1472 ià(!
	`is_occup›d
(
qf
, 
hash_buck‘_šdex
)) {

1473 
ušt64_t
 *
p
 = 
	`’code_couÁ”
(
qf
, 
hash_»mašd”
, 
couÁ
, &
Ãw_v®ues
[67]);

1474 
»t
 = 
	`š£¹_»¶aû_¦Ùs_ªd_shiá_»mašd”s_ªd_ruÃnds_ªd_off£ts
(
qf
,

1476 
hash_buck‘_šdex
,

1477 
run¡¬t_šdex
,

1478 
p
,

1479 &
Ãw_v®ues
[67] - 
p
,

1481 ià(!
»t
)

1482  
QF_NO_SPACE
;

1483 
	`modify_m‘ad©a
(&
qf
->
ruÁimed©a
->
pc_ndi¡šù_–ts
, 1);

1484 
»t_di¡ªû
 = 
run¡¬t_šdex
 - 
hash_buck‘_šdex
;

1487 
ušt64_t
 
cu¼’t_»mašd”
, 
cu¼’t_couÁ
, 
cu¼’t_’d
;

1490 
cu¼’t_’d
 = 
	`decode_couÁ”
(
qf
, 
run¡¬t_šdex
, &
cu¼’t_»mašd”
,

1491 &
cu¼’t_couÁ
);

1492 
cu¼’t_»mašd”
 < 
hash_»mašd”
 && !
	`is_ruÃnd
(
qf
, 
cu¼’t_’d
)) {

1493 
run¡¬t_šdex
 = 
cu¼’t_’d
 + 1;

1494 
cu¼’t_’d
 = 
	`decode_couÁ”
(
qf
, 
run¡¬t_šdex
, &
cu¼’t_»mašd”
,

1495 &
cu¼’t_couÁ
);

1500 ià(
cu¼’t_»mašd”
 < 
hash_»mašd”
) {

1501 
ušt64_t
 *
p
 = 
	`’code_couÁ”
(
qf
, 
hash_»mašd”
, 
couÁ
, &
Ãw_v®ues
[67]);

1502 
»t
 = 
	`š£¹_»¶aû_¦Ùs_ªd_shiá_»mašd”s_ªd_ruÃnds_ªd_off£ts
(
qf
,

1504 
hash_buck‘_šdex
,

1505 
cu¼’t_’d
 + 1,

1506 
p
,

1507 &
Ãw_v®ues
[67] - 
p
,

1509 ià(!
»t
)

1510  
QF_NO_SPACE
;

1511 
	`modify_m‘ad©a
(&
qf
->
ruÁimed©a
->
pc_ndi¡šù_–ts
, 1);

1512 
»t_di¡ªû
 = (
cu¼’t_’d
 + 1è- 
hash_buck‘_šdex
;

1514 } ià(
cu¼’t_»mašd”
 =ğ
hash_»mašd”
) {

1515 
ušt64_t
 *
p
 = 
	`’code_couÁ”
(
qf
, 
hash_»mašd”
, 
cu¼’t_couÁ
 + 
couÁ
, &
Ãw_v®ues
[67]);

1516 
»t
 = 
	`š£¹_»¶aû_¦Ùs_ªd_shiá_»mašd”s_ªd_ruÃnds_ªd_off£ts
(
qf
,

1517 
	`is_ruÃnd
(
qf
, 
cu¼’t_’d
) ? 1 : 2,

1518 
hash_buck‘_šdex
,

1519 
run¡¬t_šdex
,

1520 
p
,

1521 &
Ãw_v®ues
[67] - 
p
,

1522 
cu¼’t_’d
 - 
run¡¬t_šdex
 + 1);

1523 ià(!
»t
)

1524  
QF_NO_SPACE
;

1525 
»t_di¡ªû
 = 
run¡¬t_šdex
 - 
hash_buck‘_šdex
;

1529 
ušt64_t
 *
p
 = 
	`’code_couÁ”
(
qf
, 
hash_»mašd”
, 
couÁ
, &
Ãw_v®ues
[67]);

1530 
»t
 = 
	`š£¹_»¶aû_¦Ùs_ªd_shiá_»mašd”s_ªd_ruÃnds_ªd_off£ts
(
qf
,

1532 
hash_buck‘_šdex
,

1533 
run¡¬t_šdex
,

1534 
p
,

1535 &
Ãw_v®ues
[67] - 
p
,

1537 ià(!
»t
)

1538  
QF_NO_SPACE
;

1539 
	`modify_m‘ad©a
(&
qf
->
ruÁimed©a
->
pc_ndi¡šù_–ts
, 1);

1540 
»t_di¡ªû
 = 
run¡¬t_šdex
 - 
hash_buck‘_šdex
;

1543 
	`METADATA_WORD
(
qf
, 
occup›ds
, 
hash_buck‘_šdex
è|ğ1ULL << (
hash_buck‘_block_off£t
 % 64);

1545 
	`modify_m‘ad©a
(&
qf
->
ruÁimed©a
->
pc_ÃÉs
, 
couÁ
);

1548 ià(
	`GET_NO_LOCK
(
ruÁime_lock
è!ğ
QF_NO_LOCK
) {

1549 
	`qf_uÆock
(
qf
, 
hash_buck‘_šdex
, 
çl£
);

1552  
»t_di¡ªû
;

1553 
	}
}

1555 
šlše
 
	$_»move
(
QF
 *
qf
, 
__ušt128_t
 
hash
, 
ušt64_t
 
couÁ
, 
ušt8_t


1556 
ruÁime_lock
)

1558 
»t_numä“d¦Ùs
 = 0;

1559 
ušt64_t
 
hash_»mašd”
 = 
hash
 & 
	`BITMASK
(
qf
->
m‘ad©a
->
b™s_³r_¦Ù
);

1560 
ušt64_t
 
hash_buck‘_šdex
 = 
hash
 >> 
qf
->
m‘ad©a
->
b™s_³r_¦Ù
;

1561 
ušt64_t
 
cu¼’t_»mašd”
, 
cu¼’t_couÁ
, 
cu¼’t_’d
;

1562 
ušt64_t
 
Ãw_v®ues
[67];

1564 ià(
	`GET_NO_LOCK
(
ruÁime_lock
è!ğ
QF_NO_LOCK
) {

1565 ià(!
	`qf_lock
(
qf
, 
hash_buck‘_šdex
, 
çl£
, 
ruÁime_lock
))

1570 ià(!
	`is_occup›d
(
qf
, 
hash_buck‘_šdex
))

1573 
ušt64_t
 
run¡¬t_šdex
 = 
hash_buck‘_šdex
 =ğ0 ? 0 : 
	`run_’d
(
qf
, hash_bucket_index - 1) + 1;

1574 
ušt64_t
 
Üigš®_run¡¬t_šdex
 = 
run¡¬t_šdex
;

1575 
Úly_™em_š_the_run
 = 0;

1578 
cu¼’t_’d
 = 
	`decode_couÁ”
(
qf
, 
run¡¬t_šdex
, &
cu¼’t_»mašd”
, &
cu¼’t_couÁ
);

1579 
cu¼’t_»mašd”
 < 
hash_»mašd”
 && !
	`is_ruÃnd
(
qf
, 
cu¼’t_’d
)) {

1580 
run¡¬t_šdex
 = 
cu¼’t_’d
 + 1;

1581 
cu¼’t_’d
 = 
	`decode_couÁ”
(
qf
, 
run¡¬t_šdex
, &
cu¼’t_»mašd”
, &
cu¼’t_couÁ
);

1584 ià(
cu¼’t_»mašd”
 !ğ
hash_»mašd”
)

1587 ià(
Üigš®_run¡¬t_šdex
 =ğ
run¡¬t_šdex
 && 
	`is_ruÃnd
(
qf
, 
cu¼’t_’d
))

1588 
Úly_™em_š_the_run
 = 1;

1591 
ušt64_t
 *
p
 = 
	`’code_couÁ”
(
qf
, 
hash_»mašd”
,

1592 
couÁ
 > 
cu¼’t_couÁ
 ? 0 : current_count - count,

1593 &
Ãw_v®ues
[67]);

1594 
»t_numä“d¦Ùs
 = 
	`»move_»¶aû_¦Ùs_ªd_shiá_»mašd”s_ªd_ruÃnds_ªd_off£ts
(
qf
,

1595 
Úly_™em_š_the_run
,

1596 
hash_buck‘_šdex
,

1597 
run¡¬t_šdex
,

1598 
p
,

1599 &
Ãw_v®ues
[67] - 
p
,

1600 
cu¼’t_’d
 - 
run¡¬t_šdex
 + 1);

1603 
	`modify_m‘ad©a
(&
qf
->
ruÁimed©a
->
pc_ÃÉs
, -
couÁ
);

1606 ià(
	`GET_NO_LOCK
(
ruÁime_lock
è!ğ
QF_NO_LOCK
) {

1607 
	`qf_uÆock
(
qf
, 
hash_buck‘_šdex
, 
çl£
);

1610  
»t_numä“d¦Ùs
;

1611 
	}
}

1617 
ušt64_t
 
	$qf_š™
(
QF
 *
qf
, 
ušt64_t
 
n¦Ùs
, ušt64_ˆ
key_b™s
, ušt64_ˆ
v®ue_b™s
,

1618 
qf_hashmode
 
hash
, 
ušt32_t
 
£ed
, * 
bufãr
, 
ušt64_t


1619 
bufãr_Ën
)

1621 
ušt64_t
 
num_¦Ùs
, 
xn¦Ùs
, 
nblocks
;

1622 
ušt64_t
 
key_»mašd”_b™s
, 
b™s_³r_¦Ù
;

1623 
ušt64_t
 
size
;

1624 
ušt64_t
 
tÙ®_num_by‹s
;

1626 
	`as£¹
(
	`pİút
(
n¦Ùs
) == 1);

1627 
num_¦Ùs
 = 
n¦Ùs
;

1628 
xn¦Ùs
 = 
n¦Ùs
 + 10*
	`sq¹
(()nslots);

1629 
nblocks
 = (
xn¦Ùs
 + 
QF_SLOTS_PER_BLOCK
 - 1) / QF_SLOTS_PER_BLOCK;

1630 
key_»mašd”_b™s
 = 
key_b™s
;

1631 
n¦Ùs
 > 1 && 
key_»mašd”_b™s
 > 0) {

1632 
key_»mašd”_b™s
--;

1633 
n¦Ùs
 >>= 1;

1635 
	`as£¹
(
key_»mašd”_b™s
 >= 2);

1637 
b™s_³r_¦Ù
 = 
key_»mašd”_b™s
 + 
v®ue_b™s
;

1638 
	`as£¹
 (
QF_BITS_PER_SLOT
 =ğ0 || QF_BITS_PER_SLOT =ğ
qf
->
m‘ad©a
->
b™s_³r_¦Ù
);

1639 
	`as£¹
(
b™s_³r_¦Ù
 > 1);

1640 #ià
QF_BITS_PER_SLOT
 == 8 || QF_BITS_PER_SLOT == 16 || QF_BITS_PER_SLOT == 32 || QF_BITS_PER_SLOT == 64

1641 
size
 = 
nblocks
 * (
qfblock
);

1643 
size
 = 
nblocks
 * ((
qfblock
è+ 
QF_SLOTS_PER_BLOCK
 * 
b™s_³r_¦Ù
 / 8);

1646 
tÙ®_num_by‹s
 = (
qfm‘ad©a
è+ 
size
;

1647 ià(
bufãr
 =ğ
NULL
 || 
tÙ®_num_by‹s
 > 
bufãr_Ën
)

1648  
tÙ®_num_by‹s
;

1651 
qf
->
m‘ad©a
 = (
qfm‘ad©a
 *)(
bufãr
);

1652 
qf
->
blocks
 = (
qfblock
 *)(qf->
m‘ad©a
 + 1);

1654 
qf
->
m‘ad©a
->
magic_’dŸn_numb”
 = 
MAGIC_NUMBER
;

1655 
qf
->
m‘ad©a
->
»£rved
 = 0;

1656 
qf
->
m‘ad©a
->
hash_mode
 = 
hash
;

1657 
qf
->
m‘ad©a
->
tÙ®_size_š_by‹s
 = 
size
;

1658 
qf
->
m‘ad©a
->
£ed
 = seed;

1659 
qf
->
m‘ad©a
->
n¦Ùs
 = 
num_¦Ùs
;

1660 
qf
->
m‘ad©a
->
xn¦Ùs
 = xnslots;

1661 
qf
->
m‘ad©a
->
key_b™s
 = key_bits;

1662 
qf
->
m‘ad©a
->
v®ue_b™s
 = value_bits;

1663 
qf
->
m‘ad©a
->
key_»mašd”_b™s
 = key_remainder_bits;

1664 
qf
->
m‘ad©a
->
b™s_³r_¦Ù
 = bits_per_slot;

1666 
qf
->
m‘ad©a
->
¿nge
 = qf->m‘ad©a->
n¦Ùs
;

1667 
qf
->
m‘ad©a
->
¿nge
 <<ğqf->m‘ad©a->
key_»mašd”_b™s
;

1668 
qf
->
m‘ad©a
->
nblocks
 = (qf->m‘ad©a->
xn¦Ùs
 + 
QF_SLOTS_PER_BLOCK
 - 1) /

1669 
QF_SLOTS_PER_BLOCK
;

1670 
qf
->
m‘ad©a
->
ÃÉs
 = 0;

1671 
qf
->
m‘ad©a
->
ndi¡šù_–ts
 = 0;

1672 
qf
->
m‘ad©a
->
noccup›d_¦Ùs
 = 0;

1674 
qf
->
ruÁimed©a
->
num_locks
 = (qf->
m‘ad©a
->
xn¦Ùs
/
NUM_SLOTS_TO_LOCK
)+2;

1676 
	`pc_š™
(&
qf
->
ruÁimed©a
->
pc_ÃÉs
, (
št64_t
*)&qf->
m‘ad©a
->
ÃÉs
, 8, 100);

1677 
	`pc_š™
(&
qf
->
ruÁimed©a
->
pc_ndi¡šù_–ts
, (
št64_t
*)&qf->
m‘ad©a
->
ndi¡šù_–ts
, 8, 100);

1678 
	`pc_š™
(&
qf
->
ruÁimed©a
->
pc_noccup›d_¦Ùs
, (
št64_t
*)&qf->
m‘ad©a
->
noccup›d_¦Ùs
, 8, 100);

1680 
qf
->
ruÁimed©a
->
auto_»size
 = 0;

1681 
qf
->
ruÁimed©a
->
cÚš”_»size
 = 
qf_»size_m®loc
;

1683 
qf
->
ruÁimed©a
->
m‘ad©a_lock
 = 0;

1684 
qf
->
ruÁimed©a
->
locks
 = (vŞ©*)
	`ÿÎoc
(qf->ruÁimed©a->
num_locks
,

1686 ià(
qf
->
ruÁimed©a
->
locks
 =ğ
NULL
) {

1687 
	`³¼Ü
("Couldn't‡llocate memory for„untime†ocks.");

1688 
	`ex™
(
EXIT_FAILURE
);

1690 #ifdeà
LOG_WAIT_TIME


1691 
qf
->
ruÁimed©a
->
wa™_times
 = (
wa™_time_d©a
*

1692 )
	`ÿÎoc
(
qf
->
ruÁimed©a
->
num_locks
+1,

1693 (
wa™_time_d©a
));

1694 ià(
qf
->
ruÁimed©a
->
wa™_times
 =ğ
NULL
) {

1695 
	`³¼Ü
("Couldn't‡llocate memory for„untime wait_times.");

1696 
	`ex™
(
EXIT_FAILURE
);

1700  
tÙ®_num_by‹s
;

1701 
	}
}

1703 
ušt64_t
 
	$qf_u£
(
QF
* 
qf
, * 
bufãr
, 
ušt64_t
 
bufãr_Ën
)

1705 
qf
->
m‘ad©a
 = (
qfm‘ad©a
 *)(
bufãr
);

1706 ià(
qf
->
m‘ad©a
->
tÙ®_size_š_by‹s
 + (
qfm‘ad©a
è> 
bufãr_Ën
) {

1707  
qf
->
m‘ad©a
->
tÙ®_size_š_by‹s
 + (
qfm‘ad©a
);

1709 
qf
->
blocks
 = (
qfblock
 *)(qf->
m‘ad©a
 + 1);

1711 
qf
->
ruÁimed©a
 = (
qäuÁime
 *)
	`ÿÎoc
((qfruntime), 1);

1712 ià(
qf
->
ruÁimed©a
 =ğ
NULL
) {

1713 
	`³¼Ü
("Couldn't‡llocate memory for„untime data.");

1714 
	`ex™
(
EXIT_FAILURE
);

1717 
qf
->
ruÁimed©a
->
m‘ad©a_lock
 = 0;

1718 
qf
->
ruÁimed©a
->
locks
 = (vŞ©*)
	`ÿÎoc
(qf->ruÁimed©a->
num_locks
,

1720 ià(
qf
->
ruÁimed©a
->
locks
 =ğ
NULL
) {

1721 
	`³¼Ü
("Couldn't‡llocate memory for„untime†ocks.");

1722 
	`ex™
(
EXIT_FAILURE
);

1724 #ifdeà
LOG_WAIT_TIME


1725 
qf
->
ruÁimed©a
->
wa™_times
 = (
wa™_time_d©a
*

1726 )
	`ÿÎoc
(
qf
->
ruÁimed©a
->
num_locks
+1,

1727 (
wa™_time_d©a
));

1728 ià(
qf
->
ruÁimed©a
->
wa™_times
 =ğ
NULL
) {

1729 
	`³¼Ü
("Couldn't‡llocate memory for„untime wait_times.");

1730 
	`ex™
(
EXIT_FAILURE
);

1734  (
qfm‘ad©a
è+ 
qf
->
m‘ad©a
->
tÙ®_size_š_by‹s
;

1735 
	}
}

1737 *
	$qf_de¡roy
(
QF
 *
qf
)

1739 
	`as£¹
(
qf
->
ruÁimed©a
 !ğ
NULL
);

1740 ià(
qf
->
ruÁimed©a
->
locks
 !ğ
NULL
)

1741 
	`ä“
((*)
qf
->
ruÁimed©a
->
locks
);

1742 ià(
qf
->
ruÁimed©a
->
wa™_times
 !ğ
NULL
)

1743 
	`ä“
(
qf
->
ruÁimed©a
->
wa™_times
);

1744 ià(
qf
->
ruÁimed©a
->
f_šfo
.
f•©h
 !ğ
NULL
)

1745 
	`ä“
(
qf
->
ruÁimed©a
->
f_šfo
.
f•©h
);

1746 
	`ä“
(
qf
->
ruÁimed©a
);

1748  (*)
qf
->
m‘ad©a
;

1749 
	}
}

1751 
boŞ
 
	$qf_m®loc
(
QF
 *
qf
, 
ušt64_t
 
n¦Ùs
, ušt64_ˆ
key_b™s
, uint64_t

1752 
v®ue_b™s
, 
qf_hashmode
 
hash
, 
ušt32_t
 
£ed
)

1754 
ušt64_t
 
tÙ®_num_by‹s
 = 
	`qf_š™
(
qf
, 
n¦Ùs
, 
key_b™s
, 
v®ue_b™s
,

1755 
hash
, 
£ed
, 
NULL
, 0);

1757 *
bufãr
 = 
	`m®loc
(
tÙ®_num_by‹s
);

1758 ià(
bufãr
 =ğ
NULL
) {

1759 
	`³¼Ü
("Couldn't‡llocate memory forhe CQF.");

1760 
	`ex™
(
EXIT_FAILURE
);

1763 
qf
->
ruÁimed©a
 = (
qäuÁime
 *)
	`ÿÎoc
((qfruntime), 1);

1764 ià(
qf
->
ruÁimed©a
 =ğ
NULL
) {

1765 
	`³¼Ü
("Couldn't‡llocate memory for„untime data.");

1766 
	`ex™
(
EXIT_FAILURE
);

1769 
ušt64_t
 
š™_size
 = 
	`qf_š™
(
qf
, 
n¦Ùs
, 
key_b™s
, 
v®ue_b™s
, 
hash
, 
£ed
,

1770 
bufãr
, 
tÙ®_num_by‹s
);

1772 ià(
š™_size
 =ğ
tÙ®_num_by‹s
)

1773  
Œue
;

1775  
çl£
;

1776 
	}
}

1778 
boŞ
 
	$qf_ä“
(
QF
 *
qf
)

1780 
	`as£¹
(
qf
->
m‘ad©a
 !ğ
NULL
);

1781 *
bufãr
 = 
	`qf_de¡roy
(
qf
);

1782 ià(
bufãr
 !ğ
NULL
) {

1783 
	`ä“
(
bufãr
);

1784  
Œue
;

1787  
çl£
;

1788 
	}
}

1790 
	$qf_cİy
(
QF
 *
de¡
, cÚ¡ QF *
¤c
)

1792 
	`DEBUG_CQF
("%s\n","Source CQF");

1793 
	`DEBUG_DUMP
(
¤c
);

1794 
	`memıy
(
de¡
->
ruÁimed©a
, 
¤c
->ruÁimed©a, (
qäuÁime
));

1795 
	`memıy
(
de¡
->
m‘ad©a
, 
¤c
->m‘ad©a, (
qfm‘ad©a
));

1796 
	`memıy
(
de¡
->
blocks
, 
¤c
->blocks, src->
m‘ad©a
->
tÙ®_size_š_by‹s
);

1797 
	`DEBUG_CQF
("%s\n","Destination CQF‡fter copy.");

1798 
	`DEBUG_DUMP
(
de¡
);

1799 
	}
}

1801 
	$qf_»£t
(
QF
 *
qf
)

1803 
qf
->
m‘ad©a
->
ÃÉs
 = 0;

1804 
qf
->
m‘ad©a
->
ndi¡šù_–ts
 = 0;

1805 
qf
->
m‘ad©a
->
noccup›d_¦Ùs
 = 0;

1807 #ifdeà
LOG_WAIT_TIME


1808 
	`mem£t
(
qf
->
wa™_times
, 0,

1809 (
qf
->
ruÁimed©a
->
num_locks
+1)*(
wa™_time_d©a
));

1811 #ià
QF_BITS_PER_SLOT
 == 8 || QF_BITS_PER_SLOT == 16 || QF_BITS_PER_SLOT == 32 || QF_BITS_PER_SLOT == 64

1812 
	`mem£t
(
qf
->
blocks
, 0, qf->
m‘ad©a
->
nblocks
* (
qfblock
));

1814 
	`mem£t
(
qf
->
blocks
, 0, qf->
m‘ad©a
->
nblocks
*((
qfblock
è+ 
QF_SLOTS_PER_BLOCK
 *

1815 
qf
->
m‘ad©a
->
b™s_³r_¦Ù
 / 8));

1817 
	}
}

1819 
št64_t
 
	$qf_»size_m®loc
(
QF
 *
qf
, 
ušt64_t
 
n¦Ùs
)

1821 
QF
 
Ãw_qf
;

1822 ià(!
	`qf_m®loc
(&
Ãw_qf
, 
n¦Ùs
, 
qf
->
m‘ad©a
->
key_b™s
,

1823 
qf
->
m‘ad©a
->
v®ue_b™s
, qf->m‘ad©a->
hash_mode
,

1824 
qf
->
m‘ad©a
->
£ed
))

1826 ià(
qf
->
ruÁimed©a
->
auto_»size
)

1827 
	`qf_£t_auto_»size
(&
Ãw_qf
, 
Œue
);

1830 
QFi
 
qfi
;

1831 
	`qf_™”©Ü_äom_pos™iÚ
(
qf
, &
qfi
, 0);

1832 
št64_t
 
»t_numkeys
 = 0;

1834 
ušt64_t
 
key
, 
v®ue
, 
couÁ
;

1835 
	`qfi_g‘_hash
(&
qfi
, &
key
, &
v®ue
, &
couÁ
);

1836 
	`qfi_Ãxt
(&
qfi
);

1837 
»t
 = 
	`qf_š£¹
(&
Ãw_qf
, 
key
, 
v®ue
, 
couÁ
, 
QF_NO_LOCK
 | 
QF_KEY_IS_HASH
);

1838 ià(
»t
 < 0) {

1839 
	`årštf
(
¡d”r
, "FaedØš£¹ key: %ld iÁØthÃw CQF.\n", 
key
);

1840  
»t
;

1842 
»t_numkeys
++;

1843 } !
	`qfi_’d
(&
qfi
));

1845 
	`qf_ä“
(
qf
);

1846 
	`memıy
(
qf
, &
Ãw_qf
, (
QF
));

1848  
»t_numkeys
;

1849 
	}
}

1851 
ušt64_t
 
	$qf_»size
(
QF
* 
qf
, 
ušt64_t
 
n¦Ùs
, * 
bufãr
, ušt64_ˆ
bufãr_Ën
)

1853 
QF
 
Ãw_qf
;

1854 
Ãw_qf
.
ruÁimed©a
 = (
qäuÁime
 *)
	`ÿÎoc
((qfruntime), 1);

1855 ià(
Ãw_qf
.
ruÁimed©a
 =ğ
NULL
) {

1856 
	`³¼Ü
("Couldn't‡llocate memory for„untime data.\n");

1857 
	`ex™
(
EXIT_FAILURE
);

1860 
ušt64_t
 
š™_size
 = 
	`qf_š™
(&
Ãw_qf
, 
n¦Ùs
, 
qf
->
m‘ad©a
->
key_b™s
,

1861 
qf
->
m‘ad©a
->
v®ue_b™s
,

1862 
qf
->
m‘ad©a
->
hash_mode
, qf->m‘ad©a->
£ed
,

1863 
bufãr
, 
bufãr_Ën
);

1865 ià(
š™_size
 > 
bufãr_Ën
)

1866  
š™_size
;

1868 ià(
qf
->
ruÁimed©a
->
auto_»size
)

1869 
	`qf_£t_auto_»size
(&
Ãw_qf
, 
Œue
);

1872 
QFi
 
qfi
;

1873 
	`qf_™”©Ü_äom_pos™iÚ
(
qf
, &
qfi
, 0);

1875 
ušt64_t
 
key
, 
v®ue
, 
couÁ
;

1876 
	`qfi_g‘_hash
(&
qfi
, &
key
, &
v®ue
, &
couÁ
);

1877 
	`qfi_Ãxt
(&
qfi
);

1878 
»t
 = 
	`qf_š£¹
(&
Ãw_qf
, 
key
, 
v®ue
, 
couÁ
, 
QF_NO_LOCK
 | 
QF_KEY_IS_HASH
);

1879 ià(
»t
 < 0) {

1880 
	`årštf
(
¡d”r
, "FaedØš£¹ key: %ld iÁØthÃw CQF.\n", 
key
);

1881 
	`abÜt
();

1883 } !
	`qfi_’d
(&
qfi
));

1885 
	`qf_ä“
(
qf
);

1886 
	`memıy
(
qf
, &
Ãw_qf
, (
QF
));

1888  
š™_size
;

1889 
	}
}

1891 
	$qf_£t_auto_»size
(
QF
* 
qf
, 
boŞ
 
’abËd
)

1893 ià(
’abËd
)

1894 
qf
->
ruÁimed©a
->
auto_»size
 = 1;

1896 
qf
->
ruÁimed©a
->
auto_»size
 = 0;

1897 
	}
}

1899 
	$qf_š£¹
(
QF
 *
qf
, 
ušt64_t
 
key
, ušt64_ˆ
v®ue
, ušt64_ˆ
couÁ
, 
ušt8_t


1900 
æags
)

1904 ià(
	`qf_g‘_num_occup›d_¦Ùs
(
qf
è>ğqf->
m‘ad©a
->
n¦Ùs
 * 0.95) {

1905 ià(
qf
->
ruÁimed©a
->
auto_»size
) {

1907 ià(
qf
->
ruÁimed©a
->
	`cÚš”_»size
(qf, qf->
m‘ad©a
->
n¦Ùs
 * 2) < 0)

1909 
	`årštf
(
¡d”r
, "Resizinghe failed.\n");

1910  
QF_NO_SPACE
;

1913  
QF_NO_SPACE
;

1915 ià(
couÁ
 == 0)

1918 ià(
	`GET_KEY_HASH
(
æags
è!ğ
QF_KEY_IS_HASH
) {

1919 ià(
qf
->
m‘ad©a
->
hash_mode
 =ğ
QF_HASH_DEFAULT
)

1920 
key
 = 
	`MurmurHash64A
(((*)&key), (key),

1921 
qf
->
m‘ad©a
->
£ed
è% qf->m‘ad©a->
¿nge
;

1922 ià(
qf
->
m‘ad©a
->
hash_mode
 =ğ
QF_HASH_INVERTIBLE
)

1923 
key
 = 
	`hash_64
(key, 
	`BITMASK
(
qf
->
m‘ad©a
->
key_b™s
));

1925 
ušt64_t
 
hash
 = (
key
 << 
qf
->
m‘ad©a
->
v®ue_b™s
è| (
v®ue
 &

1926 
	`BITMASK
(
qf
->
m‘ad©a
->
v®ue_b™s
));

1927 
»t
;

1928 ià(
couÁ
 == 1)

1929 
»t
 = 
	`š£¹1
(
qf
, 
hash
, 
æags
);

1931 
»t
 = 
	`š£¹
(
qf
, 
hash
, 
couÁ
, 
æags
);

1935 ià(
»t
 =ğ
QF_NO_SPACE
 ||„‘ > 
DISTANCE_FROM_HOME_SLOT_CUTOFF
) {

1936 
lßd_çùÜ
 = 
	`qf_g‘_num_occup›d_¦Ùs
(
qf
) /

1937 ()
qf
->
m‘ad©a
->
n¦Ùs
;

1938 
	`årštf
(
¡dout
, "Lßd faùÜ: %lf\n", 
lßd_çùÜ
);

1939 ià(
qf
->
ruÁimed©a
->
auto_»size
) {

1940 
	`årštf
(
¡dout
, "Resizinghe CQF.\n");

1941 ià(
qf
->
ruÁimed©a
->
	`cÚš”_»size
(qf, qf->
m‘ad©a
->
n¦Ùs
 * 2) > 0)

1943 ià(
»t
 =ğ
QF_NO_SPACE
) {

1944 ià(
couÁ
 == 1)

1945 
»t
 = 
	`š£¹1
(
qf
, 
hash
, 
æags
);

1947 
»t
 = 
	`š£¹
(
qf
, 
hash
, 
couÁ
, 
æags
);

1949 
	`årštf
(
¡d”r
, "Resize finished.\n");

1951 
	`årštf
(
¡d”r
, "Resize failed\n");

1952 
»t
 = 
QF_NO_SPACE
;

1955 
	`årštf
(
¡d”r
, "The CQF is filling up.\n");

1956 
»t
 = 
QF_NO_SPACE
;

1959  
»t
;

1960 
	}
}

1962 
	$qf_£t_couÁ
(
QF
 *
qf
, 
ušt64_t
 
key
, ušt64_ˆ
v®ue
, ušt64_ˆ
couÁ
, 
ušt8_t


1963 
æags
)

1965 ià(
couÁ
 == 0)

1968 
ušt64_t
 
cur_couÁ
 = 
	`qf_couÁ_key_v®ue
(
qf
, 
key
, 
v®ue
, 
æags
);

1969 
št64_t
 
d–
 = 
couÁ
 - 
cur_couÁ
;

1971 
»t
;

1972 ià(
d–
 == 0)

1973 
»t
 = 0;

1974 ià(
d–
 > 0)

1975 
»t
 = 
	`qf_š£¹
(
qf
, 
key
, 
v®ue
, 
d–
, 
æags
);

1977 
»t
 = 
	`qf_»move
(
qf
, 
key
, 
v®ue
, 
	`Ïbs
(
d–
), 
æags
);

1979  
»t
;

1980 
	}
}

1982 
	$qf_»move
(
QF
 *
qf
, 
ušt64_t
 
key
, ušt64_ˆ
v®ue
, ušt64_ˆ
couÁ
, 
ušt8_t


1983 
æags
)

1985 ià(
couÁ
 == 0)

1986  
Œue
;

1988 ià(
	`GET_KEY_HASH
(
æags
è!ğ
QF_KEY_IS_HASH
) {

1989 ià(
qf
->
m‘ad©a
->
hash_mode
 =ğ
QF_HASH_DEFAULT
)

1990 
key
 = 
	`MurmurHash64A
(((*)&key), (key),

1991 
qf
->
m‘ad©a
->
£ed
è% qf->m‘ad©a->
¿nge
;

1992 ià(
qf
->
m‘ad©a
->
hash_mode
 =ğ
QF_HASH_INVERTIBLE
)

1993 
key
 = 
	`hash_64
(key, 
	`BITMASK
(
qf
->
m‘ad©a
->
key_b™s
));

1995 
ušt64_t
 
hash
 = (
key
 << 
qf
->
m‘ad©a
->
v®ue_b™s
è| (
v®ue
 &

1996 
	`BITMASK
(
qf
->
m‘ad©a
->
v®ue_b™s
));

1997  
	`_»move
(
qf
, 
hash
, 
couÁ
, 
æags
);

1998 
	}
}

2000 
	$qf_d–‘e_key_v®ue
(
QF
 *
qf
, 
ušt64_t
 
key
, ušt64_ˆ
v®ue
, 
ušt8_t
 
æags
)

2002 
ušt64_t
 
couÁ
 = 
	`qf_couÁ_key_v®ue
(
qf
, 
key
, 
v®ue
, 
æags
);

2003 ià(
couÁ
 == 0)

2004  
Œue
;

2006 ià(
	`GET_KEY_HASH
(
æags
è!ğ
QF_KEY_IS_HASH
) {

2007 ià(
qf
->
m‘ad©a
->
hash_mode
 =ğ
QF_HASH_DEFAULT
)

2008 
key
 = 
	`MurmurHash64A
(((*)&key), (key),

2009 
qf
->
m‘ad©a
->
£ed
è% qf->m‘ad©a->
¿nge
;

2010 ià(
qf
->
m‘ad©a
->
hash_mode
 =ğ
QF_HASH_INVERTIBLE
)

2011 
key
 = 
	`hash_64
(key, 
	`BITMASK
(
qf
->
m‘ad©a
->
key_b™s
));

2013 
ušt64_t
 
hash
 = (
key
 << 
qf
->
m‘ad©a
->
v®ue_b™s
è| (
v®ue
 &

2014 
	`BITMASK
(
qf
->
m‘ad©a
->
v®ue_b™s
));

2015  
	`_»move
(
qf
, 
hash
, 
couÁ
, 
æags
);

2016 
	}
}

2018 
ušt64_t
 
	$qf_couÁ_key_v®ue
(cÚ¡ 
QF
 *
qf
, 
ušt64_t
 
key
, ušt64_ˆ
v®ue
,

2019 
ušt8_t
 
æags
)

2021 ià(
	`GET_KEY_HASH
(
æags
è!ğ
QF_KEY_IS_HASH
) {

2022 ià(
qf
->
m‘ad©a
->
hash_mode
 =ğ
QF_HASH_DEFAULT
)

2023 
key
 = 
	`MurmurHash64A
(((*)&key), (key),

2024 
qf
->
m‘ad©a
->
£ed
è% qf->m‘ad©a->
¿nge
;

2025 ià(
qf
->
m‘ad©a
->
hash_mode
 =ğ
QF_HASH_INVERTIBLE
)

2026 
key
 = 
	`hash_64
(key, 
	`BITMASK
(
qf
->
m‘ad©a
->
key_b™s
));

2028 
ušt64_t
 
hash
 = (
key
 << 
qf
->
m‘ad©a
->
v®ue_b™s
è| (
v®ue
 &

2029 
	`BITMASK
(
qf
->
m‘ad©a
->
v®ue_b™s
));

2030 
ušt64_t
 
hash_»mašd”
 = 
hash
 & 
	`BITMASK
(
qf
->
m‘ad©a
->
b™s_³r_¦Ù
);

2031 
št64_t
 
hash_buck‘_šdex
 = 
hash
 >> 
qf
->
m‘ad©a
->
b™s_³r_¦Ù
;

2033 ià(!
	`is_occup›d
(
qf
, 
hash_buck‘_šdex
))

2036 
št64_t
 
run¡¬t_šdex
 = 
hash_buck‘_šdex
 =ğ0 ? 0 : 
	`run_’d
(
qf
,

2037 
hash_buck‘_šdex
-1)

2039 ià(
run¡¬t_šdex
 < 
hash_buck‘_šdex
)

2040 
run¡¬t_šdex
 = 
hash_buck‘_šdex
;

2044 
ušt64_t
 
cu¼’t_»mašd”
, 
cu¼’t_couÁ
, 
cu¼’t_’d
;

2046 
cu¼’t_’d
 = 
	`decode_couÁ”
(
qf
, 
run¡¬t_šdex
, &
cu¼’t_»mašd”
,

2047 &
cu¼’t_couÁ
);

2048 ià(
cu¼’t_»mašd”
 =ğ
hash_»mašd”
)

2049  
cu¼’t_couÁ
;

2050 
run¡¬t_šdex
 = 
cu¼’t_’d
 + 1;

2051 } !
	`is_ruÃnd
(
qf
, 
cu¼’t_’d
));

2054 
	}
}

2056 
ušt64_t
 
	$qf_qu”y
(cÚ¡ 
QF
 *
qf
, 
ušt64_t
 
key
, ušt64_ˆ*
v®ue
, 
ušt8_t
 
æags
)

2058 ià(
	`GET_KEY_HASH
(
æags
è!ğ
QF_KEY_IS_HASH
) {

2059 ià(
qf
->
m‘ad©a
->
hash_mode
 =ğ
QF_HASH_DEFAULT
)

2060 
key
 = 
	`MurmurHash64A
(((*)&key), (key),

2061 
qf
->
m‘ad©a
->
£ed
è% qf->m‘ad©a->
¿nge
;

2062 ià(
qf
->
m‘ad©a
->
hash_mode
 =ğ
QF_HASH_INVERTIBLE
)

2063 
key
 = 
	`hash_64
(key, 
	`BITMASK
(
qf
->
m‘ad©a
->
key_b™s
));

2065 
ušt64_t
 
hash
 = 
key
;

2066 
ušt64_t
 
hash_»mašd”
 = 
hash
 & 
	`BITMASK
(
qf
->
m‘ad©a
->
key_»mašd”_b™s
);

2067 
št64_t
 
hash_buck‘_šdex
 = 
hash
 >> 
qf
->
m‘ad©a
->
key_»mašd”_b™s
;

2069 ià(!
	`is_occup›d
(
qf
, 
hash_buck‘_šdex
))

2072 
št64_t
 
run¡¬t_šdex
 = 
hash_buck‘_šdex
 =ğ0 ? 0 : 
	`run_’d
(
qf
,

2073 
hash_buck‘_šdex
-1)

2075 ià(
run¡¬t_šdex
 < 
hash_buck‘_šdex
)

2076 
run¡¬t_šdex
 = 
hash_buck‘_šdex
;

2080 
ušt64_t
 
cu¼’t_»mašd”
, 
cu¼’t_couÁ
, 
cu¼’t_’d
;

2082 
cu¼’t_’d
 = 
	`decode_couÁ”
(
qf
, 
run¡¬t_šdex
, &
cu¼’t_»mašd”
,

2083 &
cu¼’t_couÁ
);

2084 *
v®ue
 = 
cu¼’t_»mašd”
 & 
	`BITMASK
(
qf
->
m‘ad©a
->
v®ue_b™s
);

2085 
cu¼’t_»mašd”
 = cu¼’t_»mašd” >> 
qf
->
m‘ad©a
->
v®ue_b™s
;

2086 ià(
cu¼’t_»mašd”
 =ğ
hash_»mašd”
) {

2087  
cu¼’t_couÁ
;

2089 
run¡¬t_šdex
 = 
cu¼’t_’d
 + 1;

2090 } !
	`is_ruÃnd
(
qf
, 
cu¼’t_’d
));

2093 
	}
}

2095 
št64_t
 
	$qf_g‘_unique_šdex
(cÚ¡ 
QF
 *
qf
, 
ušt64_t
 
key
, ušt64_ˆ
v®ue
,

2096 
ušt8_t
 
æags
)

2098 ià(
	`GET_KEY_HASH
(
æags
è!ğ
QF_KEY_IS_HASH
) {

2099 ià(
qf
->
m‘ad©a
->
hash_mode
 =ğ
QF_HASH_DEFAULT
)

2100 
key
 = 
	`MurmurHash64A
(((*)&key), (key),

2101 
qf
->
m‘ad©a
->
£ed
è% qf->m‘ad©a->
¿nge
;

2102 ià(
qf
->
m‘ad©a
->
hash_mode
 =ğ
QF_HASH_INVERTIBLE
)

2103 
key
 = 
	`hash_64
(key, 
	`BITMASK
(
qf
->
m‘ad©a
->
key_b™s
));

2105 
ušt64_t
 
hash
 = (
key
 << 
qf
->
m‘ad©a
->
v®ue_b™s
è| (
v®ue
 &

2106 
	`BITMASK
(
qf
->
m‘ad©a
->
v®ue_b™s
));

2107 
ušt64_t
 
hash_»mašd”
 = 
hash
 & 
	`BITMASK
(
qf
->
m‘ad©a
->
b™s_³r_¦Ù
);

2108 
št64_t
 
hash_buck‘_šdex
 = 
hash
 >> 
qf
->
m‘ad©a
->
b™s_³r_¦Ù
;

2110 ià(!
	`is_occup›d
(
qf
, 
hash_buck‘_šdex
))

2111  
QF_DOESNT_EXIST
;

2113 
št64_t
 
run¡¬t_šdex
 = 
hash_buck‘_šdex
 =ğ0 ? 0 : 
	`run_’d
(
qf
,

2114 
hash_buck‘_šdex
-1)

2116 ià(
run¡¬t_šdex
 < 
hash_buck‘_šdex
)

2117 
run¡¬t_šdex
 = 
hash_buck‘_šdex
;

2121 
ušt64_t
 
cu¼’t_»mašd”
, 
cu¼’t_couÁ
, 
cu¼’t_’d
;

2123 
cu¼’t_’d
 = 
	`decode_couÁ”
(
qf
, 
run¡¬t_šdex
, &
cu¼’t_»mašd”
,

2124 &
cu¼’t_couÁ
);

2125 ià(
cu¼’t_»mašd”
 =ğ
hash_»mašd”
)

2126  
run¡¬t_šdex
;

2128 
run¡¬t_šdex
 = 
cu¼’t_’d
 + 1;

2129 } !
	`is_ruÃnd
(
qf
, 
cu¼’t_’d
));

2131  
QF_DOESNT_EXIST
;

2132 
	}
}

2134 
qf_hashmode
 
	$qf_g‘_hashmode
(cÚ¡ 
QF
 *
qf
) {

2135  
qf
->
m‘ad©a
->
hash_mode
;

2136 
	}
}

2137 
ušt64_t
 
	$qf_g‘_hash_£ed
(cÚ¡ 
QF
 *
qf
) {

2138  
qf
->
m‘ad©a
->
£ed
;

2139 
	}
}

2140 
__ušt128_t
 
	$qf_g‘_hash_¿nge
(cÚ¡ 
QF
 *
qf
) {

2141  
qf
->
m‘ad©a
->
¿nge
;

2142 
	}
}

2144 
boŞ
 
	$qf_is_auto_»size_’abËd
(cÚ¡ 
QF
 *
qf
) {

2145 ià(
qf
->
ruÁimed©a
->
auto_»size
 == 1)

2146  
Œue
;

2147  
çl£
;

2148 
	}
}

2149 
ušt64_t
 
	$qf_g‘_tÙ®_size_š_by‹s
(cÚ¡ 
QF
 *
qf
) {

2150  
qf
->
m‘ad©a
->
tÙ®_size_š_by‹s
;

2151 
	}
}

2152 
ušt64_t
 
	$qf_g‘_n¦Ùs
(cÚ¡ 
QF
 *
qf
) {

2153  
qf
->
m‘ad©a
->
n¦Ùs
;

2154 
	}
}

2155 
ušt64_t
 
	$qf_g‘_num_occup›d_¦Ùs
(cÚ¡ 
QF
 *
qf
) {

2156 
	`pc_sync
(&
qf
->
ruÁimed©a
->
pc_noccup›d_¦Ùs
);

2157  
qf
->
m‘ad©a
->
noccup›d_¦Ùs
;

2158 
	}
}

2160 
ušt64_t
 
	$qf_g‘_num_key_b™s
(cÚ¡ 
QF
 *
qf
) {

2161  
qf
->
m‘ad©a
->
key_b™s
;

2162 
	}
}

2163 
ušt64_t
 
	$qf_g‘_num_v®ue_b™s
(cÚ¡ 
QF
 *
qf
) {

2164  
qf
->
m‘ad©a
->
v®ue_b™s
;

2165 
	}
}

2166 
ušt64_t
 
	$qf_g‘_num_key_»mašd”_b™s
(cÚ¡ 
QF
 *
qf
) {

2167  
qf
->
m‘ad©a
->
key_»mašd”_b™s
;

2168 
	}
}

2169 
ušt64_t
 
	$qf_g‘_b™s_³r_¦Ù
(cÚ¡ 
QF
 *
qf
) {

2170  
qf
->
m‘ad©a
->
b™s_³r_¦Ù
;

2171 
	}
}

2173 
ušt64_t
 
	$qf_g‘_sum_of_couÁs
(cÚ¡ 
QF
 *
qf
) {

2174 
	`pc_sync
(&
qf
->
ruÁimed©a
->
pc_ÃÉs
);

2175  
qf
->
m‘ad©a
->
ÃÉs
;

2176 
	}
}

2177 
ušt64_t
 
	$qf_g‘_num_di¡šù_key_v®ue_·œs
(cÚ¡ 
QF
 *
qf
) {

2178 
	`pc_sync
(&
qf
->
ruÁimed©a
->
pc_ndi¡šù_–ts
);

2179  
qf
->
m‘ad©a
->
ndi¡šù_–ts
;

2180 
	}
}

2182 
	$qf_sync_couÁ”s
(cÚ¡ 
QF
 *
qf
) {

2183 
	`pc_sync
(&
qf
->
ruÁimed©a
->
pc_ndi¡šù_–ts
);

2184 
	`pc_sync
(&
qf
->
ruÁimed©a
->
pc_ÃÉs
);

2185 
	`pc_sync
(&
qf
->
ruÁimed©a
->
pc_noccup›d_¦Ùs
);

2186 
	}
}

2191 
št64_t
 
	$qf_™”©Ü_äom_pos™iÚ
(cÚ¡ 
QF
 *
qf
, 
QFi
 *
qfi
, 
ušt64_t
 
pos™iÚ
)

2193 ià(
pos™iÚ
 == 0xffffffffffffffff) {

2194 
qfi
->
cu¼’t
 = 0xffffffffffffffff;

2195 
qfi
->
qf
 = qf;

2196  
QFI_INVALID
;

2198 
	`as£¹
(
pos™iÚ
 < 
qf
->
m‘ad©a
->
n¦Ùs
);

2199 ià(!
	`is_occup›d
(
qf
, 
pos™iÚ
)) {

2200 
ušt64_t
 
block_šdex
 = 
pos™iÚ
;

2201 
ušt64_t
 
idx
 = 
	`b™£Ëù
(
	`g‘_block
(
qf
, 
block_šdex
)->
occup›ds
[0], 0);

2202 ià(
idx
 == 64) {

2203 
idx
 =ğ64 && 
block_šdex
 < 
qf
->
m‘ad©a
->
nblocks
) {

2204 
block_šdex
++;

2205 
idx
 = 
	`b™£Ëù
(
	`g‘_block
(
qf
, 
block_šdex
)->
occup›ds
[0], 0);

2208 
pos™iÚ
 = 
block_šdex
 * 
QF_SLOTS_PER_BLOCK
 + 
idx
;

2211 
qfi
->
qf
 = qf;

2212 
qfi
->
num_şu¡”s
 = 0;

2213 
qfi
->
run
 = 
pos™iÚ
;

2214 
qfi
->
cu¼’t
 = 
pos™iÚ
 =ğ0 ? 0 : 
	`run_’d
(qfi->
qf
,…osition-1) + 1;

2215 ià(
qfi
->
cu¼’t
 < 
pos™iÚ
)

2216 
qfi
->
cu¼’t
 = 
pos™iÚ
;

2218 #ifdeà
LOG_CLUSTER_LENGTH


2219 
qfi
->
c_šfo
 = (
şu¡”_d©a
* )
	`ÿÎoc
(
qf
->
m‘ad©a
->
n¦Ùs
/32,

2220 (
şu¡”_d©a
));

2221 ià(
qfi
->
c_šfo
 =ğ
NULL
) {

2222 
	`³¼Ü
("Couldn't‡llocate memory for c_info.");

2223 
	`ex™
(
EXIT_FAILURE
);

2225 
qfi
->
cur_¡¬t_šdex
 = 
pos™iÚ
;

2226 
qfi
->
cur_Ëngth
 = 1;

2229 ià(
qfi
->
cu¼’t
 >ğ
qf
->
m‘ad©a
->
n¦Ùs
)

2230  
QFI_INVALID
;

2231  
qfi
->
cu¼’t
;

2232 
	}
}

2234 
št64_t
 
	$qf_™”©Ü_äom_key_v®ue
(cÚ¡ 
QF
 *
qf
, 
QFi
 *
qfi
, 
ušt64_t
 
key
,

2235 
ušt64_t
 
v®ue
, 
ušt8_t
 
æags
)

2237 ià(
key
 >ğ
qf
->
m‘ad©a
->
¿nge
) {

2238 
qfi
->
cu¼’t
 = 0xffffffffffffffff;

2239 
qfi
->
qf
 = qf;

2240  
QFI_INVALID
;

2243 
qfi
->
qf
 = qf;

2244 
qfi
->
num_şu¡”s
 = 0;

2246 ià(
	`GET_KEY_HASH
(
æags
è!ğ
QF_KEY_IS_HASH
) {

2247 ià(
qf
->
m‘ad©a
->
hash_mode
 =ğ
QF_HASH_DEFAULT
)

2248 
key
 = 
	`MurmurHash64A
(((*)&key), (key),

2249 
qf
->
m‘ad©a
->
£ed
è% qf->m‘ad©a->
¿nge
;

2250 ià(
qf
->
m‘ad©a
->
hash_mode
 =ğ
QF_HASH_INVERTIBLE
)

2251 
key
 = 
	`hash_64
(key, 
	`BITMASK
(
qf
->
m‘ad©a
->
key_b™s
));

2253 
ušt64_t
 
hash
 = (
key
 << 
qf
->
m‘ad©a
->
v®ue_b™s
è| (
v®ue
 &

2254 
	`BITMASK
(
qf
->
m‘ad©a
->
v®ue_b™s
));

2256 
ušt64_t
 
hash_»mašd”
 = 
hash
 & 
	`BITMASK
(
qf
->
m‘ad©a
->
b™s_³r_¦Ù
);

2257 
ušt64_t
 
hash_buck‘_šdex
 = 
hash
 >> 
qf
->
m‘ad©a
->
b™s_³r_¦Ù
;

2258 
boŞ
 
æag
 = 
çl£
;

2262 ià(
	`is_occup›d
(
qf
, 
hash_buck‘_šdex
)) {

2263 
ušt64_t
 
run¡¬t_šdex
 = 
hash_buck‘_šdex
 =ğ0 ? 0 : 
	`run_’d
(
qf
,

2264 
hash_buck‘_šdex
-1)

2266 ià(
run¡¬t_šdex
 < 
hash_buck‘_šdex
)

2267 
run¡¬t_šdex
 = 
hash_buck‘_šdex
;

2268 
ušt64_t
 
cu¼’t_»mašd”
, 
cu¼’t_couÁ
, 
cu¼’t_’d
;

2270 
cu¼’t_’d
 = 
	`decode_couÁ”
(
qf
, 
run¡¬t_šdex
, &
cu¼’t_»mašd”
,

2271 &
cu¼’t_couÁ
);

2272 ià(
cu¼’t_»mašd”
 >ğ
hash_»mašd”
) {

2273 
æag
 = 
Œue
;

2276 
run¡¬t_šdex
 = 
cu¼’t_’d
 + 1;

2277 } !
	`is_ruÃnd
(
qf
, 
cu¼’t_’d
));

2279 ià(
æag
) {

2280 
qfi
->
run
 = 
hash_buck‘_šdex
;

2281 
qfi
->
cu¼’t
 = 
run¡¬t_šdex
;

2287 ià(!
	`is_occup›d
(
qf
, 
hash_buck‘_šdex
è|| !
æag
) {

2288 
ušt64_t
 
pos™iÚ
 = 
hash_buck‘_šdex
;

2289 
	`as£¹
(
pos™iÚ
 < 
qf
->
m‘ad©a
->
n¦Ùs
);

2290 
ušt64_t
 
block_šdex
 = 
pos™iÚ
 / 
QF_SLOTS_PER_BLOCK
;

2291 
ušt64_t
 
idx
 = 
	`b™£Ëù
(
	`g‘_block
(
qf
, 
block_šdex
)->
occup›ds
[0], 0);

2292 ià(
idx
 == 64) {

2293 
idx
 =ğ64 && 
block_šdex
 < 
qf
->
m‘ad©a
->
nblocks
) {

2294 
block_šdex
++;

2295 
idx
 = 
	`b™£Ëù
(
	`g‘_block
(
qf
, 
block_šdex
)->
occup›ds
[0], 0);

2298 
pos™iÚ
 = 
block_šdex
 * 
QF_SLOTS_PER_BLOCK
 + 
idx
;

2299 
qfi
->
run
 = 
pos™iÚ
;

2300 
qfi
->
cu¼’t
 = 
pos™iÚ
 =ğ0 ? 0 : 
	`run_’d
(qfi->
qf
,…osition-1) + 1;

2301 ià(
qfi
->
cu¼’t
 < 
pos™iÚ
)

2302 
qfi
->
cu¼’t
 = 
pos™iÚ
;

2305 ià(
qfi
->
cu¼’t
 >ğ
qf
->
m‘ad©a
->
n¦Ùs
)

2306  
QFI_INVALID
;

2307  
qfi
->
cu¼’t
;

2308 
	}
}

2310 
	$qfi_g‘
(cÚ¡ 
QFi
 *
qfi
, 
ušt64_t
 *
key
, ušt64_ˆ*
v®ue
, uint64_t

2311 *
couÁ
)

2313 ià(
	`qfi_’d
(
qfi
))

2314  
QFI_INVALID
;

2316 
ušt64_t
 
cu¼’t_»mašd”
, 
cu¼’t_couÁ
;

2317 
	`decode_couÁ”
(
qfi
->
qf
, qfi->
cu¼’t
, &
cu¼’t_»mašd”
, &
cu¼’t_couÁ
);

2319 *
v®ue
 = 
cu¼’t_»mašd”
 & 
	`BITMASK
(
qfi
->
qf
->
m‘ad©a
->
v®ue_b™s
);

2320 
cu¼’t_»mašd”
 = cu¼’t_»mašd” >> 
qfi
->
qf
->
m‘ad©a
->
v®ue_b™s
;

2321 *
key
 = (
qfi
->
run
 << qfi->
qf
->
m‘ad©a
->
key_»mašd”_b™s
è| 
cu¼’t_»mašd”
;

2322 *
couÁ
 = 
cu¼’t_couÁ
;

2325 
	}
}

2327 
	$qfi_g‘_key
(cÚ¡ 
QFi
 *
qfi
, 
ušt64_t
 *
key
, ušt64_ˆ*
v®ue
, uint64_t

2328 *
couÁ
)

2330 *
key
 = *
v®ue
 = *
couÁ
 = 0;

2331 
»t
 = 
	`qfi_g‘
(
qfi
, 
key
, 
v®ue
, 
couÁ
);

2332 ià(
»t
 == 0) {

2333 ià(
qfi
->
qf
->
m‘ad©a
->
hash_mode
 =ğ
QF_HASH_DEFAULT
) {

2334 *
key
 = 0; *
v®ue
 = 0; *
couÁ
 = 0;

2335  
QF_INVALID
;

2336 } ià(
qfi
->
qf
->
m‘ad©a
->
hash_mode
 =ğ
QF_HASH_INVERTIBLE
)

2337 *
key
 = 
	`hash_64i
(*key, 
	`BITMASK
(
qfi
->
qf
->
m‘ad©a
->
key_b™s
));

2340  
»t
;

2341 
	}
}

2343 
	$qfi_g‘_hash
(cÚ¡ 
QFi
 *
qfi
, 
ušt64_t
 *
key
, ušt64_ˆ*
v®ue
, uint64_t

2344 *
couÁ
)

2346 *
key
 = *
v®ue
 = *
couÁ
 = 0;

2347  
	`qfi_g‘
(
qfi
, 
key
, 
v®ue
, 
couÁ
);

2348 
	}
}

2350 
	$qfi_Ãxt
(
QFi
 *
qfi
)

2352 ià(
	`qfi_’d
(
qfi
))

2353  
QFI_INVALID
;

2356 
ušt64_t
 
cu¼’t_»mašd”
, 
cu¼’t_couÁ
;

2357 
qfi
->
cu¼’t
 = 
	`decode_couÁ”
(qfi->
qf
, qfi->cu¼’t, &
cu¼’t_»mašd”
,

2358 &
cu¼’t_couÁ
);

2360 ià(!
	`is_ruÃnd
(
qfi
->
qf
, qfi->
cu¼’t
)) {

2361 
qfi
->
cu¼’t
++;

2362 #ifdeà
LOG_CLUSTER_LENGTH


2363 
qfi
->
cur_Ëngth
++;

2365 ià(
	`qfi_’d
(
qfi
))

2366  
QFI_INVALID
;

2369 #ifdeà
LOG_CLUSTER_LENGTH


2371 
ušt64_t
 
Şd_cu¼’t
 = 
qfi
->
cu¼’t
;

2373 
ušt64_t
 
block_šdex
 = 
qfi
->
run
 / 
QF_SLOTS_PER_BLOCK
;

2374 
ušt64_t
 
¿nk
 = 
	`b™¿nk
(
	`g‘_block
(
qfi
->
qf
, 
block_šdex
)->
occup›ds
[0],

2375 
qfi
->
run
 % 
QF_SLOTS_PER_BLOCK
);

2376 
ušt64_t
 
Ãxt_run
 = 
	`b™£Ëù
(
	`g‘_block
(
qfi
->
qf
,

2377 
block_šdex
)->
occup›ds
[0],

2378 
¿nk
);

2379 ià(
Ãxt_run
 == 64) {

2380 
¿nk
 = 0;

2381 
Ãxt_run
 =ğ64 && 
block_šdex
 < 
qfi
->
qf
->
m‘ad©a
->
nblocks
) {

2382 
block_šdex
++;

2383 
Ãxt_run
 = 
	`b™£Ëù
(
	`g‘_block
(
qfi
->
qf
, 
block_šdex
)->
occup›ds
[0],

2384 
¿nk
);

2387 ià(
block_šdex
 =ğ
qfi
->
qf
->
m‘ad©a
->
nblocks
) {

2389 
qfi
->
run
 = qfi->
cu¼’t
 = qfi->
qf
->
m‘ad©a
->
xn¦Ùs
;

2390  
QFI_INVALID
;

2392 
qfi
->
run
 = 
block_šdex
 * 
QF_SLOTS_PER_BLOCK
 + 
Ãxt_run
;

2393 
qfi
->
cu¼’t
++;

2394 ià(
qfi
->
cu¼’t
 < qfi->
run
)

2395 
qfi
->
cu¼’t
 = qfi->
run
;

2396 #ifdeà
LOG_CLUSTER_LENGTH


2397 ià(
qfi
->
cu¼’t
 > 
Şd_cu¼’t
 + 1) {

2398 ià(
qfi
->
cur_Ëngth
 > 10) {

2399 
qfi
->
c_šfo
[qfi->
num_şu¡”s
].
¡¬t_šdex
 = qfi->
cur_¡¬t_šdex
;

2400 
qfi
->
c_šfo
[qfi->
num_şu¡”s
].
Ëngth
 = qfi->
cur_Ëngth
;

2401 
qfi
->
num_şu¡”s
++;

2403 
qfi
->
cur_¡¬t_šdex
 = qfi->
run
;

2404 
qfi
->
cur_Ëngth
 = 1;

2406 
qfi
->
cur_Ëngth
++;

2412 
	}
}

2414 
boŞ
 
	$qfi_’d
(cÚ¡ 
QFi
 *
qfi
)

2416 ià(
qfi
->
cu¼’t
 >ğqfi->
qf
->
m‘ad©a
->
xn¦Ùs
 )

2417  
Œue
;

2418  
çl£
;

2419 
	}
}

2432 
	$qf_m”ge
(cÚ¡ 
QF
 *
qç
, cÚ¡ QF *
qfb
, QF *
qfc
)

2434 
QFi
 
qfŸ
, 
qfib
;

2435 
	`qf_™”©Ü_äom_pos™iÚ
(
qç
, &
qfŸ
, 0);

2436 
	`qf_™”©Ü_äom_pos™iÚ
(
qfb
, &
qfib
, 0);

2438 ià(
qç
->
m‘ad©a
->
hash_mode
 !ğ
qfc
->metadata->hash_mode &&

2439 
qç
->
m‘ad©a
->
£ed
 !ğ
qfc
->metadata->seed &&

2440 
qfb
->
m‘ad©a
->
hash_mode
 !ğ
qfc
->metadata->hash_mode &&

2441 
qfb
->
m‘ad©a
->
£ed
 !ğ
qfc
->metadata->seed) {

2442 
	`årštf
(
¡d”r
, "Output QF‡nd input QFs do‚ot havehe same hash mode or seed.\n");

2443 
	`ex™
(1);

2446 
ušt64_t
 
keya
, 
v®u—
, 
couÁa
, 
keyb
, 
v®ueb
, 
couÁb
;

2447 
	`qfi_g‘_hash
(&
qfŸ
, &
keya
, &
v®u—
, &
couÁa
);

2448 
	`qfi_g‘_hash
(&
qfib
, &
keyb
, &
v®ueb
, &
couÁb
);

2450 ià(
keya
 < 
keyb
) {

2451 
	`qf_š£¹
(
qfc
, 
keya
, 
v®u—
, 
couÁa
, 
QF_NO_LOCK
 | 
QF_KEY_IS_HASH
);

2452 
	`qfi_Ãxt
(&
qfŸ
);

2453 
	`qfi_g‘_hash
(&
qfŸ
, &
keya
, &
v®u—
, &
couÁa
);

2456 
	`qf_š£¹
(
qfc
, 
keyb
, 
v®ueb
, 
couÁb
, 
QF_NO_LOCK
 | 
QF_KEY_IS_HASH
);

2457 
	`qfi_Ãxt
(&
qfib
);

2458 
	`qfi_g‘_hash
(&
qfib
, &
keyb
, &
v®ueb
, &
couÁb
);

2460 } !
	`qfi_’d
(&
qfŸ
è&& !qfi_’d(&
qfib
));

2462 ià(!
	`qfi_’d
(&
qfŸ
)) {

2464 
	`qfi_g‘_hash
(&
qfŸ
, &
keya
, &
v®u—
, &
couÁa
);

2465 
	`qf_š£¹
(
qfc
, 
keya
, 
v®u—
, 
couÁa
, 
QF_NO_LOCK
 | 
QF_KEY_IS_HASH
);

2466 } !
	`qfi_Ãxt
(&
qfŸ
));

2468 ià(!
	`qfi_’d
(&
qfib
)) {

2470 
	`qfi_g‘_hash
(&
qfib
, &
keyb
, &
v®ueb
, &
couÁb
);

2471 
	`qf_š£¹
(
qfc
, 
keyb
, 
v®ueb
, 
couÁb
, 
QF_NO_LOCK
 | 
QF_KEY_IS_HASH
);

2472 } !
	`qfi_Ãxt
(&
qfib
));

2474 
	}
}

2479 
	$qf_muÉi_m”ge
(cÚ¡ 
QF
 *
qf_¬r
[], 
nqf
, QF *
qä
)

2481 
i
;

2482 
QFi
 
qfi_¬r
[
nqf
];

2483 
sm®Ë¡_idx
 = 0;

2484 
ušt64_t
 
sm®Ë¡_key
 = 
UINT64_MAX
;

2485 
i
=0; i<
nqf
; i++) {

2486 ià(
qf_¬r
[
i
]->
m‘ad©a
->
hash_mode
 !ğ
qä
->metadata->hash_mode &&

2487 
qf_¬r
[
i
]->
m‘ad©a
->
£ed
 !ğ
qä
->metadata->seed) {

2488 
	`årštf
(
¡d”r
, "Output QF‡nd input QFs do‚ot havehe same hash mode or seed.\n");

2489 
	`ex™
(1);

2491 
	`qf_™”©Ü_äom_pos™iÚ
(
qf_¬r
[
i
], &
qfi_¬r
[i], 0);

2494 
	`DEBUG_CQF
("M”gšg %d CQFs\n", 
nqf
);

2495 
i
=0; i<
nqf
; i++) {

2496 
	`DEBUG_CQF
("CQF %d\n", 
i
);

2497 
	`DEBUG_DUMP
(
qf_¬r
[
i
]);

2500 
nqf
 > 1) {

2501 
ušt64_t
 
keys
[
nqf
];

2502 
ušt64_t
 
v®ues
[
nqf
];

2503 
ušt64_t
 
couÁs
[
nqf
];

2504 
i
=0; i<
nqf
; i++)

2505 
	`qfi_g‘_hash
(&
qfi_¬r
[
i
], &
keys
[i], &
v®ues
[i], &
couÁs
[i]);

2508 
sm®Ë¡_key
 = 
UINT64_MAX
;

2509 
i
=0; i<
nqf
; i++) {

2510 ià(
keys
[
i
] < 
sm®Ë¡_key
) {

2511 
sm®Ë¡_key
 = 
keys
[
i
]; 
sm®Ë¡_idx
 = i;

2514 
	`qf_š£¹
(
qä
, 
keys
[
sm®Ë¡_idx
], 
v®ues
[smallest_idx],

2515 
couÁs
[
sm®Ë¡_idx
], 
QF_NO_LOCK
 | 
QF_KEY_IS_HASH
);

2516 
	`qfi_Ãxt
(&
qfi_¬r
[
sm®Ë¡_idx
]);

2517 
	`qfi_g‘_hash
(&
qfi_¬r
[
sm®Ë¡_idx
], &
keys
[smallest_idx],

2518 &
v®ues
[
sm®Ë¡_idx
],

2519 &
couÁs
[
sm®Ë¡_idx
]);

2520 } !
	`qfi_’d
(&
qfi_¬r
[
sm®Ë¡_idx
]));

2523 ià(
sm®Ë¡_idx
 < 
nqf
-1)

2524 
	`memmove
(&
qfi_¬r
[
sm®Ë¡_idx
], &qfi_arr[smallest_idx+1],

2525 (
nqf
-
sm®Ë¡_idx
-1)*(
qfi_¬r
[0]));

2526 
nqf
--;

2528 ià(!
	`qfi_’d
(&
qfi_¬r
[0])) {

2529 
ušt64_t
 
™”s
 = 0;

2531 
ušt64_t
 
key
, 
v®ue
, 
couÁ
;

2532 
	`qfi_g‘_hash
(&
qfi_¬r
[0], &
key
, &
v®ue
, &
couÁ
);

2533 
	`qf_š£¹
(
qä
, 
key
, 
v®ue
, 
couÁ
, 
QF_NO_LOCK
 | 
QF_KEY_IS_HASH
);

2534 
	`qfi_Ãxt
(&
qfi_¬r
[0]);

2535 
™”s
++;

2536 } !
	`qfi_’d
(&
qfi_¬r
[0]));

2537 
	`DEBUG_CQF
("Num oà™”©iÚs: %lu\n", 
™”s
);

2540 
	`DEBUG_CQF
("%s", "Final CQF‡fter merging.\n");

2541 
	`DEBUG_DUMP
(
qä
);

2544 
	}
}

2547 
ušt64_t
 
	$qf_šÃr_´oduù
(cÚ¡ 
QF
 *
qç
, cÚ¡ QF *
qfb
)

2549 
ušt64_t
 
acc
 = 0;

2550 
QFi
 
qfi
;

2551 cÚ¡ 
QF
 *
qf_mem
, *
qf_disk
;

2553 ià(
qç
->
m‘ad©a
->
hash_mode
 !ğ
qfb
->metadata->hash_mode &&

2554 
qç
->
m‘ad©a
->
£ed
 !ğ
qfb
->metadata->seed) {

2555 
	`årštf
(
¡d”r
, "Input QFs do‚ot havehe same hash mode or seed.\n");

2556 
	`ex™
(1);

2560 ià(
qç
->
m‘ad©a
->
tÙ®_size_š_by‹s
 > 
qfb
->metadata->total_size_in_bytes)

2562 
qf_mem
 = 
qfb
;

2563 
qf_disk
 = 
qç
;

2565 
qf_mem
 = 
qç
;

2566 
qf_disk
 = 
qfb
;

2569 
	`qf_™”©Ü_äom_pos™iÚ
(
qf_disk
, &
qfi
, 0);

2571 
ušt64_t
 
key
 = 0, 
v®ue
 = 0, 
couÁ
 = 0;

2572 
ušt64_t
 
couÁ_mem
;

2573 
	`qfi_g‘_hash
(&
qfi
, &
key
, &
v®ue
, &
couÁ
);

2574 ià((
couÁ_mem
 = 
	`qf_couÁ_key_v®ue
(
qf_mem
, 
key
, 0, 
QF_KEY_IS_HASH
)) > 0) {

2575 
acc
 +ğ
couÁ
*
couÁ_mem
;

2577 } !
	`qfi_Ãxt
(&
qfi
));

2579  
acc
;

2580 
	}
}

2583 
	$qf_š‹r£ù
(cÚ¡ 
QF
 *
qç
, cÚ¡ QF *
qfb
, QF *
qä
)

2585 
QFi
 
qfi
;

2586 cÚ¡ 
QF
 *
qf_mem
, *
qf_disk
;

2588 ià(
qç
->
m‘ad©a
->
hash_mode
 !ğ
qä
->metadata->hash_mode &&

2589 
qç
->
m‘ad©a
->
£ed
 !ğ
qä
->metadata->seed &&

2590 
qfb
->
m‘ad©a
->
hash_mode
 !ğ
qä
->metadata->hash_mode &&

2591 
qfb
->
m‘ad©a
->
£ed
 !ğ
qä
->metadata->seed) {

2592 
	`årštf
(
¡d”r
, "Output QF‡nd input QFs do‚ot havehe same hash mode or seed.\n");

2593 
	`ex™
(1);

2597 ià(
qç
->
m‘ad©a
->
tÙ®_size_š_by‹s
 > 
qfb
->metadata->total_size_in_bytes)

2599 
qf_mem
 = 
qfb
;

2600 
qf_disk
 = 
qç
;

2602 
qf_mem
 = 
qç
;

2603 
qf_disk
 = 
qfb
;

2606 
	`qf_™”©Ü_äom_pos™iÚ
(
qf_disk
, &
qfi
, 0);

2608 
ušt64_t
 
key
 = 0, 
v®ue
 = 0, 
couÁ
 = 0;

2609 
	`qfi_g‘_hash
(&
qfi
, &
key
, &
v®ue
, &
couÁ
);

2610 ià(
	`qf_couÁ_key_v®ue
(
qf_mem
, 
key
, 0, 
QF_KEY_IS_HASH
) > 0)

2611 
	`qf_š£¹
(
qä
, 
key
, 
v®ue
, 
couÁ
, 
QF_NO_LOCK
 | 
QF_KEY_IS_HASH
);

2612 } !
	`qfi_Ãxt
(&
qfi
));

2613 
	}
}

2616 
ušt64_t
 
	$qf_magn™ude
(cÚ¡ 
QF
 *
qf
)

2618  
	`sq¹
(
	`qf_šÃr_´oduù
(
qf
, qf));

2619 
	}
}

	@src/gqf_file.c

10 
	~<¡dlib.h
>

12 
	~<as£¹.h
>

14 
	#as£¹
(
x
)

	)

16 
	~<¡ršg.h
>

17 
	~<š‰y³s.h
>

18 
	~<¡dio.h
>

19 
	~<uni¡d.h
>

20 
	~<m©h.h
>

21 
	~<time.h
>

22 
	~<sys/mmª.h
>

23 
	~<sys/¡©.h
>

24 
	~<fú.h
>

26 
	~"hashut.h
"

27 
	~"gqf.h
"

28 
	~"gqf_št.h
"

29 
	~"gqf_fe.h
"

31 
	#NUM_SLOTS_TO_LOCK
 (1ULL<<16)

	)

33 
boŞ
 
	$qf_š™fe
(
QF
 *
qf
, 
ušt64_t
 
n¦Ùs
, ušt64_ˆ
key_b™s
, uint64_t

34 
v®ue_b™s
, 
qf_hashmode
 
hash
, 
ušt32_t
 
£ed
, const *

35 
f’ame
)

37 
ušt64_t
 
tÙ®_num_by‹s
 = 
	`qf_š™
(
qf
, 
n¦Ùs
, 
key_b™s
, 
v®ue_b™s
, 
hash
,

38 
£ed
, 
NULL
, 0);

40 
»t
;

41 
qf
->
ruÁimed©a
 = (
qäuÁime
 *)
	`ÿÎoc
((qfruntime), 1);

42 ià(
qf
->
ruÁimed©a
 =ğ
NULL
) {

43 
	`³¼Ü
("Couldn't‡llocate memory for„untime data.");

44 
	`ex™
(
EXIT_FAILURE
);

46 
qf
->
ruÁimed©a
->
f_šfo
.
fd
 = 
	`İ’
(
f’ame
, 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
,

47 
S_IRWXU
);

48 ià(
qf
->
ruÁimed©a
->
f_šfo
.
fd
 < 0) {

49 
	`³¼Ü
("Couldn't open file.");

50 
	`ex™
(
EXIT_FAILURE
);

52 
»t
 = 
	`posix_çÎoÿ‹
(
qf
->
ruÁimed©a
->
f_šfo
.
fd
, 0, 
tÙ®_num_by‹s
);

53 ià(
»t
 < 0) {

54 
	`³¼Ü
("Couldn't fallocate file:\n");

55 
	`ex™
(
EXIT_FAILURE
);

57 
qf
->
m‘ad©a
 = (
qfm‘ad©a
 *)
	`mm­
(
NULL
, 
tÙ®_num_by‹s
, 
PROT_READ
 |

58 
PROT_WRITE
, 
MAP_SHARED
,

59 
qf
->
ruÁimed©a
->
f_šfo
.
fd
, 0);

60 ià(
qf
->
m‘ad©a
 =ğ
MAP_FAILED
) {

61 
	`³¼Ü
("Couldn't mmap metadata.");

62 
	`ex™
(
EXIT_FAILURE
);

64 
»t
 = 
	`madvi£
(
qf
->
m‘ad©a
, 
tÙ®_num_by‹s
, 
MADV_RANDOM
);

65 ià(
»t
 < 0) {

66 
	`³¼Ü
("Couldn't fallocate file.");

67 
	`ex™
(
EXIT_FAILURE
);

69 
qf
->
blocks
 = (
qfblock
 *)(qf->
m‘ad©a
 + 1);

71 
ušt64_t
 
š™_size
 = 
	`qf_š™
(
qf
, 
n¦Ùs
, 
key_b™s
, 
v®ue_b™s
, 
hash
, 
£ed
,

72 
qf
->
m‘ad©a
, 
tÙ®_num_by‹s
);

73 
qf
->
ruÁimed©a
->
f_šfo
.
f•©h
 = (*)
	`m®loc
(
	`¡¾’
(
f’ame
) + 1);

74 ià(
qf
->
ruÁimed©a
->
f_šfo
.
f•©h
 =ğ
NULL
) {

75 
	`³¼Ü
("Couldn't‡llocate memory for„untime f_info filepath.");

76 
	`ex™
(
EXIT_FAILURE
);

78 
	`¡rıy
(
qf
->
ruÁimed©a
->
f_šfo
.
f•©h
, 
f’ame
);

80 
qf
->
ruÁimed©a
->
cÚš”_»size
 = 
qf_»size_fe
;

82 ià(
š™_size
 =ğ
tÙ®_num_by‹s
)

83  
Œue
;

85  
çl£
;

86 
	}
}

88 
ušt64_t
 
	$qf_u£fe
(
QF
* 
qf
, cÚ¡ * 
f’ame
, 
æag
)

90 
¡©
 
sb
;

91 
»t
;

93 
İ’_æag
 = 0, 
mm­_æag
 = 0;

94 ià(
æag
 =ğ
QF_USEFILE_READ_ONLY
) {

95 
İ’_æag
 = 
O_RDONLY
;

96 
mm­_æag
 = 
PROT_READ
;

97 } if(
æag
 =ğ
QF_USEFILE_READ_WRITE
) {

98 
İ’_æag
 = 
O_RDWR
;

99 
mm­_æag
 = 
PROT_READ
 | 
PROT_WRITE
;

101 
	`årštf
(
¡d”r
, "Wrong flag specified.\n");

105 
qf
->
ruÁimed©a
 = (
qäuÁime
 *)
	`ÿÎoc
((qfruntime), 1);

106 ià(
qf
->
ruÁimed©a
 =ğ
NULL
) {

107 
	`³¼Ü
("Couldn't‡llocate memory for„untime data.");

108 
	`ex™
(
EXIT_FAILURE
);

110 
qf
->
ruÁimed©a
->
f_šfo
.
fd
 = 
	`İ’
(
f’ame
, 
İ’_æag
);

111 ià(
qf
->
ruÁimed©a
->
f_šfo
.
fd
 < 0) {

112 
	`³¼Ü
("Couldn't open file.");

113 
	`ex™
(
EXIT_FAILURE
);

116 
»t
 = 
	`f¡©
 (
qf
->
ruÁimed©a
->
f_šfo
.
fd
, &
sb
);

117 iàĞ
»t
 < 0) {

118 
	`³¼Ü
 ("fstat");

119 
	`ex™
(
EXIT_FAILURE
);

122 ià(!
	`S_ISREG
 (
sb
.
¡_mode
)) {

123 
	`årštf
 (
¡d”r
, "% i nÙ‡ fe.\n", 
f’ame
);

124 
	`ex™
(
EXIT_FAILURE
);

127 
qf
->
ruÁimed©a
->
f_šfo
.
f•©h
 = (*)
	`m®loc
(
	`¡¾’
(
f’ame
) + 1);

128 ià(
qf
->
ruÁimed©a
->
f_šfo
.
f•©h
 =ğ
NULL
) {

129 
	`³¼Ü
("Couldn't‡llocate memory for„untime f_info filepath.");

130 
	`ex™
(
EXIT_FAILURE
);

132 
	`¡rıy
(
qf
->
ruÁimed©a
->
f_šfo
.
f•©h
, 
f’ame
);

134 
qf
->
ruÁimed©a
->
cÚš”_»size
 = 
qf_»size_fe
;

136 
qf
->
ruÁimed©a
->
m‘ad©a_lock
 = 0;

137 
qf
->
ruÁimed©a
->
locks
 = (vŞ©*)
	`ÿÎoc
(qf->ruÁimed©a->
num_locks
,

139 ià(
qf
->
ruÁimed©a
->
locks
 =ğ
NULL
) {

140 
	`³¼Ü
("Couldn't‡llocate memory for„untime†ocks.");

141 
	`ex™
(
EXIT_FAILURE
);

143 #ifdeà
LOG_WAIT_TIME


144 
qf
->
ruÁimed©a
->
wa™_times
 = (
wa™_time_d©a
* )
	`ÿÎoc
(qf->ruÁimed©a->
num_locks
+1,

145 (
wa™_time_d©a
));

146 ià(
qf
->
ruÁimed©a
->
wa™_times
 =ğ
NULL
) {

147 
	`³¼Ü
("Couldn't‡llocate memory for„untime wait_times.");

148 
	`ex™
(
EXIT_FAILURE
);

151 
qf
->
m‘ad©a
 = (
qfm‘ad©a
 *)
	`mm­
(
NULL
, 
sb
.
¡_size
, 
mm­_æag
, 
MAP_SHARED
,

152 
qf
->
ruÁimed©a
->
f_šfo
.
fd
, 0);

153 ià(
qf
->
m‘ad©a
 =ğ
MAP_FAILED
) {

154 
	`³¼Ü
("Couldn't mmap metadata.");

155 
	`ex™
(
EXIT_FAILURE
);

157 ià(
qf
->
m‘ad©a
->
magic_’dŸn_numb”
 !ğ
MAGIC_NUMBER
) {

158 
	`årštf
(
¡d”r
, "Can't„eadhe CQF. It was written on‡ differentƒndian machine.");

159 
	`ex™
(
EXIT_FAILURE
);

161 
qf
->
blocks
 = (
qfblock
 *)(qf->
m‘ad©a
 + 1);

163 
	`pc_š™
(&
qf
->
ruÁimed©a
->
pc_ÃÉs
, (
št64_t
*)&qf->
m‘ad©a
->
ÃÉs
, 8, 100);

164 
	`pc_š™
(&
qf
->
ruÁimed©a
->
pc_ndi¡šù_–ts
, (
št64_t
*)&qf->
m‘ad©a
->
ndi¡šù_–ts
, 8, 100);

165 
	`pc_š™
(&
qf
->
ruÁimed©a
->
pc_noccup›d_¦Ùs
, (
št64_t
*)&qf->
m‘ad©a
->
noccup›d_¦Ùs
, 8, 100);

167  (
qfm‘ad©a
è+ 
qf
->
m‘ad©a
->
tÙ®_size_š_by‹s
;

168 
	}
}

170 
št64_t
 
	$qf_»size_fe
(
QF
 *
qf
, 
ušt64_t
 
n¦Ùs
)

173 
Ãw_f’ame_Ën
 = 
	`¡¾’
(
qf
->
ruÁimed©a
->
f_šfo
.
f•©h
) + 1;

174 
Ãw_f’ame_Ën
 += 13;

175 *
Ãw_f’ame
 = (*)
	`m®loc
(
Ãw_f’ame_Ën
);

176 ià(
Ãw_f’ame
 =ğ
NULL
) {

177 
	`³¼Ü
("Couldn't‡llocate memory for filename buffer during„esize.");

178 
	`ex™
(
EXIT_FAILURE
);

181 
ušt64_t
 
»t
 = 
	`¢´štf
(
Ãw_f’ame
, 
Ãw_f’ame_Ën
, "%s_%ld",

182 
qf
->
ruÁimed©a
->
f_šfo
.
f•©h
, 
n¦Ùs
);

183 ià(
»t
 <ğ
	`¡¾’
(
qf
->
ruÁimed©a
->
f_šfo
.
f•©h
)) {

184 
	`årštf
(
¡d”r
, "Wrong‚ew filename created!");

188 
QF
 
Ãw_qf
;

189 ià(!
	`qf_š™fe
(&
Ãw_qf
, 
n¦Ùs
, 
qf
->
m‘ad©a
->
key_b™s
,

190 
qf
->
m‘ad©a
->
v®ue_b™s
, qf->m‘ad©a->
hash_mode
,

191 
qf
->
m‘ad©a
->
£ed
, 
Ãw_f’ame
))

192  
çl£
;

193 ià(
qf
->
ruÁimed©a
->
auto_»size
)

194 
	`qf_£t_auto_»size
(&
Ãw_qf
, 
Œue
);

197 
QFi
 
qfi
;

198 
	`qf_™”©Ü_äom_pos™iÚ
(
qf
, &
qfi
, 0);

199 
št64_t
 
»t_numkeys
 = 0;

201 
ušt64_t
 
key
, 
v®ue
, 
couÁ
;

202 
	`qfi_g‘_hash
(&
qfi
, &
key
, &
v®ue
, &
couÁ
);

203 
	`qfi_Ãxt
(&
qfi
);

204 
»t
 = 
	`qf_š£¹
(&
Ãw_qf
, 
key
, 
v®ue
, 
couÁ
, 
QF_NO_LOCK
 | 
QF_KEY_IS_HASH
);

205 ià(
»t
 < 0) {

206 
	`årštf
(
¡d”r
, "FaedØš£¹ key: %ld iÁØthÃw CQF.\n", 
key
);

207  
»t
;

209 
»t_numkeys
++;

210 } !
	`qfi_’d
(&
qfi
));

213 *
·th
 = (*)
	`m®loc
(
	`¡¾’
(
qf
->
ruÁimed©a
->
f_šfo
.
f•©h
) + 1);

214 ià(
qf
->
ruÁimed©a
->
f_šfo
.
f•©h
 =ğ
NULL
) {

215 
	`³¼Ü
("Couldn't‡llocate memory for„untime f_info filepath.");

216 
	`ex™
(
EXIT_FAILURE
);

218 
	`¡rıy
(
·th
, 
qf
->
ruÁimed©a
->
f_šfo
.
f•©h
);

221 
	`qf_d–‘efe
(
qf
);

222 
	`memıy
(
qf
, &
Ãw_qf
, (
QF
));

224 
	`»Çme
(
qf
->
ruÁimed©a
->
f_šfo
.
f•©h
, 
·th
);

225 
	`¡rıy
(
qf
->
ruÁimed©a
->
f_šfo
.
f•©h
, 
·th
);

227  
»t_numkeys
;

228 
	}
}

230 
boŞ
 
	$qf_şo£fe
(
QF
* 
qf
)

232 
	`as£¹
(
qf
->
m‘ad©a
 !ğ
NULL
);

233 
fd
 = 
qf
->
ruÁimed©a
->
f_šfo
.fd;

234 
	`qf_sync_couÁ”s
(
qf
);

235 
ušt64_t
 
size
 = 
qf
->
m‘ad©a
->
tÙ®_size_š_by‹s
 + (
qfm‘ad©a
);

236 *
bufãr
 = 
	`qf_de¡roy
(
qf
);

237 ià(
bufãr
 !ğ
NULL
) {

238 
	`munm­
(
bufãr
, 
size
);

239 
	`şo£
(
fd
);

240  
Œue
;

243  
çl£
;

244 
	}
}

246 
boŞ
 
	$qf_d–‘efe
(
QF
* 
qf
)

248 
	`as£¹
(
qf
->
m‘ad©a
 !ğ
NULL
);

249 *
·th
 = (*)
	`m®loc
(
	`¡¾’
(
qf
->
ruÁimed©a
->
f_šfo
.
f•©h
) + 1);

250 ià(
qf
->
ruÁimed©a
->
f_šfo
.
f•©h
 =ğ
NULL
) {

251 
	`³¼Ü
("Couldn't‡llocate memory for„untime f_info filepath.");

252 
	`ex™
(
EXIT_FAILURE
);

254 
	`¡rıy
(
·th
, 
qf
->
ruÁimed©a
->
f_šfo
.
f•©h
);

255 ià(
	`qf_şo£fe
(
qf
)) {

256 
	`»move
(
·th
);

257 
	`ä“
(
·th
);

258  
Œue
;

261  
çl£
;

262 
	}
}

264 
ušt64_t
 
	$qf_£rŸlize
(cÚ¡ 
QF
 *
qf
, cÚ¡ *
f’ame
)

266 
FILE
 *
fout
;

267 
fout
 = 
	`fİ’
(
f’ame
, "wb+");

268 ià(
fout
 =ğ
NULL
) {

269 
	`³¼Ü
("Error opening file for serializing.");

270 
	`ex™
(
EXIT_FAILURE
);

272 
	`qf_sync_couÁ”s
(
qf
);

273 
	`fwr™e
(
qf
->
m‘ad©a
, (
qfm‘ad©a
), 1, 
fout
);

274 
	`fwr™e
(
qf
->
blocks
, qf->
m‘ad©a
->
tÙ®_size_š_by‹s
, 1, 
fout
);

275 
	`fşo£
(
fout
);

277  (
qfm‘ad©a
è+ 
qf
->
m‘ad©a
->
tÙ®_size_š_by‹s
;

278 
	}
}

280 
ušt64_t
 
	$qf_de£rŸlize
(
QF
 *
qf
, cÚ¡ *
f’ame
)

282 
FILE
 *
fš
;

283 
fš
 = 
	`fİ’
(
f’ame
, "rb");

284 ià(
fš
 =ğ
NULL
) {

285 
	`³¼Ü
("Error opening file for deserializing.");

286 
	`ex™
(
EXIT_FAILURE
);

289 
qf
->
ruÁimed©a
 = (
qäuÁime
 *)
	`ÿÎoc
((qfruntime), 1);

290 ià(
qf
->
ruÁimed©a
 =ğ
NULL
) {

291 
	`³¼Ü
("Couldn't‡llocate memory for„untime data.");

292 
	`ex™
(
EXIT_FAILURE
);

294 
qf
->
m‘ad©a
 = (
qfm‘ad©a
 *)
	`ÿÎoc
((qfmetadata), 1);

295 ià(
qf
->
m‘ad©a
 =ğ
NULL
) {

296 
	`³¼Ü
("Couldn't‡llocate memory for metadata.");

297 
	`ex™
(
EXIT_FAILURE
);

299 
»t
 = 
	`ä—d
(
qf
->
m‘ad©a
, (
qfm‘ad©a
), 1, 
fš
);

300 ià(
»t
 < 1) {

301 
	`³¼Ü
("Couldn't„ead metadata from file.");

302 
	`ex™
(
EXIT_FAILURE
);

304 ià(
qf
->
m‘ad©a
->
magic_’dŸn_numb”
 !ğ
MAGIC_NUMBER
) {

305 
	`årštf
(
¡d”r
, "Can't„eadhe CQF. It was written on‡ differentƒndian machine.");

306 
	`ex™
(
EXIT_FAILURE
);

309 
qf
->
ruÁimed©a
->
f_šfo
.
f•©h
 = (*)
	`m®loc
(
	`¡¾’
(
f’ame
) + 1);

310 ià(
qf
->
ruÁimed©a
->
f_šfo
.
f•©h
 =ğ
NULL
) {

311 
	`³¼Ü
("Couldn't‡llocate memory for„untime f_info filepath.");

312 
	`ex™
(
EXIT_FAILURE
);

314 
	`¡rıy
(
qf
->
ruÁimed©a
->
f_šfo
.
f•©h
, 
f’ame
);

316 
qf
->
ruÁimed©a
->
num_locks
 = (qf->
m‘ad©a
->
xn¦Ùs
/
NUM_SLOTS_TO_LOCK
)+2;

317 
qf
->
ruÁimed©a
->
m‘ad©a_lock
 = 0;

319 
qf
->
ruÁimed©a
->
locks
 = (vŞ©*)
	`ÿÎoc
(qf->ruÁimed©a->
num_locks
,

321 ià(
qf
->
ruÁimed©a
->
locks
 =ğ
NULL
) {

322 
	`³¼Ü
("Couldn't‡llocate memory for„untime†ocks.");

323 
	`ex™
(
EXIT_FAILURE
);

325 
qf
->
m‘ad©a
 = (
qfm‘ad©a
 *)
	`»®loc
(qf->metadata,

326 
qf
->
m‘ad©a
->
tÙ®_size_š_by‹s
 +

327 (
qfm‘ad©a
));

328 ià(
qf
->
m‘ad©a
 =ğ
NULL
) {

329 
	`³¼Ü
("Couldn't‡llocate memory for metadata.");

330 
	`ex™
(
EXIT_FAILURE
);

332 
qf
->
blocks
 = (
qfblock
 *)(qf->
m‘ad©a
 + 1);

333 ià(
qf
->
blocks
 =ğ
NULL
) {

334 
	`³¼Ü
("Couldn't‡llocate memory for blocks.");

335 
	`ex™
(
EXIT_FAILURE
);

337 
»t
 = 
	`ä—d
(
qf
->
blocks
, qf->
m‘ad©a
->
tÙ®_size_š_by‹s
, 1, 
fš
);

338 ià(
»t
 < 1) {

339 
	`³¼Ü
("Couldn't„ead metadata from file.");

340 
	`ex™
(
EXIT_FAILURE
);

342 
	`fşo£
(
fš
);

344 
	`pc_š™
(&
qf
->
ruÁimed©a
->
pc_ÃÉs
, (
št64_t
*)&qf->
m‘ad©a
->
ÃÉs
, 8, 100);

345 
	`pc_š™
(&
qf
->
ruÁimed©a
->
pc_ndi¡šù_–ts
, (
št64_t
*)&qf->
m‘ad©a
->
ndi¡šù_–ts
, 8, 100);

346 
	`pc_š™
(&
qf
->
ruÁimed©a
->
pc_noccup›d_¦Ùs
, (
št64_t
*)&qf->
m‘ad©a
->
noccup›d_¦Ùs
, 8, 100);

348  (
qfm‘ad©a
è+ 
qf
->
m‘ad©a
->
tÙ®_size_š_by‹s
;

349 
	}
}

351 
	#MADVISE_GRANULARITY
 (32)

	)

352 
	#ROUND_TO_PAGE_GROUP
(
p
è((*)(((
šŒ_t
)Õ)è- (((šŒ_t)Õ)è% (
·ge_size
 * 
MADVISE_GRANULARITY
))))

	)

354 
	$make_madvi£_ÿÎs
(cÚ¡ 
QF
 *
qf
, 
ušt64_t
 
Şdrun
, ušt64_ˆ
Ãwrun
)

356 
·ge_size
 = 
	`syscÚf
(
_SC_PAGESIZE
);

358 * 
Şdblock
 = (*)
	`g‘_block
(
qf
, 
Şdrun
 / 
QF_SLOTS_PER_BLOCK
);

359 * 
Ãwblock
 = (*)
	`g‘_block
(
qf
, 
Ãwrun
 / 
QF_SLOTS_PER_BLOCK
);

361 
Şdblock
 = 
	`ROUND_TO_PAGE_GROUP
(oldblock);

362 
Ãwblock
 = 
	`ROUND_TO_PAGE_GROUP
(newblock);

364 ià(
Şdblock
 < (*)
qf
->
blocks
)

367 
Şdblock
 < 
Ãwblock
) {

368 
	`madvi£
(
Şdblock
, 
·ge_size
 * 
MADVISE_GRANULARITY
, 
MADV_DONTNEED
);

369 
Şdblock
 +ğ
·ge_size
 * 
MADVISE_GRANULARITY
;

371 
	}
}

376 
	$qfi_Ãxt_madvi£
(
QFi
 *
qfi
)

378 
ušt64_t
 
Şdrun
 = 
qfi
->
run
;

379 
»suÉ
 = 
	`qfi_Ãxt
(
qfi
);

380 
ušt64_t
 
Ãwrun
 = 
qfi
->
run
;

382 
	`make_madvi£_ÿÎs
(
qfi
->
qf
, 
Şdrun
, 
Ãwrun
);

384  
»suÉ
;

385 
	}
}

390 
	$qfi_š™Ÿl_madvi£
(
QFi
 *
qfi
)

392 
	`make_madvi£_ÿÎs
(
qfi
->
qf
, 0, qfi->
run
);

394 
	}
}

	@src/hashutil.c

10 
	~"hashut.h
"

23 
ušt64_t
 
	$MurmurHash64A
 ( cÚ¡ * 
key
, 
Ën
, 
£ed
 )

25 cÚ¡ 
ušt64_t
 
m
 = 0xc6a4a7935bd1e995;

26 cÚ¡ 
r
 = 47;

28 
ušt64_t
 
h
 = 
£ed
 ^ (
Ën
 * 
m
);

30 cÚ¡ 
ušt64_t
 * 
d©a
 = (cÚ¡ ušt64_ˆ*)
key
;

31 cÚ¡ 
ušt64_t
 * 
’d
 = 
d©a
 + (
Ën
/8);

33 
d©a
 !ğ
’d
)

35 
ušt64_t
 
k
 = *
d©a
++;

37 
k
 *ğ
m
;

38 
k
 ^ğk >> 
r
;

39 
k
 *ğ
m
;

41 
h
 ^ğ
k
;

42 
h
 *ğ
m
;

45 cÚ¡ * 
d©a2
 = (cÚ¡ *)
d©a
;

47 
Ën
 & 7)

49 7: 
h
 ^ğ(
ušt64_t
)
d©a2
[6] << 48;

50 6: 
h
 ^ğ(
ušt64_t
)
d©a2
[5] << 40;

51 5: 
h
 ^ğ(
ušt64_t
)
d©a2
[4] << 32;

52 4: 
h
 ^ğ(
ušt64_t
)
d©a2
[3] << 24;

53 3: 
h
 ^ğ(
ušt64_t
)
d©a2
[2] << 16;

54 2: 
h
 ^ğ(
ušt64_t
)
d©a2
[1] << 8;

55 1: 
h
 ^ğ(
ušt64_t
)
d©a2
[0];

56 
h
 *ğ
m
;

59 
h
 ^ğh >> 
r
;

60 
h
 *ğ
m
;

61 
h
 ^ğh >> 
r
;

63  
h
;

64 
	}
}

69 
ušt64_t
 
	$MurmurHash64B
 ( cÚ¡ * 
key
, 
Ën
, 
£ed
 )

71 cÚ¡ 
m
 = 0x5bd1e995;

72 cÚ¡ 
r
 = 24;

74 
h1
 = 
£ed
 ^ 
Ën
;

75 
h2
 = 0;

77 cÚ¡ * 
d©a
 = (cÚ¡ *)
key
;

79 
Ën
 >= 8)

81 
k1
 = *
d©a
++;

82 
k1
 *ğ
m
; k1 ^ğk1 >> 
r
; k1 *= m;

83 
h1
 *ğ
m
; h1 ^ğ
k1
;

84 
Ën
 -= 4;

86 
k2
 = *
d©a
++;

87 
k2
 *ğ
m
; k2 ^ğk2 >> 
r
; k2 *= m;

88 
h2
 *ğ
m
; h2 ^ğ
k2
;

89 
Ën
 -= 4;

92 if(
Ën
 >= 4)

94 
k1
 = *
d©a
++;

95 
k1
 *ğ
m
; k1 ^ğk1 >> 
r
; k1 *= m;

96 
h1
 *ğ
m
; h1 ^ğ
k1
;

97 
Ën
 -= 4;

100 
Ën
)

102 3: 
h2
 ^ğ((*)
d©a
)[2] << 16;

103 2: 
h2
 ^ğ((*)
d©a
)[1] << 8;

104 1: 
h2
 ^ğ((*)
d©a
)[0];

105 
h2
 *ğ
m
;

108 
h1
 ^ğ
h2
 >> 18; h1 *ğ
m
;

109 
h2
 ^ğ
h1
 >> 22; h2 *ğ
m
;

110 
h1
 ^ğ
h2
 >> 17; h1 *ğ
m
;

111 
h2
 ^ğ
h1
 >> 19; h2 *ğ
m
;

113 
ušt64_t
 
h
 = 
h1
;

115 
h
 = (h << 32è| 
h2
;

117  
h
;

118 
	}
}

132 
ušt64_t
 
	$hash_64
(
ušt64_t
 
key
, ušt64_ˆ
mask
)

134 
key
 = (~key + (key << 21)è& 
mask
;

135 
key
 = key ^ key >> 24;

136 
key
 = ((key + (key << 3)è+ (key << 8)è& 
mask
;

137 
key
 = key ^ key >> 14;

138 
key
 = ((key + (key << 2)è+ (key << 4)è& 
mask
;

139 
key
 = key ^ key >> 28;

140 
key
 = (key + (key << 31)è& 
mask
;

141  
key
;

142 
	}
}

146 
ušt64_t
 
	$hash_64i
(
ušt64_t
 
key
, ušt64_ˆ
mask
)

148 
ušt64_t
 
tmp
;

151 
tmp
 = (
key
 - (key << 31));

152 
key
 = (key - (
tmp
 << 31)è& 
mask
;

155 
tmp
 = 
key
 ^ key >> 28;

156 
key
 = key ^ 
tmp
 >> 28;

159 
key
 = (key * 14933078535860113213uÎè& 
mask
;

162 
tmp
 = 
key
 ^ key >> 14;

163 
tmp
 = 
key
 ^mp >> 14;

164 
tmp
 = 
key
 ^mp >> 14;

165 
key
 = key ^ 
tmp
 >> 14;

168 
key
 = (key * 15244667743933553977uÎè& 
mask
;

171 
tmp
 = 
key
 ^ key >> 24;

172 
key
 = key ^ 
tmp
 >> 24;

175 
tmp
 = ~
key
;

176 
tmp
 = ~(
key
 - (tmp << 21));

177 
tmp
 = ~(
key
 - (tmp << 21));

178 
key
 = ~(key - (
tmp
 << 21)è& 
mask
;

180  
key
;

181 
	}
}

	@src/partitioned_counter.c

10 
	#_GNU_SOURCE


	)

11 
	~<¡dio.h
>

12 
	~<¡dlib.h
>

13 
	~<uni¡d.h
>

14 
	~<sched.h
>

15 
	~<sys/sysšfo.h
>

16 
	~<lšux/uni¡d.h
>

17 
	~<sys/sysÿÎ.h
>

18 
	~<”ºo.h
>

20 
	~"·¹™iÚed_couÁ”.h
"

22 
	#mš
(
a
,
b
è(×è< (bè? (aè: (b))

	)

24 
	$pc_š™
(
pc_t
 *
pc
, 
št64_t
 *
glob®_couÁ”
, 
ušt32_t
 
num_couÁ”s
,

25 
št32_t
 
th»shŞd
) {

26 
num_ıus
 = ()
	`syscÚf
Ğ
_SC_NPROCESSORS_ONLN
 );

27 ià(
num_ıus
 < 0) {

28 
	`³¼Ü
( "sysconf" );

29  
PC_ERROR
;

31 
pc
->
num_couÁ”s
 =‚um_couÁ” =ğ0 ? 
num_ıus
 : 
	`mš
(num_cpus,

32 
num_couÁ”s
);

34 
pc
->
loÿl_couÁ”s
 = (
lùr_t
 *)
	`ÿÎoc
Õc->
num_couÁ”s
,

35 (*
pc
->
loÿl_couÁ”s
));

36 ià(
pc
->
loÿl_couÁ”s
 =ğ
NULL
) {

37 
	`³¼Ü
("Couldn't‡llocate memory for†ocal counters.");

38  
PC_ERROR
;

42 
pc
->
glob®_couÁ”
 = global_counter;

43 
pc
->
th»shŞd
 =hreshold;

46 
	}
}

48 
	$pc_de¡ruùÜ
(
pc_t
 *
pc
)

50 
	`pc_sync
(
pc
);

51 
lùr_t
 *
lc
 = 
pc
->
loÿl_couÁ”s
;

52 
pc
->
loÿl_couÁ”s
 = 
NULL
;

53 
	`ä“
(
lc
);

54 
	}
}

56 
	$pc_add
(
pc_t
 *
pc
, 
št64_t
 
couÁ
) {

57 
ıuid
 = 
	`sched_g‘ıu
();

58 
ušt32_t
 
couÁ”_id
 = 
ıuid
 % 
pc
->
num_couÁ”s
;

59 
št64_t
 
cur_couÁ
 =

60 
	`__©omic_add_ãtch
(&
pc
->
loÿl_couÁ”s
[
couÁ”_id
].
couÁ”
, 
couÁ
,

61 
__ATOMIC_SEQ_CST
);

62 ià(
cur_couÁ
 > 
pc
->
th»shŞd
 || cur_count < -pc->threshold) {

63 
št64_t
 
Ãw_couÁ
 =

64 
	`__©omic_exchªge_n
(&
pc
->
loÿl_couÁ”s
[
couÁ”_id
].
couÁ”
, 0,

65 
__ATOMIC_SEQ_CST
);

66 
	`__©omic_ãtch_add
(
pc
->
glob®_couÁ”
, 
Ãw_couÁ
, 
__ATOMIC_SEQ_CST
);

68 
	}
}

70 
	$pc_sync
(
pc_t
 *
pc
) {

71 
ušt32_t
 
i
 = 0; i < 
pc
->
num_couÁ”s
; i++) {

72 
št64_t
 
c
 = 
	`__©omic_exchªge_n
(&
pc
->
loÿl_couÁ”s
[
i
].
couÁ”
, 0,

73 
__ATOMIC_SEQ_CST
);

74 
	`__©omic_ãtch_add
(
pc
->
glob®_couÁ”
, 
c
, 
__ATOMIC_SEQ_CST
);

76 
	}
}

	@src/test.c

10 
	~<¡dio.h
>

11 
	~<m©h.h
>

12 
	~<¡dlib.h
>

13 
	~<¡ršg.h
>

14 
	~<š‰y³s.h
>

15 
	~<time.h
>

16 
	~<sys/time.h
>

17 
	~<sys/ty³s.h
>

18 
	~<sys/mmª.h
>

19 
	~<uni¡d.h
>

20 
	~<İ’s¦/¿nd.h
>

22 
	~"šşude/gqf.h
"

23 
	~"šşude/gqf_št.h
"

24 
	~"šşude/gqf_fe.h
"

26 
	$maš
(
¬gc
, **
¬gv
)

28 ià(
¬gc
 < 3) {

29 
	`årštf
(
¡d”r
, "Please specifyhe†og ofhe‚umber of slots‡ndhe‚umber of„emainder bits inhe CQF.\n");

30 
	`ex™
(1);

32 
QF
 
qf
;

33 
ušt64_t
 
qb™s
 = 
	`©oi
(
¬gv
[1]);

34 
ušt64_t
 
rb™s
 = 
	`©oi
(
¬gv
[2]);

35 
ušt64_t
 
nhashb™s
 = 
qb™s
 + 
rb™s
;

36 
ušt64_t
 
n¦Ùs
 = (1ULL << 
qb™s
);

37 
ušt64_t
 
nv®s
 = 95*
n¦Ùs
/100;

38 
ušt64_t
 
key_couÁ
 = 4;

39 
ušt64_t
 *
v®s
;

46 ià(!
	`qf_š™fe
(&
qf
, 
n¦Ùs
, 
nhashb™s
, 0, 
QF_HASH_INVERTIBLE
, 0,

48 
	`årštf
(
¡d”r
, "Can't‡llocate CQF.\n");

49 
	`abÜt
();

52 
	`qf_£t_auto_»size
(&
qf
, 
Œue
);

55 
v®s
 = (
ušt64_t
*)
	`m®loc
(
nv®s
*(vals[0]));

56 
	`RAND_by‹s
((*)
v®s
, (*v®sè* 
nv®s
);

57 
	`¤ªd
(0);

58 
ušt64_t
 
i
 = 0; i < 
nv®s
; i++) {

59 
v®s
[
i
] = (1 * v®s[i]è% 
qf
.
m‘ad©a
->
¿nge
;

65 
ušt64_t
 
i
 = 0; i < 
nv®s
; i++) {

66 
»t
 = 
	`qf_š£¹
(&
qf
, 
v®s
[
i
], 0, 
key_couÁ
, 
QF_NO_LOCK
);

67 ià(
»t
 < 0) {

68 
	`årštf
(
¡d”r
, "çed in£¹iÚ fÜ key: %lx %d.\n", 
v®s
[
i
], 50);

69 ià(
»t
 =ğ
QF_NO_SPACE
)

70 
	`årštf
(
¡d”r
, "CQF is full.\n");

71 ià(
»t
 =ğ
QF_COULDNT_LOCK
)

72 
	`årštf
(
¡d”r
, "TRY_ONCE_LOCK failed.\n");

74 
	`årštf
(
¡d”r
, "Does‚ot„ecognise„eturn value.\n");

75 
	`abÜt
();

80 
ušt64_t
 
i
 = 0; i < 
nv®s
; i++) {

81 
ušt64_t
 
couÁ
 = 
	`qf_couÁ_key_v®ue
(&
qf
, 
v®s
[
i
], 0, 0);

82 ià(
couÁ
 < 
key_couÁ
) {

83 
	`årštf
(
¡d”r
, "çed†ooku°aá” in£¹iÚ fÜ %lx %ld.\n", 
v®s
[
i
],

84 
couÁ
);

85 
	`abÜt
();

90 
ušt64_t
 
i
 = 0; i < 
nv®s
; i++) {

91 
ušt64_t
 
couÁ
 = 
	`qf_couÁ_key_v®ue
(&
qf
, 
v®s
[
i
], 0, 0);

92 ià(
couÁ
 < 
key_couÁ
) {

93 
	`årštf
(
¡d”r
, "çed†ooku°duršg d–‘iÚ fÜ %lx %ld.\n", 
v®s
[
i
],

94 
couÁ
);

95 
	`abÜt
();

97 ià(
couÁ
 > 0) {

99 
	`qf_d–‘e_key_v®ue
(&
qf
, 
v®s
[
i
], 0, 
QF_NO_LOCK
);

101 
ušt64_t
 
út
 = 
	`qf_couÁ_key_v®ue
(&
qf
, 
v®s
[
i
], 0, 0);

102 ià(
út
 > 0) {

103 
	`årštf
(
¡d”r
, "çed†ooku°aá” d–‘iÚ fÜ %lx %ld.\n", 
v®s
[
i
],

104 
út
);

105 
	`abÜt
();

112 
f’ame
[] = "mycqf_serialized.cqf";

113 
	`årštf
(
¡dout
, "Serializinghe CQFo disk.\n");

114 
ušt64_t
 
tÙ®_size
 = 
	`qf_£rŸlize
(&
qf
, 
f’ame
);

115 ià(
tÙ®_size
 < (
qfm‘ad©a
è+ 
qf
.
m‘ad©a
->
tÙ®_size_š_by‹s
) {

116 
	`årštf
(
¡d”r
, "CQF serialization failed.\n");

117 
	`abÜt
();

119 
	`qf_d–‘efe
(&
qf
);

121 
QF
 
fe_qf
;

122 
	`årštf
(
¡dout
, "Readinghe CQF from disk.\n");

123 ià(!
	`qf_de£rŸlize
(&
fe_qf
, 
f’ame
)) {

124 
	`årštf
(
¡d”r
, "Cª'ˆš™ŸlizthCQF from fe: %s.\n", 
f’ame
);

125 
	`abÜt
();

127 
ušt64_t
 
i
 = 0; i < 
nv®s
; i++) {

128 
ušt64_t
 
couÁ
 = 
	`qf_couÁ_key_v®ue
(&
fe_qf
, 
v®s
[
i
], 0, 0);

129 ià(
couÁ
 < 
key_couÁ
) {

130 
	`årštf
(
¡d”r
, "failed†ookup in file based CQF for %lx %ld.\n",

131 
v®s
[
i
], 
couÁ
);

132 
	`abÜt
();

136 
	`årštf
(
¡dout
, "Testing iterator‡nd unique indexes.\n");

138 
QFi
 
qfi
;

139 
	`qf_™”©Ü_äom_pos™iÚ
(&
fe_qf
, &
qfi
, 0);

140 
QF
 
unique_idx
;

141 ià(!
	`qf_m®loc
(&
unique_idx
, 
fe_qf
.
m‘ad©a
->
n¦Ùs
, 
nhashb™s
, 0,

142 
QF_HASH_INVERTIBLE
, 0)) {

143 
	`årštf
(
¡d”r
, "Can't‡llocate set.\n");

144 
	`abÜt
();

147 
št64_t
 
Ï¡_šdex
 = -1;

148 
i
 = 0;

149 
	`qf_™”©Ü_äom_pos™iÚ
(&
fe_qf
, &
qfi
, 0);

150 !
	`qfi_’d
(&
qfi
)) {

151 
ušt64_t
 
key
, 
v®ue
, 
couÁ
;

152 
	`qfi_g‘_key
(&
qfi
, &
key
, &
v®ue
, &
couÁ
);

153 ià(
couÁ
 < 
key_couÁ
) {

154 
	`årštf
(
¡d”r
, "Failed†ookup during iteration for: %lx. Returned count: %ld\n",

155 
key
, 
couÁ
);

156 
	`abÜt
();

158 
št64_t
 
idx
 = 
	`qf_g‘_unique_šdex
(&
fe_qf
, 
key
, 
v®ue
, 0);

159 ià(
idx
 =ğ
QF_DOESNT_EXIST
) {

160 
	`årštf
(
¡d”r
, "Failed†ookup for unique index for: %lx. index: %ld\n",

161 
key
, 
idx
);

162 
	`abÜt
();

164 ià(
idx
 <ğ
Ï¡_šdex
) {

165 
	`årštf
(
¡d”r
, "Unique indexes‚ot strictly increasing.\n");

166 
	`abÜt
();

168 
Ï¡_šdex
 = 
idx
;

169 ià(
	`qf_couÁ_key_v®ue
(&
unique_idx
, 
key
, 0, 0) > 0) {

170 
	`årštf
(
¡d”r
, "Failed unique index for: %lx. index: %ld\n",

171 
key
, 
idx
);

172 
	`abÜt
();

174 
	`qf_š£¹
(&
unique_idx
, 
key
, 0, 1, 
QF_NO_LOCK
);

175 
št64_t
 
Ãwšdex
 = 
	`qf_g‘_unique_šdex
(&
unique_idx
, 
key
, 0, 0);

176 ià(
idx
 < 
Ãwšdex
) {

177 
	`årštf
(
¡d”r
, "Index weirdness: index %dth key %ld was‡t %ld, is‚ow‡t %ld\n",

178 
i
, 
key
, 
idx
, 
Ãwšdex
);

182 
i
++;

183 
	`qfi_Ãxt
(&
qfi
);

187 
	`årštf
(
¡dout
, "Testing„emove/delete_key.\n");

188 
ušt64_t
 
i
 = 0; i < 
nv®s
; i++) {

189 
ušt64_t
 
couÁ
 = 
	`qf_couÁ_key_v®ue
(&
fe_qf
, 
v®s
[
i
], 0, 0);

195 
»t
 = 
	`qf_d–‘e_key_v®ue
(&
fe_qf
, 
v®s
[
i
], 0, 
QF_NO_LOCK
);

196 
couÁ
 = 
	`qf_couÁ_key_v®ue
(&
fe_qf
, 
v®s
[
i
], 0, 0);

197 ià(
couÁ
 > 0) {

198 ià(
»t
 < 0) {

199 
	`årštf
(
¡d”r
, "failed deletion for %lx %ld„et code: %d.\n",

200 
v®s
[
i
], 
couÁ
, 
»t
);

201 
	`abÜt
();

203 
ušt64_t
 
Ãw_couÁ
 = 
	`qf_couÁ_key_v®ue
(&
fe_qf
, 
v®s
[
i
], 0, 0);

204 ià(
Ãw_couÁ
 > 0) {

205 
	`årštf
(
¡d”r
, "delete key failed for %lx %ld‚ew count: %ld.\n",

206 
v®s
[
i
], 
couÁ
, 
Ãw_couÁ
);

207 
	`abÜt
();

212 
	`qf_d–‘efe
(&
fe_qf
);

214 
	`årštf
(
¡dout
, "Validatedhe CQF.\n");

215 
	}
}

	@src/test_partitioned_counter.c

10 
	~<¡dio.h
>

11 
	~<±h»ad.h
>

12 
	~<uni¡d.h
>

13 
	~<¡dlib.h
>

14 
	~<¡ršg.h
>

15 
	~<sched.h
>

16 
	~<lšux/uni¡d.h
>

17 
	~<sys/sysÿÎ.h
>

18 
	~<”ºo.h
>

19 
	~<time.h
>

20 
	~<sys/time.h
>

22 
	~"·¹™iÚed_couÁ”.h
"

24 
	~<¡dlib.h
>

26 
	#INC_TO
 500000

	)

27 
	#DEC_TO
 
INC_BY
/2

	)

28 
	#INC_BY
 1

	)

29 
	#NUM_RUNS
 10

	)

31 
ušt64_t
 
	gTOTAL_COUNT
;

33 
ušt64_t
 
	$tv2m£c
(
timev®
 
tv
)

35  
tv
.
tv_£c
 * 1000 +v.
tv_u£c
 / 1000;

36 
	}
}

38 *
	$th»ad_routše
(*
¬g
) {

39 
pc_t
 *
pc_couÁ”
 = (pc_t*)
¬g
;

47 
ušt64_t
 
i
 = 0; i < 
TOTAL_COUNT
; i++)

48 
	`pc_add
(
pc_couÁ”
, 
INC_BY
);

50  
NULL
;

51 
	}
}

59 
	$maš
 (
¬gc
, *
¬gv
[])

61 
št64_t
 
glob®_couÁ”
 = 0;

62 
pc_t
 
pc_couÁ”
;

63 ià(
¬gc
 < 2) {

64 
	`´štf
("Specifyhe‚umber ofhreads.\n");

67 
´ocs
 = 
	`©oi
(
¬gv
[1]);

68 
TOTAL_COUNT
 = (1ULL << 30è/ 
´ocs
;

70 
timev®
 
¡¬t
, 
¡İ
;

71 
	`pc_š™
(&
pc_couÁ”
, &
glob®_couÁ”
, 8, 100);

73 
±h»ad_t
 *
thrs
 = 
	`m®loc
ĞĞ±h»ad_ˆè* 
´ocs
);

74 ià(
thrs
 =ğ
NULL
)

76 
	`³¼Ü
( "malloc" );

79 
	`´štf
Ğ"S¹šg %dh»ads...\n", 
´ocs
 );

81 
ušt64_t
 
tÙ®_time
;

82 
i
 = 0; i < 
NUM_RUNS
; i++) {

83 
	`g‘timeofday
(&
¡¬t
, 
NULL
);

84 
i
 = 0; i < 
´ocs
; i++) {

85 ià(
	`±h»ad_ü—‹
(&
thrs
[
i
], 
NULL
, 
th»ad_routše
, (*)(&
pc_couÁ”
)))

87 
	`³¼Ü
( "pthread_create" );

88 
´ocs
 = 
i
;

92 
i
 = 0; i < 
´ocs
; i++)

93 
	`±h»ad_još
Ğ
thrs
[
i
], 
NULL
 );

94 
	`pc_sync
(&
pc_couÁ”
);

95 
	`g‘timeofday
(&
¡İ
, 
NULL
);

96 
tÙ®_time
 = 
	`tv2m£c
(
¡İ
è-v2m£c(
¡¬t
);

97 
	`mem£t
(
thrs
, 0, Ğ
±h»ad_t
 ) * 
´ocs
);

99 
	`ä“
(
thrs
);

101 
	`´štf
("Av”agtimfÜ %d„uns: %ld ms\n", 
NUM_RUNS
, 
tÙ®_time
/NUM_RUNS);

103 
	`´štf
("After doing‡llhe math, global_int value is: %ld\n",

104 
glob®_couÁ”
);

106 
št64_t
 
exp_couÁ
 = 
TOTAL_COUNT
 * 
INC_BY
 * 
NUM_RUNS
 * 
´ocs
;

107 
	`´štf
("Ex³ùed v®uis: %ld\n", 
exp_couÁ
);

108 ià(
glob®_couÁ”
 !ğ
exp_couÁ
)

109 
	`´štf
("Counting failed!\n");

111 
	`´štf
("Counting…assed!\n");

112  
EXIT_SUCCESS
;

113 
	}
}

	@src/test_threadsafe.c

10 
	~<¡dio.h
>

11 
	~<¡dlib.h
>

12 
	~<š‰y³s.h
>

13 
	~<time.h
>

14 
	~<sys/time.h
>

15 
	~<sys/ty³s.h
>

16 
	~<uni¡d.h
>

17 
	~<±h»ad.h
>

18 
	~<İ’s¦/¿nd.h
>

20 
	~"šşude/gqf.h
"

21 
	~"šşude/gqf_št.h
"

22 
	~"šşude/gqf_fe.h
"

24 
	sš£¹_¬gs
 {

25 
QF
 *
	mcf
;

26 
ušt64_t
 *
	mv®s
;

27 
	mäeq
;

28 
ušt64_t
 
	m¡¬t
;

29 
ušt64_t
 
	m’d
;

30 } 
	tš£¹_¬gs
;

32 *
	$š£¹_bm
(*
¬g
)

34 
š£¹_¬gs
 *
a
 = (š£¹_¬g *)
¬g
;

35 
ušt32_t
 
i
 = 
a
->
¡¬t
; i <ğa->
’d
; i++) {

36 
»t
 = 
	`qf_š£¹
(
a
->
cf
,‡->
v®s
[
i
], 0,‡->
äeq
, 
QF_WAIT_FOR_LOCK
);

37 ià(
»t
 < 0) {

38 
	`årštf
(
¡d”r
, "çed in£¹iÚ fÜ key: %lx %d.\n", 
a
->
v®s
[
i
],

39 
a
->
äeq
);

40 ià(
»t
 == -1)

41 
	`årštf
(
¡d”r
, "CQF is full.\n");

42 ià(
»t
 == -2)

43 
	`årštf
(
¡d”r
, "TRY_ONCE_LOCK failed.\n");

44 ià(
»t
 == -3)

45 
	`årštf
(
¡d”r
, "Runtime†ock does‚ot satisfyhe initime†ock.\n");

47 
	`årštf
(
¡d”r
, "Does‚ot„ecognise„eturn value.\n");

48 
	`abÜt
();

51  
NULL
;

52 
	}
}

54 
	$muÉi_th»aded_š£¹iÚ
(
š£¹_¬gs
 
¬gs
[], 
tút
)

56 
±h»ad_t
 
th»ads
[
tút
];

58 
i
 = 0; i < 
tút
; i++) {

59 
	`årštf
(
¡dout
, "Th»ad %d bound %ld %ld\n", 
i
, 
¬gs
[i].
¡¬t
,‡rgs[i].
’d
);

60 ià(
	`±h»ad_ü—‹
(&
th»ads
[
i
], 
NULL
, &
š£¹_bm
, &
¬gs
[i])) {

61 
	`årštf
(
¡d”r
, "Error creatinghread\n");

62 
	`ex™
(0);

66 
i
 = 0; i < 
tút
; i++) {

67 ià(
	`±h»ad_još
(
th»ads
[
i
], 
NULL
)) {

68 
	`årštf
(
¡d”r
, "Error joininghread\n");

69 
	`ex™
(0);

72 
	}
}

74 
	$maš
(
¬gc
, **
¬gv
)

76 ià(
¬gc
 < 4) {

77 
	`årštf
(
¡d”r
, "Please specifyhree‡rguments: \n \
1.†og ofhe‚umber of slots inhe CQF.\n \
2. frequency count of keys.\n \
3.‚umber ofhreads.\n");

81 
	`ex™
(1);

83 
QF
 
cä
;

84 
ušt64_t
 
qb™s
 = 
	`©oi
(
¬gv
[1]);

85 
ušt64_t
 
äeq
 = 
	`©oi
(
¬gv
[2]);

86 
ušt32_t
 
tút
 = 
	`©oi
(
¬gv
[3]);

87 
ušt64_t
 
nhashb™s
 = 
qb™s
 + 8;

88 
ušt64_t
 
n¦Ùs
 = (1ULL << 
qb™s
);

89 
ušt64_t
 
nv®s
 = 750*
n¦Ùs
/1000;

90 
nv®s
 =‚v®s/
äeq
;

92 
ušt64_t
 *
v®s
;

95 ià(!
	`qf_m®loc
(&
cä
, 
n¦Ùs
, 
nhashb™s
, 0, 
QF_HASH_INVERTIBLE
, 0)) {

96 
	`årštf
(
¡d”r
, "Can't‡llocate CQF.\n");

97 
	`abÜt
();

101 
v®s
 = (
ušt64_t
*)
	`ÿÎoc
(
nv®s
, (vals[0]));

102 
	`RAND_by‹s
((*)
v®s
, (*v®sè* 
nv®s
);

103 
ušt32_t
 
i
 = 0; i < 
nv®s
; i++) {

104 
v®s
[
i
] = (1 * v®s[i]è% 
cä
.
m‘ad©a
->
¿nge
;

107 
š£¹_¬gs
 *
¬gs
 = (š£¹_¬gs*)
	`m®loc
(
tút
 * (insert_args));

108 
ušt32_t
 
i
 = 0; i < 
tút
; i++) {

109 
¬gs
[
i
].
cf
 = &
cä
;

110 
¬gs
[
i
].
v®s
 = vals;

111 
¬gs
[
i
].
äeq
 = freq;

112 
¬gs
[
i
].
¡¬t
 = (
nv®s
/
tút
) * i;

113 
¬gs
[
i
].
’d
 = (
nv®s
/
tút
) * (i + 1) - 1;

115 
	`årštf
(
¡dout
, "TÙ®‚umb” oà™ems: %ld\n", 
¬gs
[
tút
-1].
’d
);

117 
	`muÉi_th»aded_š£¹iÚ
(
¬gs
, 
tút
);

119 
	`årštf
(
¡dout
, "In£¹ed‡Î i‹ms: %ld\n", 
¬gs
[
tút
-1].
’d
);

121 
ušt64_t
 
i
 = 0; i < 
¬gs
[
tút
-1].
’d
; i++) {

122 
ušt64_t
 
couÁ
 = 
	`qf_couÁ_key_v®ue
(&
cä
, 
v®s
[
i
], 0, 0);

123 ià(
couÁ
 < 
äeq
) {

124 
	`årštf
(
¡d”r
, "çed†ooku°aá” in£¹iÚ fÜ %lx %ld.\n", 
v®s
[
i
],

125 
couÁ
);

126 
	`abÜt
();

130 
QFi
 
cfœ
;

132 
	`qf_™”©Ü_äom_pos™iÚ
(&
cä
, &
cfœ
, 0);

134 
ušt64_t
 
key
, 
v®ue
, 
couÁ
;

135 
	`qfi_g‘_key
(&
cfœ
, &
key
, &
v®ue
, &
couÁ
);

136 
	`qfi_Ãxt
(&
cfœ
);

137 ià(
	`qf_couÁ_key_v®ue
(&
cä
, 
key
, 0, 0è< 
äeq
) {

138 
	`årštf
(
¡d”r
, "Failed†ookup during iteration for: %lx. Returned count: %ld\n",

139 
key
, 
couÁ
);

140 
	`abÜt
();

142 } !
	`qfi_’d
(&
cfœ
));

144 
	`årštf
(
¡dout
, "Total‚um of distinct items inhe CQF %ld\n",

145 
cä
.
m‘ad©a
->
ndi¡šù_–ts
);

146 
	`årštf
(
¡dout
, "V”if›d‡Î i‹ms: %ld\n", 
¬gs
[
tút
-1].
’d
);

149 
	}
}

	@src/zipf.c

5 
	~"šşude/zf.h
"

6 
	~<m©h.h
>

7 
	~<as£¹.h
>

8 
	~<¡dlib.h
>

9 
	~<¡dio.h
>

11 #iâdeà 
USE_MYRANDOM


12 
	#RFUN
 
¿ndom


	)

13 
	#RSEED
 
¤ªdom


	)

15 
	#RFUN
 
my¿ndom


	)

16 
	#RSEED
 
my¤ªdom


	)

18 
	gm_z
 = 1;

19 
	gm_w
 = 1;

20 
	$my¤ªdom
 (
£ed
) {

21 
m_z
 = 
£ed
;

22 
m_w
 = (
£ed
<<16) + (seed >> 16);

23 
	}
}

25 
	$my¿ndom
()

27 
m_z
 = 36969 * (m_z & 65535) + (m_z >> 16);

28 
m_w
 = 18000 * (m_w & 65535) + (m_w >> 16);

29  ((
m_z
 << 16è+ 
m_w
) % 0x7FFFFFFF;

30 
	}
}

33 
	sz·œ
 {

34 
	mnum
;

35 
	mlow
;

36 
	mcumuÏtive
;

39 ’um { 
	mNPAIRS
 = 1000000 };

41 
	szfŸn
 {

42 
	ms
;

43 
	mN
;

44 
	mH_Ns
;

45 (*
	m¿ndomfun
)();

46 
z·œ
 
	m·œs
[
NPAIRS
];

49 
	$z´št
 (
ZIPFIAN
 
z
) {

50 
i
 = 0;

51 
	`´štf
("s=%f, N=%ld, H_sN=%f\n", 
z
->
s
, z->
N
, z->
H_Ns
);

52 
i
=0; i<
NPAIRS
; i++) {

53 
diff
 = ((
i
+1>=
NPAIRS
è? 
z
->
H_Ns
 : z->
·œs
[i+1].
cumuÏtive
) - z->pairs[i].cumulative;

54 
	`´štf
("%2ld %2ld %à(d–=%f)\n", 
z
->
·œs
[
i
].
num
, z->·œs[i].
low
, z->·œs[i].
cumuÏtive
, 
diff
);

56 
	}
}

58 
ZIPFIAN
 
	$ü—‹_zfŸn
 (
s
, 
N
, (*
¿ndomfun
)()) {

59 
	`as£¹
(
s
 > 0);

60 
	`as£¹
(0 < 
N
);

61 
zfŸn
 *
z
 = (zfŸÀ*)
	`m®loc
((*z));

62 
	`as£¹
(
z
);

63 
z
->
s
 = s;

64 
z
->
N
 = N;

65 
z
->
¿ndomfun
 =„andomfun;

68 
H_Ns
 = 0;

69 
i
 = 0;

70 
i
=0; i<
N
; i++) {

71 
H_Ns
 +ğ
	`pow
(
i
+1, -
s
);

75 
cumuÏtive
 = 0;

76 
i
=0; i<
NPAIRS
/2; i++) {

77 
z
->
·œs
[
i
] = (
z·œ
){.
cumuÏtive
 = cumulative,

78 .
low
 = 
i
,

79 .
num
 = 1};

80 
cumuÏtive
 +ğ
	`pow
(
i
+1, -
s
);

85 
Ï¡_n
 = 
NPAIRS
/2;

86 
Ãxt_n
 = 
Ï¡_n
;

88 
i
=
NPAIRS
/2; i<NPAIRS; i++) {

89 
»maššg_´obab™y
 = 
H_Ns
 - 
cumuÏtive
;

90 
Ãxt_rg‘
 = 
cumuÏtive
 + 
»maššg_´obab™y
/(
NPAIRS
-
i
);

91 
Ãxt_cumuÏtive
 = 
cumuÏtive
;

92 
Ãxt_n
 < 
N
 && 
Ãxt_cumuÏtive
 < 
Ãxt_rg‘
) {

93 
Ãxt_cumuÏtive
 +ğ
	`pow
(
Ãxt_n
+1, -
s
);

94 
Ãxt_n
++;

96 
z
->
·œs
[
i
] = (
z·œ
){.
cumuÏtive
 = cumulative,

97 .
low
 = 
Ï¡_n
,

98 .
num
 = 
Ãxt_n
 - 
Ï¡_n
};

99 
Ï¡_n
 = 
Ãxt_n
;

100 
cumuÏtive
 = 
Ãxt_cumuÏtive
;

102 
z
->
H_Ns
 = H_Ns;

104 ià(0è
	`z´št
(
z
);

106  
z
;

107 
	}
}

109 
	$z_£¬ch
 (
ZIPFIAN
 
s
, 
C
, 
low
, 
pcouÁ
)

113 
	`as£¹
(
pcouÁ
>0);

114 ià(
pcouÁ
==1) {

115 
z·œ
 cÚ¡ *
p
 = &
s
->
·œs
[
low
];

116 
	`as£¹
(
p
->
cumuÏtive
 <ğ
C
);

117  
p
->
low
 + 
s
->
	`¿ndomfun
()%p->
num
;

119 
mid
 = 
low
 + 
pcouÁ
/2;

120 
z·œ
 cÚ¡ *
p
 = &
s
->
·œs
[
mid
];

121 ià(
p
->
cumuÏtive
 > 
C
) {

122  
	`z_£¬ch
(
s
, 
C
, 
low
, 
pcouÁ
/2);

124  
	`z_£¬ch
(
s
, 
C
, 
low
+
pcouÁ
/2,…count-pcount/2);

127 
	}
}

129 
	$zfŸn_g’
 (
ZIPFIAN
 
z
) {

131 cÚ¡ 
¿nd_lim™
 = (()
RAND_MAX
)+1;

132 cÚ¡ 
Úe_ov”
 = 1/()
¿nd_lim™
;

133 cÚ¡ 
sÿË_çùÜ
 = 
Úe_ov”
 * one_over;

134 
v
 = ()(
z
->
	`¿ndomfun
()è* 
¿nd_lim™
 + z->randomfun();

135 
sÿËd
 = 
v
 * 
z
->
H_Ns
 * 
sÿË_çùÜ
;

136  
	`z_£¬ch
(
z
, 
sÿËd
, 0, 
NPAIRS
);

137 
	}
}

139 
	$de¡roy_zfŸn
 (
ZIPFIAN
 
z
) {

140 
	`ä“
((
zfŸn
 *)
z
);

141 
	}
}

143 
	$g’”©e_¿ndom_keys
 (
ušt64_t
 *
–ems
, 
N
, 
g’couÁ
, 
s
) {

144 
i
;

145 
ušt32_t
 *
couÁs
;

147 
	`´štf
("Generating %ldƒlements in universe of %ld items with characteristicƒxponent %f\n",

148 
g’couÁ
, 
N
, 
s
);

150 
ZIPFIAN
 
z
 = 
	`ü—‹_zfŸn
(
s
, 
N
, 
RFUN
);

151 
couÁs
 = (
ušt32_t
*)
	`ÿÎoc
(
N
, (counts));

155 
i
=0; i<
g’couÁ
; i++) {

156 
g
 = 
	`zfŸn_g’
(
z
);

157 
	`as£¹
(0<=
g
 && g<
N
);

158 
couÁs
[
g
]++;

159 
–ems
[
i
] = 
g
;

165 
i
=0; i<
N
; i++) {

166 
	`´štf
("%4.1à(%4.1f)\n", 
couÁs
[0]/()couÁs[
i
],

167 
i
/(
couÁs
[0]/()counts[i]));

170 
	`´štf
("\n");

172 
	`de¡roy_zfŸn
(
z
);

173 
	}
}

	@
1
.
0
16
287
include/gqf.h
include/gqf_file.h
include/gqf_int.h
include/gqf_wrapper.h
include/hashutil.h
include/partitioned_counter.h
include/zipf.h
src/bm.c
src/gqf.c
src/gqf_file.c
src/hashutil.c
src/partitioned_counter.c
src/test.c
src/test_partitioned_counter.c
src/test_threadsafe.c
src/zipf.c
